<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Authentication and authorization</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Authentication and authorization</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="overview-of-authentication-authorization">Overview of authentication and authorization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="openshift-auth-common-terms_overview-of-authentication-authorization">Glossary of common terms for OpenShift Container Platform authentication and authorization</h3>
<div class="paragraph">
<p>This glossary defines common terms that are used in OpenShift Container Platform authentication and authorization.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">authentication</dt>
<dd>
<p>An authentication determines access to an OpenShift Container Platform cluster and ensures only authenticated users access the OpenShift Container Platform cluster.</p>
</dd>
<dt class="hdlist1">authorization</dt>
<dd>
<p>Authorization determines whether the identified user has permissions to perform the requested action.</p>
</dd>
<dt class="hdlist1">bearer token</dt>
<dd>
<p>Bearer token is used to authenticate to API with the header <code>Authorization: Bearer &lt;token&gt;</code>.</p>
</dd>
<dt class="hdlist1">Cloud Credential Operator</dt>
<dd>
<p>The Cloud Credential Operator (CCO) manages cloud provider credentials as custom resource definitions (CRDs).</p>
</dd>
<dt class="hdlist1">config map</dt>
<dd>
<p>A config map provides a way to inject configuration data into the pods. You can reference the data stored in a config map in a volume of type <code>ConfigMap</code>. Applications running in a pod can use this data.</p>
</dd>
<dt class="hdlist1">containers</dt>
<dd>
<p>Lightweight and executable images that consist software and all its dependencies. Because containers virtualize the operating system, you can run containers in a data center, public or private cloud, or your local host.</p>
</dd>
<dt class="hdlist1">Custom Resource (CR)</dt>
<dd>
<p>A CR is an extension of the Kubernetes API.</p>
</dd>
<dt class="hdlist1">group</dt>
<dd>
<p>A group is a set of users. A group is useful for granting permissions to multiple users one time.</p>
</dd>
<dt class="hdlist1">HTPasswd</dt>
<dd>
<p>HTPasswd updates the files that store usernames and password for authentication of HTTP users.</p>
</dd>
<dt class="hdlist1">Keystone</dt>
<dd>
<p>Keystone is an Red Hat OpenStack Platform (RHOSP) project that provides identity, token, catalog, and policy services.</p>
</dd>
<dt class="hdlist1">Lightweight directory access protocol (LDAP)</dt>
<dd>
<p>LDAP is a protocol that queries user information.</p>
</dd>
<dt class="hdlist1">manual mode</dt>
<dd>
<p>In manual mode, a user manages cloud credentials instead of the Cloud Credential Operator (CCO).</p>
</dd>
<dt class="hdlist1">mint mode</dt>
<dd>
<p>Mint mode is the default and recommended best practice setting for the Cloud Credential Operator (CCO) to use on the platforms for which it is supported. In this mode, the CCO uses the provided administrator-level cloud credential to create new credentials for components in the cluster with only the specific permissions that are required.</p>
</dd>
<dt class="hdlist1">namespace</dt>
<dd>
<p>A namespace isolates specific system resources that are visible to all processes. Inside a namespace, only processes that are members of that namespace can see those resources.</p>
</dd>
<dt class="hdlist1">node</dt>
<dd>
<p>A node is a worker machine in the OpenShift Container Platform cluster. A node is either a virtual machine (VM) or a physical machine.</p>
</dd>
<dt class="hdlist1">OAuth client</dt>
<dd>
<p>OAuth client is used to get a bearer token.</p>
</dd>
<dt class="hdlist1">OAuth server</dt>
<dd>
<p>The OpenShift Container Platform control plane includes a built-in OAuth server that determines the user’s identity from the configured identity provider and creates an access token.</p>
</dd>
<dt class="hdlist1">OpenID Connect</dt>
<dd>
<p>The OpenID Connect is a protocol to authenticate the users to use single sign-on (SSO) to access sites that use OpenID Providers.</p>
</dd>
<dt class="hdlist1">passthrough mode</dt>
<dd>
<p>In passthrough mode, the Cloud Credential Operator (CCO) passes the provided cloud credential to the components that request cloud credentials.</p>
</dd>
<dt class="hdlist1">pod</dt>
<dd>
<p>A pod is the smallest logical unit in Kubernetes. A pod is comprised of one or more containers to run in a worker node.</p>
</dd>
<dt class="hdlist1">regular users</dt>
<dd>
<p>Users that are created automatically in the cluster upon first login or via the API.</p>
</dd>
<dt class="hdlist1">request header</dt>
<dd>
<p>A request header is an HTTP header that is used to provide information about HTTP request context, so that the server can track the response of the request.</p>
</dd>
<dt class="hdlist1">role-based access control (RBAC)</dt>
<dd>
<p>A key security control to ensure that cluster users and workloads have access to only the resources required to execute their roles.</p>
</dd>
<dt class="hdlist1">service accounts</dt>
<dd>
<p>Service accounts are used by the cluster components or applications.</p>
</dd>
<dt class="hdlist1">system users</dt>
<dd>
<p>Users that are created automatically when the cluster is installed.</p>
</dd>
<dt class="hdlist1">users</dt>
<dd>
<p>Users is an entity that can make requests to API.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="authentication-overview">About authentication in OpenShift Container Platform</h3>
<div class="paragraph">
<p>To control access to an OpenShift Container Platform cluster, a cluster administrator can configure <a href="#understanding-authentication">user authentication</a> and ensure only approved users access the cluster.</p>
</div>
<div class="paragraph">
<p>To interact with an OpenShift Container Platform cluster, users must first authenticate to the OpenShift Container Platform API in some way. You can authenticate by providing an <a href="#rbac-api-authentication_understanding-authentication">OAuth access token or an X.509 client certificate</a> in your requests to the OpenShift Container Platform API.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not present a valid access token or certificate, your request is unauthenticated and you receive an HTTP 401 error.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An administrator can configure authentication through the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuring an identity provider: You can define any <a href="#supported-identity-providers">supported identity provider in OpenShift Container Platform</a> and add it to your cluster.</p>
</li>
<li>
<p><a href="#configuring-internal-oauth">Configuring the internal OAuth server</a>: The OpenShift Container Platform control plane includes a built-in OAuth server that determines the user’s identity from the configured identity provider and creates an access token. You can configure the token duration and inactivity timeout, and customize the internal OAuth server URL.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Users can <a href="#managing-oauth-access-tokens">view and manage OAuth tokens owned by them</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Registering an OAuth client: OpenShift Container Platform includes several <a href="#oauth-default-clients_configuring-oauth-clients">default OAuth clients</a>. You can <a href="#oauth-register-additional-client_configuring-oauth-clients">register and configure additional OAuth clients</a>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>When users send a request for an OAuth token, they must specify either a default or custom OAuth client that receives and uses the token.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Managing cloud provider credentials using the <a href="#about-cloud-credential-operator">Cloud Credentials Operator</a>: Cluster components use cloud provider credentials to get permissions required to perform cluster-related tasks.</p>
</li>
<li>
<p>Impersonating a system admin user: You can grant cluster administrator permissions to a user by <a href="#impersonating-system-admin">impersonating a system admin user</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="authorization-overview">About authorization in OpenShift Container Platform</h3>
<div class="paragraph">
<p>Authorization involves determining whether the identified user has permissions to perform the requested action.</p>
</div>
<div class="paragraph">
<p>Administrators can define permissions and assign them to users using the <a href="#authorization-overview_using-rbac">RBAC objects, such as rules, roles, and bindings</a>. To understand how authorization works in OpenShift Container Platform, see <a href="#evaluating-authorization_using-rbac">Evaluating authorization</a>.</p>
</div>
<div class="paragraph">
<p>You can also control access to an OpenShift Container Platform cluster through <a href="#rbac-projects-namespaces_using-rbac">projects and namespaces</a>.</p>
</div>
<div class="paragraph">
<p>Along with controlling user access to a cluster, you can also control the actions a pod can perform and the resources it can access using <a href="#managing-pod-security-policies">security context constraints (SCCs)</a>.</p>
</div>
<div class="paragraph">
<p>You can manage authorization for OpenShift Container Platform through the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Viewing <a href="#viewing-local-roles_using-rbac">local</a> and <a href="#viewing-cluster-roles_using-rbac">cluster</a> roles and bindings.</p>
</li>
<li>
<p>Creating a <a href="#creating-local-role_using-rbac">local role</a> and assigning it to a user or group.</p>
</li>
<li>
<p>Creating a cluster role and assigning it to a user or group: OpenShift Container Platform includes a set of <a href="#default-roles_using-rbac">default cluster roles</a>. You can create additional <a href="#creating-cluster-role_using-rbac">cluster roles</a> and <a href="#adding-roles_using-rbac">add them to a user or group</a>.</p>
</li>
<li>
<p>Creating a cluster-admin user: By default, your cluster has only one cluster administrator called <code>kubeadmin</code>. You can <a href="#creating-cluster-admin_using-rbac">create another cluster administrator</a>. Before creating a cluster administrator, ensure that you have configured an identity provider.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>After creating the cluster admin user, <a href="#removing-kubeadmin_removing-kubeadmin">delete the existing kubeadmin user</a> to improve cluster security.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Creating service accounts: <a href="#service-accounts-overview_understanding-service-accounts">Service accounts</a> provide a flexible way to control API access without sharing a regular user’s credentials. A user can <a href="#service-accounts-managing_understanding-service-accounts">create and use a service account in applications</a> and also as <a href="#using-service-accounts-as-oauth-client">an OAuth client</a>.</p>
</li>
<li>
<p><a href="#tokens-scoping">Scoping tokens</a>: A scoped token is a token that identifies as a specific user who can perform only specific operations. You can create scoped tokens to delegate some of your permissions to another user or a service account.</p>
</li>
<li>
<p>Syncing LDAP groups: You can manage user groups in one place by <a href="#ldap-syncing">syncing the groups stored in an LDAP server</a> with the OpenShift Container Platform user groups.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-authentication">Understanding authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For users to interact with OpenShift Container Platform, they must first authenticate
to the cluster. The authentication layer identifies the user associated with requests to the
OpenShift Container Platform API. The authorization layer then uses information about the
requesting user to determine if the request is allowed.</p>
</div>
<div class="paragraph">
<p>As an administrator, you can configure authentication for OpenShift Container Platform.</p>
</div>
<div class="sect2">
<h3 id="rbac-users_understanding-authentication">Users</h3>
<div class="paragraph">
<p>A <em>user</em> in OpenShift Container Platform is an entity that can make requests to the
OpenShift Container Platform API. An OpenShift Container Platform <code>User</code> object represents an actor which
can be granted permissions in the system by adding roles to them or to their
groups. Typically, this represents the account of a developer or
administrator that is interacting with OpenShift Container Platform.</p>
</div>
<div class="paragraph">
<p>Several types of users can exist:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">User type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regular users</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the way most interactive OpenShift Container Platform users are
represented. Regular users are created automatically in the system upon
first login or can be created via the API. Regular users are represented
with the <code>User</code> object. Examples: <code>joe</code> <code>alice</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>System users</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Many of these are created automatically when the infrastructure
 is defined, mainly for the purpose of enabling the infrastructure to
 interact with the API securely. They include a cluster administrator
 (with access to everything), a per-node user, users for use by routers
 and registries, and various others. Finally, there is an <code>anonymous</code>
 system user that is used by default for unauthenticated requests. Examples:
<code>system:admin</code> <code>system:openshift-registry</code> <code>system:node:node1.example.com</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Service accounts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are special system users associated with projects; some are created automatically when
the project is first created, while project administrators can create more
for the purpose of defining access to the contents of each project.
Service accounts are represented with the <code>ServiceAccount</code> object. Examples:
<code>system:serviceaccount:default:deployer</code> <code>system:serviceaccount:foo:builder</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each user must authenticate in
some way to access OpenShift Container Platform. API requests with no authentication
or invalid authentication are authenticated as requests by the <code>anonymous</code>
system user. After authentication, policy determines what the user is
authorized to do.</p>
</div>
</div>
<div class="sect2">
<h3 id="rbac-groups_understanding-authentication">Groups</h3>
<div class="paragraph">
<p>A user can be assigned to one or more <em>groups</em>, each of which represent a
certain set of users. Groups are useful when managing authorization policies
to grant permissions to multiple users at once, for example allowing
access to objects within a project, versus granting
them to users individually.</p>
</div>
<div class="paragraph">
<p>In addition to explicitly defined groups, there are also
system groups, or <em>virtual groups</em>, that are automatically provisioned by
the cluster.</p>
</div>
<div class="paragraph">
<p>The following default virtual groups are most important:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 71.4286%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Virtual group</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>system:authenticated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically associated with all authenticated users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>system:authenticated:oauth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically associated with all users authenticated with an OAuth access token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>system:unauthenticated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically associated with all unauthenticated users.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="rbac-api-authentication_understanding-authentication">API authentication</h3>
<div class="paragraph">
<p>Requests to the OpenShift Container Platform API are authenticated using the following
methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OAuth access tokens</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Obtained from the OpenShift Container Platform OAuth server using the
<code><em>&lt;namespace_route&gt;</em>/oauth/authorize</code> and <code><em>&lt;namespace_route&gt;</em>/oauth/token</code>
endpoints.</p>
</li>
<li>
<p>Sent as an <code>Authorization: Bearer&#8230;&#8203;</code> header.</p>
</li>
<li>
<p>Sent as a websocket subprotocol header in the form
<code>base64url.bearer.authorization.k8s.io.&lt;base64url-encoded-token&gt;</code> for websocket
requests.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">X.509 client certificates</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Requires an HTTPS connection to the API server.</p>
</li>
<li>
<p>Verified by the API server against a trusted certificate authority bundle.</p>
</li>
<li>
<p>The API server creates and distributes certificates to controllers to authenticate themselves.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Any request with an invalid access token or an invalid certificate is rejected
by the authentication layer with a <code>401</code> error.</p>
</div>
<div class="paragraph">
<p>If no access token or certificate is presented, the authentication layer assigns
the <code>system:anonymous</code> virtual user and the <code>system:unauthenticated</code> virtual
group to the request. This allows the authorization layer to determine which
requests, if any, an anonymous user is allowed to make.</p>
</div>
<div class="sect3">
<h4 id="oauth-server-overview_understanding-authentication">OpenShift Container Platform OAuth server</h4>
<div class="paragraph">
<p>The OpenShift Container Platform master includes a built-in OAuth server. Users obtain OAuth
access tokens to authenticate themselves to the API.</p>
</div>
<div class="paragraph">
<p>When a person requests a new OAuth token, the OAuth server uses the configured
identity provider
to determine the identity of the person making the request.</p>
</div>
<div class="paragraph">
<p>It then determines what user that identity maps to, creates an access token for
that user, and returns the token for use.</p>
</div>
<div class="sect4">
<h5 id="oauth-token-requests_understanding-authentication">OAuth token requests</h5>
<div class="paragraph">
<p>Every request for an OAuth token must specify the OAuth client that will
receive and use the token. The following OAuth clients are automatically
created when starting the OpenShift Container Platform API:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">OAuth client</th>
<th class="tableblock halign-left valign-top">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openshift-browser-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests tokens at <code>&lt;namespace_route&gt;/oauth/token/request</code> with a user-agent that can handle interactive logins. <sup>[1]</sup></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openshift-challenging-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests tokens with a user-agent that can handle <code>WWW-Authenticate</code> challenges.</p></td>
</tr>
</tbody>
</table>
<div class="openblock small">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>&lt;namespace_route&gt;</code> refers to the namespace route. This is found by
running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get route oauth-openshift -n openshift-authentication -o json | jq .spec.host</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>All requests for OAuth tokens involve a request to
<code>&lt;namespace_route&gt;/oauth/authorize</code>. Most authentication integrations place an
authenticating proxy in front of this endpoint, or configure
OpenShift Container Platform to validate credentials against a backing identity provider.
Requests to <code>&lt;namespace_route&gt;/oauth/authorize</code> can come from user-agents that
cannot display interactive login pages, such as the CLI. Therefore,
OpenShift Container Platform supports authenticating using a <code>WWW-Authenticate</code>
challenge in addition to interactive login flows.</p>
</div>
<div class="paragraph">
<p>If an authenticating proxy is placed in front of the
<code>&lt;namespace_route&gt;/oauth/authorize</code> endpoint, it sends unauthenticated,
non-browser user-agents <code>WWW-Authenticate</code> challenges rather than
displaying an interactive login page or redirecting to an interactive
login flow.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>To prevent cross-site request forgery (CSRF) attacks against browser
clients,  only send Basic authentication challenges with if a
<code>X-CSRF-Token</code> header is on the request. Clients that expect
to receive Basic <code>WWW-Authenticate</code> challenges must set this header to a
non-empty value.</p>
</div>
<div class="paragraph">
<p>If the authenticating proxy cannot support <code>WWW-Authenticate</code> challenges,
or if OpenShift Container Platform is configured to use an identity provider that does
not support WWW-Authenticate challenges, you must use a browser to manually
obtain a token from
<code>&lt;namespace_route&gt;/oauth/token/request</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="authentication-api-impersonation_understanding-authentication">API impersonation</h5>
<div class="paragraph">
<p>You can configure a request to the OpenShift Container Platform API to act as though it originated from another user. For more information, see <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation">User impersonation</a> in the Kubernetes documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="authentication-prometheus-system-metrics_understanding-authentication">Authentication metrics for Prometheus</h5>
<div class="paragraph">
<p>OpenShift Container Platform captures the following Prometheus system metrics during authentication attempts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>openshift_auth_basic_password_count</code> counts the number of <code>oc login</code> user name and password attempts.</p>
</li>
<li>
<p><code>openshift_auth_basic_password_count_result</code> counts the number of <code>oc login</code> user name and password attempts by result, <code>success</code> or <code>error</code>.</p>
</li>
<li>
<p><code>openshift_auth_form_password_count</code> counts the number of web console login attempts.</p>
</li>
<li>
<p><code>openshift_auth_form_password_count_result</code> counts the number of web console login attempts by result, <code>success</code> or <code>error</code>.</p>
</li>
<li>
<p><code>openshift_auth_password_total</code> counts the total number of <code>oc login</code> and web console login attempts.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-internal-oauth">Configuring the internal OAuth server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="oauth-server-overview_configuring-internal-oauth">OpenShift Container Platform OAuth server</h3>
<div class="paragraph">
<p>The OpenShift Container Platform master includes a built-in OAuth server. Users obtain OAuth
access tokens to authenticate themselves to the API.</p>
</div>
<div class="paragraph">
<p>When a person requests a new OAuth token, the OAuth server uses the configured
identity provider
to determine the identity of the person making the request.</p>
</div>
<div class="paragraph">
<p>It then determines what user that identity maps to, creates an access token for
that user, and returns the token for use.</p>
</div>
</div>
<div class="sect2">
<h3 id="oauth-token-request-flows_configuring-internal-oauth">OAuth token request flows and responses</h3>
<div class="paragraph">
<p>The OAuth server supports standard
<a href="https://tools.ietf.org/html/rfc6749#section-4.1">authorization code grant</a>
and the <a href="https://tools.ietf.org/html/rfc6749#section-4.2">implicit grant</a>
OAuth authorization flows.</p>
</div>
<div class="paragraph">
<p>When requesting an OAuth token using the implicit grant flow
(<code>response_type=token</code>) with a client_id configured to request <code>WWW-Authenticate challenges</code>
(like <code>openshift-challenging-client</code>), these are the possible server
responses from <code>/oauth/authorize</code>, and how they should be handled:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 44.4444%;">
<col style="width: 44.4445%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Content</th>
<th class="tableblock halign-left valign-top">Client response</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>302</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Location</code> header containing an <code>access_token</code> parameter in the URL fragment (<a href="https://tools.ietf.org/html/rfc6749#section-4.2.2">RFC 6749 section 4.2.2</a>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Use the <code>access_token</code> value as the OAuth token.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>302</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Location</code> header containing an <code>error</code> query parameter (<a href="https://tools.ietf.org/html/rfc6749#section-4.1.2.1">RFC 6749 section 4.1.2.1</a>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Fail, optionally surfacing the <code>error</code> (and optional <code>error_description</code>) query values to the user.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>302</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Other <code>Location</code> header</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Follow the redirect, and process the result using these rules.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>401</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>WWW-Authenticate</code> header present</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Respond to challenge if type is recognized (e.g. <code>Basic</code>, <code>Negotiate</code>, etc), resubmit request, and process the result using these rules.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>401</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>WWW-Authenticate</code> header missing</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No challenge authentication is possible. Fail and show response body (which might contain links or details on alternate methods to obtain an OAuth token).</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Other</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Other</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Fail, optionally surfacing response body to the user.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="oauth-internal-options_configuring-internal-oauth">Options for the internal OAuth server</h3>
<div class="paragraph">
<p>Several configuration options are available for the internal OAuth server.</p>
</div>
<div class="sect3">
<h4 id="oauth-token-duration_configuring-internal-oauth">OAuth token duration options</h4>
<div class="paragraph">
<p>The internal OAuth server generates two kinds of tokens:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Token</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access tokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Longer-lived tokens that grant access to the API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorize codes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short-lived tokens whose only use is to be exchanged for
an access token.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can configure the default duration for both types of token. If necessary,
you can override the duration of the access token by using an <code>OAuthClient</code>
object definition.</p>
</div>
</div>
<div class="sect3">
<h4 id="oauth-grant-options_configuring-internal-oauth">OAuth grant options</h4>
<div class="paragraph">
<p>When the OAuth server receives token requests for a client to which the user
has not previously granted permission, the action that the OAuth server
takes is dependent on the OAuth client&#8217;s grant strategy.</p>
</div>
<div class="paragraph">
<p>The OAuth client requesting token must provide its own grant strategy.</p>
</div>
<div class="paragraph">
<p>You can apply the following default methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Grant option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>auto</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto-approve the grant and retry the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>prompt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prompt the user to approve or deny the grant.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="oauth-configuring-internal-oauth_configuring-internal-oauth">Configuring the internal OAuth server&#8217;s token duration</h3>
<div class="paragraph">
<p>You can configure default options for the internal OAuth server&#8217;s
token duration.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, tokens are only valid for 24 hours. Existing sessions
expire after this time elapses.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the default time is insufficient, then this can be modified using
the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a configuration file that contains the token duration options. The
following file sets this to 48 hours, twice the default.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  tokenConfig:
    accessTokenMaxAgeSeconds: 172800 <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set <code>accessTokenMaxAgeSeconds</code> to control the lifetime of access tokens.
The default lifetime is 24 hours, or 86400 seconds. This attribute cannot
be negative. If set to zero, the default lifetime is used.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the new configuration file:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Because you update the existing OAuth server, you must use the <code>oc apply</code>
command to apply the change.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/file.yaml&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the changes are in effect:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe oauth.config.openshift.io/cluster</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">...
Spec:
  Token Config:
    Access Token Max Age Seconds:  172800
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="oauth-token-inactivity-timeout_configuring-internal-oauth">Configuring token inactivity timeout for the internal OAuth server</h3>
<div class="paragraph">
<p>You can configure OAuth tokens to expire after a set period of inactivity. By default, no token inactivity timeout is set.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the token inactivity timeout is also configured in your OAuth client, that value overrides the timeout that is set in the internal OAuth server configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You have configured an identity provider (IDP).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the <code>OAuth</code> configuration to set a token inactivity timeout.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>OAuth</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit oauth cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the <code>spec.tokenConfig.accessTokenInactivityTimeout</code> field and set your timeout value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
...
spec:
  tokenConfig:
    accessTokenInactivityTimeout: 400s <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set a value with the appropriate units, for example <code>400s</code> for 400 seconds, or <code>30m</code> for 30 minutes. The minimum allowed timeout value is <code>300s</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Check that the OAuth server pods have restarted:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get clusteroperators authentication</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not continue to the next step until <code>PROGRESSING</code> is listed as <code>False</code>, as shown in the following output:</p>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME             VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication   4.13.0    True        False         False      145m</code></pre>
</div>
</div>
</li>
<li>
<p>Check that a new revision of the Kubernetes API server pods has rolled out. This will take several minutes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get clusteroperators kube-apiserver</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not continue to the next step until <code>PROGRESSING</code> is listed as <code>False</code>, as shown in the following output:</p>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME             VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
kube-apiserver   4.13.0     True        False         False      145m</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>PROGRESSING</code> is showing <code>True</code>, wait a few minutes and try again.</p>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Verification</div>
<ol class="arabic">
<li>
<p>Log in to the cluster with an identity from your IDP.</p>
</li>
<li>
<p>Execute a command and verify that it was successful.</p>
</li>
<li>
<p>Wait longer than the configured timeout without using the identity. In this procedure&#8217;s example, wait longer than 400 seconds.</p>
</li>
<li>
<p>Try to execute a command from the same identity&#8217;s session.</p>
<div class="paragraph">
<p>This command should fail because the token should have expired due to inactivity longer than the configured timeout.</p>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">error: You must be logged in to the server (Unauthorized)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="customizing-the-oauth-server-url_configuring-internal-oauth">Customizing the internal OAuth server URL</h3>
<div class="paragraph">
<p>You can customize the internal OAuth server URL by setting the custom hostname and TLS certificate in the <code>spec.componentRoutes</code> field of the cluster <code>Ingress</code> configuration.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you update the internal OAuth server URL, you might break trust from components in the cluster that need to communicate with the OpenShift OAuth server to retrieve OAuth access tokens. Components that need to trust the OAuth server will need to include the proper CA bundle when calling OAuth endpoints. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt; -p &lt;password&gt; --certificate-authority=&lt;path_to_ca.crt&gt; <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For self-signed certificates, the <code>ca.crt</code> file must contain the custom CA certificate, otherwise the login will not succeed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Cluster Authentication Operator publishes the OAuth server&#8217;s serving certificate in the <code>oauth-serving-cert</code> config map in the <code>openshift-config-managed</code> namespace. You can find the certificate in the <code>data.ca-bundle.crt</code> key of the config map.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have logged in to the cluster as a user with administrative privileges.</p>
</li>
<li>
<p>You have created a secret in the <code>openshift-config</code> namespace containing the TLS certificate and key. This is required if the domain for the custom hostname suffix does not match the cluster domain suffix. The secret is optional if the suffix matches.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can create a TLS secret by using the <code>oc create secret tls</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the cluster <code>Ingress</code> configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit ingress.config.openshift.io cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Set the custom hostname and optionally the serving certificate and key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: Ingress
metadata:
  name: cluster
spec:
  componentRoutes:
    - name: oauth-openshift
      namespace: openshift-authentication
      hostname: &lt;custom_hostname&gt; <b class="conum">(1)</b>
      servingCertKeyPairSecret:
        name: &lt;secret_name&gt; <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The custom hostname.</p>
</li>
<li>
<p>Reference to a secret in the <code>openshift-config</code> namespace that contains a TLS certificate (<code>tls.crt</code>) and key (<code>tls.key</code>). This is required if the domain for the custom hostname suffix does not match the cluster domain suffix. The secret is optional if the suffix matches.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="oauth-server-metadata_configuring-internal-oauth">OAuth server metadata</h3>
<div class="paragraph">
<p>Applications running in OpenShift Container Platform might have to discover information
about the built-in OAuth server. For example, they might have to discover
what the address of the <code>&lt;namespace_route&gt;</code> is without manual
configuration.  To aid in this, OpenShift Container Platform implements the IETF
<a href="https://tools.ietf.org/html/draft-ietf-oauth-discovery-10">OAuth 2.0 Authorization Server Metadata</a> draft specification.</p>
</div>
<div class="paragraph">
<p>Thus, any application running inside the cluster can issue a <code>GET</code> request
to <strong><em>https://openshift.default.svc/.well-known/oauth-authorization-server</em></strong>
to fetch the following information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">{
  "issuer": "https://&lt;namespace_route&gt;", <b class="conum">(1)</b>
  "authorization_endpoint": "https://&lt;namespace_route&gt;/oauth/authorize", <b class="conum">(2)</b>
  "token_endpoint": "https://&lt;namespace_route&gt;/oauth/token", <b class="conum">(3)</b>
  "scopes_supported": [ <b class="conum">(4)</b>
    "user:full",
    "user:info",
    "user:check-access",
    "user:list-scoped-projects",
    "user:list-projects"
  ],
  "response_types_supported": [ <b class="conum">(5)</b>
    "code",
    "token"
  ],
  "grant_types_supported": [ <b class="conum">(6)</b>
    "authorization_code",
    "implicit"
  ],
  "code_challenge_methods_supported": [ <b class="conum">(7)</b>
    "plain",
    "S256"
  ]
}</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The authorization server&#8217;s issuer identifier, which is a URL that uses the
<code>https</code> scheme and has no query or fragment components. This is the location
where <code>.well-known</code> <a href="https://tools.ietf.org/html/rfc5785">RFC 5785</a> resources
containing information about the authorization server are published.</p>
</li>
<li>
<p>URL of the authorization server&#8217;s authorization endpoint. See
<a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a>.</p>
</li>
<li>
<p>URL of the authorization server&#8217;s token endpoint. See
<a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a>.</p>
</li>
<li>
<p>JSON array containing a list of the OAuth 2.0
<a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> scope values that this
authorization server supports. Note that not all supported scope values are
advertised.</p>
</li>
<li>
<p>JSON array containing a list of the OAuth 2.0 <code>response_type</code> values that this
authorization server supports. The array values used are the same as those used
with the <code>response_types</code> parameter defined by "OAuth 2.0 Dynamic Client
Registration Protocol" in <a href="https://tools.ietf.org/html/rfc7591">RFC 7591</a>.</p>
</li>
<li>
<p>JSON array containing a list of the OAuth 2.0 grant type values that this
authorization server supports. The array values used are the same as those used
with the <code>grant_types</code> parameter defined by
<code>OAuth 2.0 Dynamic Client Registration Protocol</code> in
<a href="https://tools.ietf.org/html/rfc7591">RFC 7591</a>.</p>
</li>
<li>
<p>JSON array containing a list of PKCE
<a href="https://tools.ietf.org/html/rfc7636">RFC 7636</a> code challenge methods
supported by this authorization server. Code challenge method values are used in
the <code>code_challenge_method</code> parameter defined in
<a href="https://tools.ietf.org/html/rfc7636#section-4.3">Section 4.3 of RFC 7636</a>.
The valid code challenge method values are those registered in the IANA
<code>PKCE Code Challenge Methods</code> registry.  See
<a href="http://www.iana.org/assignments/oauth-parameters">IANA OAuth Parameters</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="oauth-troubleshooting-api-events_configuring-internal-oauth">Troubleshooting OAuth API events</h3>
<div class="paragraph">
<p>In some cases the API server returns an <code>unexpected condition</code> error message
that is difficult to debug without direct access to the API master log.
The underlying reason for the error is purposely obscured in order
to avoid providing an unauthenticated user with information about the server&#8217;s state.</p>
</div>
<div class="paragraph">
<p>A subset of these errors is related to service account OAuth configuration issues.
These issues are captured in events that can be viewed by non-administrator users. When encountering
an <code>unexpected condition</code> server error during OAuth, run <code>oc get events</code> to view these events under <code>ServiceAccount</code>.</p>
</div>
<div class="paragraph">
<p>The following example warns of a service account that is missing a proper OAuth redirect URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get events | grep ServiceAccount</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">1m         1m          1         proxy                    ServiceAccount                                  Warning   NoSAOAuthRedirectURIs   service-account-oauth-client-getter   system:serviceaccount:myproject:proxy has no redirectURIs; set serviceaccounts.openshift.io/oauth-redirecturi.&lt;some-value&gt;=&lt;redirect&gt; or create a dynamic URI using serviceaccounts.openshift.io/oauth-redirectreference.&lt;some-value&gt;=&lt;reference&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running <code>oc describe sa/&lt;service_account_name&gt;</code> reports any OAuth events associated with the given service account name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe sa/proxy | grep -A5 Events</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Events:
  FirstSeen     LastSeen        Count   From                                    SubObjectPath   Type            Reason                  Message
  ---------     --------        -----   ----                                    -------------   --------        ------                  -------
  3m            3m              1       service-account-oauth-client-getter                     Warning         NoSAOAuthRedirectURIs   system:serviceaccount:myproject:proxy has no redirectURIs; set serviceaccounts.openshift.io/oauth-redirecturi.&lt;some-value&gt;=&lt;redirect&gt; or create a dynamic URI using serviceaccounts.openshift.io/oauth-redirectreference.&lt;some-value&gt;=&lt;reference&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a list of the possible event errors:</p>
</div>
<div class="paragraph">
<p><strong>No redirect URI annotations or an invalid URI is specified</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Reason                  Message
NoSAOAuthRedirectURIs   system:serviceaccount:myproject:proxy has no redirectURIs; set serviceaccounts.openshift.io/oauth-redirecturi.&lt;some-value&gt;=&lt;redirect&gt; or create a dynamic URI using serviceaccounts.openshift.io/oauth-redirectreference.&lt;some-value&gt;=&lt;reference&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Invalid route specified</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Reason                  Message
NoSAOAuthRedirectURIs   [routes.route.openshift.io "&lt;name&gt;" not found, system:serviceaccount:myproject:proxy has no redirectURIs; set serviceaccounts.openshift.io/oauth-redirecturi.&lt;some-value&gt;=&lt;redirect&gt; or create a dynamic URI using serviceaccounts.openshift.io/oauth-redirectreference.&lt;some-value&gt;=&lt;reference&gt;]</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Invalid reference type specified</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Reason                  Message
NoSAOAuthRedirectURIs   [no kind "&lt;name&gt;" is registered for version "v1", system:serviceaccount:myproject:proxy has no redirectURIs; set serviceaccounts.openshift.io/oauth-redirecturi.&lt;some-value&gt;=&lt;redirect&gt; or create a dynamic URI using serviceaccounts.openshift.io/oauth-redirectreference.&lt;some-value&gt;=&lt;reference&gt;]</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Missing SA tokens</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Reason                  Message
NoSAOAuthTokens         system:serviceaccount:myproject:proxy has no tokens</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-oauth-clients">Configuring OAuth clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Several OAuth clients are created by default in OpenShift Container Platform. You can also register and configure additional OAuth clients.</p>
</div>
<div class="sect2">
<h3 id="oauth-default-clients_configuring-oauth-clients">Default OAuth clients</h3>
<div class="paragraph">
<p>The following OAuth clients are automatically created when starting the OpenShift Container Platform API:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">OAuth client</th>
<th class="tableblock halign-left valign-top">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openshift-browser-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests tokens at <code>&lt;namespace_route&gt;/oauth/token/request</code> with a user-agent that can handle interactive logins. <sup>[1]</sup></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openshift-challenging-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests tokens with a user-agent that can handle <code>WWW-Authenticate</code> challenges.</p></td>
</tr>
</tbody>
</table>
<div class="openblock small">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>&lt;namespace_route&gt;</code> refers to the namespace route. This is found by
running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get route oauth-openshift -n openshift-authentication -o json | jq .spec.host</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oauth-register-additional-client_configuring-oauth-clients">Registering an additional OAuth client</h3>
<div class="paragraph">
<p>If you need an additional OAuth client to manage authentication for your
OpenShift Container Platform cluster, you can register one.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To register additional OAuth clients:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f &lt;(echo '
kind: OAuthClient
apiVersion: oauth.openshift.io/v1
metadata:
 name: demo <b class="conum">(1)</b>
secret: "..." <b class="conum">(2)</b>
redirectURIs:
 - "http://www.example.com/" <b class="conum">(3)</b>
grantMethod: prompt <b class="conum">(4)</b>
')</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>name</code> of the OAuth client is used as the <code>client_id</code> parameter when
making requests to <code>&lt;namespace_route&gt;/oauth/authorize</code> and
<code>&lt;namespace_route&gt;/oauth/token</code>.</p>
</li>
<li>
<p>The <code>secret</code> is used as the <code>client_secret</code> parameter when making requests
to <code>&lt;namespace_route&gt;/oauth/token</code>.</p>
</li>
<li>
<p>The <code>redirect_uri</code> parameter specified in requests to
<code>&lt;namespace_route&gt;/oauth/authorize</code> and <code>&lt;namespace_route&gt;/oauth/token</code>
 must be equal to or prefixed by one of the URIs listed in the
<code>redirectURIs</code> parameter value.</p>
</li>
<li>
<p>The <code>grantMethod</code> is used to determine what action to take when this
client requests tokens and has not yet been granted access by the user.
Specify <code>auto</code> to automatically approve the grant and retry the request,
or <code>prompt</code> to prompt the user to approve or deny the grant.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="oauth-token-inactivity-timeout_configuring-oauth-clients">Configuring token inactivity timeout for an OAuth client</h3>
<div class="paragraph">
<p>You can configure OAuth clients to expire OAuth tokens after a set period of inactivity. By default, no token inactivity timeout is set.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the token inactivity timeout is also configured in the internal OAuth server configuration, the timeout that is set in the OAuth client overrides that value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You have configured an identity provider (IDP).</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Update the <code>OAuthClient</code> configuration to set a token inactivity timeout.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>OAuthClient</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit oauthclient &lt;oauth_client&gt; <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Replace <code>&lt;oauth_client&gt;</code> with the OAuth client to configure, for example, <code>console</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Add the <code>accessTokenInactivityTimeoutSeconds</code> field and set your timeout value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: oauth.openshift.io/v1
grantMethod: auto
kind: OAuthClient
metadata:
...
accessTokenInactivityTimeoutSeconds: 600 <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The minimum allowed timeout value in seconds is <code>300</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Verification</div>
<ol class="arabic">
<li>
<p>Log in to the cluster with an identity from your IDP. Be sure to use the OAuth client that you just configured.</p>
</li>
<li>
<p>Perform an action and verify that it was successful.</p>
</li>
<li>
<p>Wait longer than the configured timeout without using the identity. In this procedure&#8217;s example, wait longer than 600 seconds.</p>
</li>
<li>
<p>Try to perform an action from the same identity&#8217;s session.</p>
<div class="paragraph">
<p>This attempt should fail because the token should have expired due to inactivity longer than the configured timeout.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2 _additional-resources">
<h3 id="_additional-resources">Additional resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/api_reference/#oauthclient-oauth-openshift-io-v1">OAuthClient [oauth.openshift.io/v1</a>]</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-oauth-access-tokens">Managing user-owned OAuth access tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Users can review their own OAuth access tokens and delete any that are no longer needed.</p>
</div>
<div class="sect2">
<h3 id="oauth-list-tokens_managing-oauth-access-tokens">Listing user-owned OAuth access tokens</h3>
<div class="paragraph">
<p>You can list your user-owned OAuth access tokens. Token names are not sensitive and cannot be used to log in.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>List all user-owned OAuth access tokens:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get useroauthaccesstokens</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME       CLIENT NAME                    CREATED                EXPIRES                         REDIRECT URI                                                       SCOPES
&lt;token1&gt;   openshift-challenging-client   2021-01-11T19:25:35Z   2021-01-12 19:25:35 +0000 UTC   https://oauth-openshift.apps.example.com/oauth/token/implicit      user:full
&lt;token2&gt;   openshift-browser-client       2021-01-11T19:27:06Z   2021-01-12 19:27:06 +0000 UTC   https://oauth-openshift.apps.example.com/oauth/token/display       user:full
&lt;token3&gt;   console                        2021-01-11T19:26:29Z   2021-01-12 19:26:29 +0000 UTC   https://console-openshift-console.apps.example.com/auth/callback   user:full</code></pre>
</div>
</div>
</li>
<li>
<p>List user-owned OAuth access tokens for a particular OAuth client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get useroauthaccesstokens --field-selector=clientName="console"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME       CLIENT NAME                    CREATED                EXPIRES                         REDIRECT URI                                                       SCOPES
&lt;token3&gt;   console                        2021-01-11T19:26:29Z   2021-01-12 19:26:29 +0000 UTC   https://console-openshift-console.apps.example.com/auth/callback   user:full</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="oauth-view-details-tokens_managing-oauth-access-tokens">Viewing the details of a user-owned OAuth access token</h3>
<div class="paragraph">
<p>You can view the details of a user-owned OAuth access token.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Describe the details of a user-owned OAuth access token:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe useroauthaccesstokens &lt;token_name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:                        &lt;token_name&gt; <b class="conum">(1)</b>
Namespace:
Labels:                      &lt;none&gt;
Annotations:                 &lt;none&gt;
API Version:                 oauth.openshift.io/v1
Authorize Token:             sha256~Ksckkug-9Fg_RWn_AUysPoIg-_HqmFI9zUL_CgD8wr8
Client Name:                 openshift-browser-client <b class="conum">(2)</b>
Expires In:                  86400 <b class="conum">(3)</b>
Inactivity Timeout Seconds:  317 <b class="conum">(4)</b>
Kind:                        UserOAuthAccessToken
Metadata:
  Creation Timestamp:  2021-01-11T19:27:06Z
  Managed Fields:
    API Version:  oauth.openshift.io/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:authorizeToken:
      f:clientName:
      f:expiresIn:
      f:redirectURI:
      f:scopes:
      f:userName:
      f:userUID:
    Manager:         oauth-server
    Operation:       Update
    Time:            2021-01-11T19:27:06Z
  Resource Version:  30535
  Self Link:         /apis/oauth.openshift.io/v1/useroauthaccesstokens/&lt;token_name&gt;
  UID:               f9d00b67-ab65-489b-8080-e427fa3c6181
Redirect URI:        https://oauth-openshift.apps.example.com/oauth/token/display
Scopes:
  user:full <b class="conum">(5)</b>
User Name:  &lt;user_name&gt; <b class="conum">(6)</b>
User UID:   82356ab0-95f9-4fb3-9bc0-10f1d6a6a345
Events:     &lt;none&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The token name, which is the sha256 hash of the token. Token names are not sensitive and cannot be used to log in.</p>
</li>
<li>
<p>The client name, which describes where the token originated from.</p>
</li>
<li>
<p>The value in seconds from the creation time before this token expires.</p>
</li>
<li>
<p>If there is a token inactivity timeout set for the OAuth server, this is the value in seconds from the creation time before this token can no longer be used.</p>
</li>
<li>
<p>The scopes for this token.</p>
</li>
<li>
<p>The user name associated with this token.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="oauth-delete-tokens_managing-oauth-access-tokens">Deleting user-owned OAuth access tokens</h3>
<div class="paragraph">
<p>The <code>oc logout</code> command only invalidates the OAuth token for the active session. You can use the following procedure to delete any user-owned OAuth tokens that are no longer needed.</p>
</div>
<div class="paragraph">
<p>Deleting an OAuth access token logs out the user from all sessions that use the token.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Delete the user-owned OAuth access token:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete useroauthaccesstokens &lt;token_name&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">useroauthaccesstoken.oauth.openshift.io "&lt;token_name&gt;" deleted</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-identity-provider">Understanding identity provider configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OpenShift Container Platform master includes a built-in OAuth server. Developers and
administrators obtain OAuth access tokens to authenticate themselves to the API.</p>
</div>
<div class="paragraph">
<p>As an administrator, you can configure OAuth to specify an identity provider
after you install your cluster.</p>
</div>
<div class="sect2">
<h3 id="identity-provider-overview_understanding-identity-provider">About identity providers in OpenShift Container Platform</h3>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="supported-identity-providers">Supported identity providers</h3>
<div class="paragraph">
<p>You can configure the following types of identity providers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Identity provider</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-htpasswd-identity-provider">htpasswd</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure the <code>htpasswd</code> identity provider to validate user names and passwords
against a flat file generated using
<a href="http://httpd.apache.org/docs/2.4/programs/htpasswd.html"><code>htpasswd</code></a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-keystone-identity-provider">Keystone</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure the <code>keystone</code> identity provider to integrate
your OpenShift Container Platform cluster with Keystone to enable shared authentication with
an OpenStack Keystone v3 server configured to store users in an internal
database.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-ldap-identity-provider">LDAP</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure the <code>ldap</code> identity provider to validate user names and passwords
against an LDAPv3 server, using simple bind authentication.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-basic-authentication-identity-provider">Basic authentication</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure a <code>basic-authentication</code> identity provider for users to log in to
OpenShift Container Platform with credentials validated against a remote identity provider.
Basic authentication is a generic backend integration mechanism.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-request-header-identity-provider">Request header</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure a <code>request-header</code> identity provider to identify users from request
header values, such as <code>X-Remote-User</code>. It is typically used in combination with
an authenticating proxy, which sets the request header value.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-github-identity-provider">GitHub or GitHub Enterprise</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure a <code>github</code> identity provider to validate user names and passwords
against GitHub or GitHub Enterprise&#8217;s OAuth authentication server.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-gitlab-identity-provider">GitLab</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure a <code>gitlab</code> identity provider to use
<a href="https://gitlab.com/">GitLab.com</a> or any other GitLab instance as an identity
provider.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-google-identity-provider">Google</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure a <code>google</code> identity provider using
<a href="https://developers.google.com/identity/protocols/OpenIDConnect">Google&#8217;s OpenID Connect integration</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="#configuring-oidc-identity-provider">OpenID Connect</a></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Configure an <code>oidc</code> identity provider to integrate with an OpenID Connect
identity provider using an
<a href="http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code Flow</a>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once an identity provider has been defined, you can
<a href="#authorization-overview_using-rbac">use RBAC to define and apply permissions</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="removing-kubeadmin_understanding-identity-provider">Removing the kubeadmin user</h3>
<div class="paragraph">
<p>After you define an identity provider and create a new <code>cluster-admin</code>
user, you can remove the <code>kubeadmin</code> to improve cluster security.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you follow this procedure before another user is a <code>cluster-admin</code>,
then OpenShift Container Platform must be reinstalled. It is not possible to undo
this command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have configured at least one identity provider.</p>
</li>
<li>
<p>You must have added the <code>cluster-admin</code> role to a user.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Remove the <code>kubeadmin</code> secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete secrets kubeadmin -n kube-system</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="identity-provider-parameters_understanding-identity-provider">Identity provider parameters</h3>
<div class="paragraph">
<p>The following parameters are common to all identity providers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>name</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The provider name is prefixed to provider user names to form an
identity name.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>mappingMethod</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines how new identities are mapped to users when they log in.
Enter one of the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">claim</dt>
<dd>
<p>The default value. Provisions a user with the identity&#8217;s preferred
user name. Fails if a user with that user name is already mapped to another
identity.</p>
</dd>
<dt class="hdlist1">lookup</dt>
<dd>
<p>Looks up an existing identity, user identity mapping, and user,
but does not automatically provision users or identities. This allows cluster
administrators to set up identities and users manually, or using an external
process. Using this method requires you to manually provision users.</p>
</dd>
<dt class="hdlist1">generate</dt>
<dd>
<p>Provisions a user with the identity&#8217;s preferred user name. If a
user with the preferred user name is already mapped to an existing identity, a
unique user name is generated. For example, <code>myuser2</code>. This method should not be
used in combination with external processes that require exact matches between
OpenShift Container Platform user names and identity provider user names, such as LDAP group
sync.</p>
</dd>
<dt class="hdlist1">add</dt>
<dd>
<p>Provisions a user with the identity&#8217;s preferred user name. If a user
with that user name already exists, the identity is mapped to the existing user,
adding to any existing identity mappings for the user. Required when multiple
identity providers are configured that identify the same set of users and map to
the same user names.</p>
</dd>
</dl>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When adding or changing identity providers, you can map identities from the new
provider to existing users by setting the <code>mappingMethod</code> parameter to
<code>add</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="identity-provider-default-CR_understanding-identity-provider">Sample identity provider CR</h3>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and default
values that you use to configure an identity provider. This example
uses the htpasswd identity provider.</p>
</div>
<div class="listingblock">
<div class="title">Sample identity provider CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: my_identity_provider <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpass-secret <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to provider user names to form an
identity name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s
identities and <code>User</code> objects.</p>
</li>
<li>
<p>An existing secret containing a file generated using
<a href="http://httpd.apache.org/docs/2.4/programs/htpasswd.html"><code>htpasswd</code></a>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring-identity-providers">Configuring identity providers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuring-htpasswd-identity-provider">Configuring an htpasswd identity provider</h3>
<div class="paragraph">
<p>Configure the <code>htpasswd</code> identity provider to allow users to log in to OpenShift Container Platform with credentials from an htpasswd file.</p>
</div>
<div class="paragraph">
<p>To define an htpasswd identity provider, perform the following tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#creating-htpasswd-file">Create an <code>htpasswd</code> file</a> to store the user and password information.</p>
</li>
<li>
<p><a href="../../authentication/identity_providers/configuring-htpasswd-identity-provider.html#identity-provider-creating-htpasswd-secret_configuring-htpasswd-identity-provider">Create
a secret</a> to represent the <code>htpasswd</code> file.</p>
</li>
<li>
<p><a href="../../authentication/identity_providers/configuring-htpasswd-identity-provider.html#identity-provider-htpasswd-CR_configuring-htpasswd-identity-provider">Define an htpasswd identity provider resource</a> that references the secret.</p>
</li>
<li>
<p><a href="../../authentication/identity_providers/configuring-htpasswd-identity-provider.html#add-identity-provider_configuring-htpasswd-identity-provider">Apply the resource</a> to
the default OAuth configuration to add the identity provider.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-htpasswd-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-htpasswd-about_configuring-htpasswd-identity-provider">About htpasswd authentication</h4>
<div class="paragraph">
<p>Using htpasswd authentication in OpenShift Container Platform allows you to identify users based on an htpasswd file. An htpasswd file is a flat file that contains the user name and hashed password for each user. You can use the <code>htpasswd</code> utility to create this file.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-htpasswd-file">Creating the htpasswd file</h4>
<div class="paragraph">
<p>See one of the following sections for instructions about how to create the htpasswd file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#identity-provider-creating-htpasswd-file-linux_configuring-htpasswd-identity-provider">Creating an htpasswd file using Linux</a></p>
</li>
<li>
<p><a href="#identity-provider-creating-htpasswd-file-windows_configuring-htpasswd-identity-provider">Creating an htpasswd file using Windows</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="identity-provider-creating-htpasswd-file-linux_configuring-htpasswd-identity-provider">Creating an htpasswd file using Linux</h5>
<div class="paragraph">
<p>To use the htpasswd identity provider, you must generate a flat file that
contains the user names and passwords for your cluster by using
<a href="http://httpd.apache.org/docs/2.4/programs/htpasswd.html"><code>htpasswd</code></a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have access to the <code>htpasswd</code> utility. On Red Hat Enterprise Linux
this is available by installing the <code>httpd-tools</code> package.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create or update your flat file with a user name and hashed password:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ htpasswd -c -B -b &lt;/path/to/users.htpasswd&gt; &lt;user_name&gt; &lt;password&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command generates a hashed version of the password.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ htpasswd -c -B -b users.htpasswd user1 MyPassword!</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Adding password for user user1</code></pre>
</div>
</div>
</li>
<li>
<p>Continue to add or update credentials to the file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ htpasswd -B -b &lt;/path/to/users.htpasswd&gt; &lt;user_name&gt; &lt;password&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="identity-provider-creating-htpasswd-file-windows_configuring-htpasswd-identity-provider">Creating an htpasswd file using Windows</h5>
<div class="paragraph">
<p>To use the htpasswd identity provider, you must generate a flat file that
contains the user names and passwords for your cluster by using
<a href="http://httpd.apache.org/docs/2.4/programs/htpasswd.html"><code>htpasswd</code></a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have access to <code>htpasswd.exe</code>. This file is included in the <code>\bin</code>
directory of many Apache httpd distributions.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create or update your flat file with a user name and hashed password:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">&gt; htpasswd.exe -c -B -b &lt;\path\to\users.htpasswd&gt; &lt;user_name&gt; &lt;password&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command generates a hashed version of the password.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">&gt; htpasswd.exe -c -B -b users.htpasswd user1 MyPassword!</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Adding password for user user1</code></pre>
</div>
</div>
</li>
<li>
<p>Continue to add or update credentials to the file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">&gt; htpasswd.exe -b &lt;\path\to\users.htpasswd&gt; &lt;user_name&gt; &lt;password&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-htpasswd-secret_configuring-htpasswd-identity-provider">Creating the htpasswd secret</h4>
<div class="paragraph">
<p>To use the htpasswd identity provider, you must define a secret that
contains the htpasswd user file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an htpasswd file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object that contains the htpasswd users file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic htpass-secret --from-file=htpasswd=&lt;path_to_users.htpasswd&gt; -n openshift-config <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The secret key containing the users file for the <code>--from-file</code> argument must be named <code>htpasswd</code>, as shown in the above command.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: htpass-secret
  namespace: openshift-config
type: Opaque
data:
  htpasswd: &lt;base64_encoded_htpasswd_file_contents&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-htpasswd-CR_configuring-htpasswd-identity-provider">Sample htpasswd CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for an
htpasswd identity provider.</p>
</div>
<div class="listingblock">
<div class="title">htpasswd CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: my_htpasswd_provider <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpass-secret <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to provider user names to form an identity
name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>An existing secret containing a file generated using
<a href="http://httpd.apache.org/docs/2.4/programs/htpasswd.html"><code>htpasswd</code></a>.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-htpasswd-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-htpasswd-update-users_configuring-htpasswd-identity-provider">Updating users for an htpasswd identity provider</h4>
<div class="paragraph">
<p>You can add or remove users from an existing htpasswd identity provider.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have created a <code>Secret</code> object that contains the htpasswd user file. This procedure assumes that it is named <code>htpass-secret</code>.</p>
</li>
<li>
<p>You have configured an htpasswd identity provider. This procedure assumes that it is named <code>my_htpasswd_provider</code>.</p>
</li>
<li>
<p>You have access to the <code>htpasswd</code> utility. On Red Hat Enterprise Linux this is available by installing the <code>httpd-tools</code> package.</p>
</li>
<li>
<p>You have cluster administrator privileges.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Retrieve the htpasswd file from the <code>htpass-secret</code> <code>Secret</code> object and save the file to your file system:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secret htpass-secret -ojsonpath={.data.htpasswd} -n openshift-config | base64 --decode &gt; users.htpasswd</code></pre>
</div>
</div>
</li>
<li>
<p>Add or remove users from the <code>users.htpasswd</code> file.</p>
<div class="ulist">
<ul>
<li>
<p>To add a new user:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ htpasswd -bB users.htpasswd &lt;username&gt; &lt;password&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Adding password for user &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>To remove an existing user:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ htpasswd -D users.htpasswd &lt;username&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Deleting password for user &lt;username&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Replace the <code>htpass-secret</code> <code>Secret</code> object with the updated users in the <code>users.htpasswd</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic htpass-secret --from-file=htpasswd=users.htpasswd --dry-run=client -o yaml -n openshift-config | oc replace -f -</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to replace the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: htpass-secret
  namespace: openshift-config
type: Opaque
data:
  htpasswd: &lt;base64_encoded_htpasswd_file_contents&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you removed one or more users, you must additionally remove existing resources for each user.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Delete the <code>User</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete user &lt;username&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">user.user.openshift.io "&lt;username&gt;" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to remove the user, otherwise the user can continue using their token as long as it has not expired.</p>
</div>
</li>
<li>
<p>Delete the <code>Identity</code> object for the user:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete identity my_htpasswd_provider:&lt;username&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">identity.user.openshift.io "my_htpasswd_provider:&lt;username&gt;" deleted</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-configuring-using-the-web-console_configuring-htpasswd-identity-provider">Configuring identity providers using the web console</h4>
<div class="paragraph">
<p>Configure your identity provider (IDP) through the web console instead of the CLI.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must be logged in to the web console as a cluster administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to <strong>Administration</strong> &#8594; <strong>Cluster Settings</strong>.</p>
</li>
<li>
<p>Under the <strong>Configuration</strong> tab, click <strong>OAuth</strong>.</p>
</li>
<li>
<p>Under the <strong>Identity Providers</strong> section, select your identity provider from the
<strong>Add</strong> drop-down menu.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can specify multiple IDPs through the web console without overwriting
existing IDPs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-keystone-identity-provider">Configuring a Keystone identity provider</h3>
<div class="paragraph">
<p>Configure the <code>keystone</code> identity provider to integrate your OpenShift Container Platform cluster with Keystone to enable shared authentication with an OpenStack Keystone v3 server configured to store users in an internal database. This configuration allows users to log in to OpenShift Container Platform with their Keystone credentials.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-keystone-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-keystone-about_configuring-keystone-identity-provider">About Keystone authentication</h4>
<div class="paragraph">
<p><a href="http://docs.openstack.org/developer/keystone/">Keystone</a> is an OpenStack project that provides identity, token, catalog, and policy services.</p>
</div>
<div class="paragraph">
<p>You can configure the integration with Keystone so that the new OpenShift Container Platform users are based on either the Keystone user names or unique Keystone IDs. With both methods, users log in by entering their Keystone user name and password. Basing the OpenShift Container Platform users on the Keystone ID is more secure because if you delete a Keystone user and create a new Keystone user with that user name, the new user might have access to the old user&#8217;s resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret-tls_configuring-keystone-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object that contains the key and certificate by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret tls &lt;secret_name&gt; --key=key.pem --cert=cert.pem -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: kubernetes.io/tls
data:
  tls.crt: &lt;base64_encoded_cert&gt;
  tls.key: &lt;base64_encoded_key&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-keystone-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-keystone-CR_configuring-keystone-identity-provider">Sample Keystone CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for a
Keystone identity provider.</p>
</div>
<div class="listingblock">
<div class="title">Keystone CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: keystoneidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: Keystone
    keystone:
      domainName: default <b class="conum">(3)</b>
      url: https://keystone.example.com:5000 <b class="conum">(4)</b>
      ca: <b class="conum">(5)</b>
        name: ca-config-map
      tlsClientCert: <b class="conum">(6)</b>
        name: client-cert-secret
      tlsClientKey: <b class="conum">(7)</b>
        name: client-key-secret</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to provider user names to form an identity name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>Keystone domain name. In Keystone, usernames are domain-specific. Only a single domain is supported.</p>
</li>
<li>
<p>The URL to use to connect to the Keystone server (required). This must
use https.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing the
PEM-encoded certificate authority bundle to use in validating server
certificates for the configured URL.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>Secret</code> object containing the client
certificate to present when making requests to the configured URL.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>Secret</code> object containing the key for the
client certificate. Required if <code>tlsClientCert</code> is specified.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-keystone-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-ldap-identity-provider">Configuring an LDAP identity provider</h3>
<div class="paragraph">
<p>Configure the <code>ldap</code> identity provider to validate user names and passwords against an LDAPv3 server, using simple bind authentication.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-ldap-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-about-ldap_configuring-ldap-identity-provider">About LDAP authentication</h4>
<div class="paragraph">
<p>During authentication, the LDAP directory is searched for an entry that matches
the provided user name. If a single unique match is found, a simple bind is
attempted using the distinguished name (DN) of the entry plus the provided
password.</p>
</div>
<div class="paragraph">
<p>These are the steps taken:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate a search filter by combining the attribute and filter in the
configured <code>url</code> with the user-provided user name.</p>
</li>
<li>
<p>Search the directory using the generated filter. If the search does not return
exactly one entry, deny access.</p>
</li>
<li>
<p>Attempt to bind to the LDAP server using the DN of the entry retrieved from
the search, and the user-provided password.</p>
</li>
<li>
<p>If the bind is unsuccessful, deny access.</p>
</li>
<li>
<p>If the bind is successful, build an identity using the configured attributes
as the identity, email address, display name, and preferred user name.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The configured <code>url</code> is an RFC 2255 URL, which specifies the LDAP host and
search parameters to use. The syntax of the URL is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ldap://host:port/basedn?attribute?scope?filter</pre>
</div>
</div>
<div class="paragraph">
<p>For this URL:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">URL component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>ldap</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>For regular LDAP, use the string <code>ldap</code>. For secure LDAP
(LDAPS), use <code>ldaps</code> instead.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>host:port</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The name and port of the LDAP server. Defaults to
<code>localhost:389</code> for ldap and <code>localhost:636</code> for LDAPS.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>basedn</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The DN of the branch of the directory where all searches should
start from. At the very least, this must be the top of your directory tree, but
it could also specify a subtree in the directory.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>attribute</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The attribute to search for. Although RFC 2255 allows a
comma-separated list of attributes, only the first attribute will be used, no
matter how many are provided. If no attributes are provided, the default is to
use <code>uid</code>. It is recommended to choose an attribute that will be unique across
all entries in the subtree you will be using.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>scope</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The scope of the search. Can be either <code>one</code> or <code>sub</code>.
If the scope is not provided, the default is to use a scope of <code>sub</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>filter</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A valid LDAP search filter. If not provided, defaults to
<code>(objectClass=*)</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When doing searches, the attribute, filter, and provided user name are combined
to create a search filter that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">(&amp;(&lt;filter&gt;)(&lt;attribute&gt;=&lt;username&gt;))</pre>
</div>
</div>
<div class="paragraph">
<p>For example, consider a URL of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ldap://ldap.example.com/o=Acme?cn?sub?(enabled=true)</pre>
</div>
</div>
<div class="paragraph">
<p>When a client attempts to connect using a user name of <code>bob</code>, the resulting
search filter will be <code>(&amp;(enabled=true)(cn=bob))</code>.</p>
</div>
<div class="paragraph">
<p>If the LDAP directory requires authentication to search, specify a <code>bindDN</code> and
<code>bindPassword</code> to use to perform the entry search.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-ldap-secret_configuring-ldap-identity-provider">Creating the LDAP secret</h4>
<div class="paragraph">
<p>To use the identity provider, you must define an OpenShift Container Platform <code>Secret</code> object that contains the <code>bindPassword</code> field.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object that contains the <code>bindPassword</code> field:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic ldap-secret --from-literal=bindPassword=&lt;secret&gt; -n openshift-config <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The secret key containing the bindPassword for the <code>--from-literal</code> argument must be called <code>bindPassword</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: ldap-secret
  namespace: openshift-config
type: Opaque
data:
  bindPassword: &lt;base64_encoded_bind_password&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-ldap-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-ldap-CR_configuring-ldap-identity-provider">Sample LDAP CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for an
LDAP identity provider.</p>
</div>
<div class="listingblock">
<div class="title">LDAP CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: ldapidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: LDAP
    ldap:
      attributes:
        id: <b class="conum">(3)</b>
        - dn
        email: <b class="conum">(4)</b>
        - mail
        name: <b class="conum">(5)</b>
        - cn
        preferredUsername: <b class="conum">(6)</b>
        - uid
      bindDN: "" <b class="conum">(7)</b>
      bindPassword: <b class="conum">(8)</b>
        name: ldap-secret
      ca: <b class="conum">(9)</b>
        name: ca-config-map
      insecure: false <b class="conum">(10)</b>
      url: "ldaps://ldaps.example.com/ou=users,dc=acme,dc=com?uid" <b class="conum">(11)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the returned user ID to form an identity
name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>List of attributes to use as the identity. First non-empty attribute is
used. At least one attribute is required. If none of the listed attribute
have a value, authentication fails. Defined attributes are retrieved as raw,
allowing for binary values to be used.</p>
</li>
<li>
<p>List of attributes to use as the email address. First non-empty
attribute is used.</p>
</li>
<li>
<p>List of attributes to use as the display name. First non-empty
attribute is used.</p>
</li>
<li>
<p>List of attributes to use as the preferred user name when provisioning a
user for this identity. First non-empty attribute is used.</p>
</li>
<li>
<p>Optional DN to use to bind during the search phase. Must be set if
<code>bindPassword</code> is defined.</p>
</li>
<li>
<p>Optional reference to an OpenShift Container Platform <code>Secret</code> object containing the bind
password. Must be set if <code>bindDN</code> is defined.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing the
PEM-encoded certificate authority bundle to use in validating server
certificates for the configured URL. Only used when <code>insecure</code> is <code>false</code>.</p>
</li>
<li>
<p>When <code>true</code>, no TLS connection is made to the server. When <code>false</code>,
<code>ldaps://</code> URLs connect using TLS, and <code>ldap://</code> URLs are upgraded to TLS.
This must be set to <code>false</code> when <code>ldaps://</code> URLs are in use, as these
URLs always attempt to connect using TLS.</p>
</li>
<li>
<p>An RFC 2255 URL which specifies the LDAP host and search parameters to use.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>To whitelist users for an LDAP integration, use the <code>lookup</code> mapping method.
Before a login from LDAP would be allowed, a cluster administrator must create
an <code>Identity</code> object and a <code>User</code> object for each LDAP user.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-ldap-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-basic-authentication-identity-provider">Configuring a basic authentication identity provider</h3>
<div class="paragraph">
<p>Configure the <code>basic-authentication</code> identity provider for users to log in to OpenShift Container Platform with credentials validated against a remote identity provider. Basic authentication is a generic back-end integration mechanism.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-basic-authentication-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-about-basic-authentication_configuring-basic-authentication-identity-provider">About basic authentication</h4>
<div class="paragraph">
<p>Basic authentication is a generic back-end integration mechanism that allows
users to log in to OpenShift Container Platform with credentials validated against a remote
identity provider.</p>
</div>
<div class="paragraph">
<p>Because basic authentication is generic, you can use this identity
provider for advanced authentication configurations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Basic authentication must use an HTTPS connection to the remote server to
prevent potential snooping of the user ID and password and man-in-the-middle
attacks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With basic authentication configured, users send their user name
and password to OpenShift Container Platform, which then validates those credentials against
a remote server by making a server-to-server request, passing the credentials as
a basic authentication header. This requires users to send their credentials to
OpenShift Container Platform during login.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This only works for user name/password login mechanisms, and OpenShift Container Platform must
be able to make network requests to the remote authentication server.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>User names and passwords are validated against a remote URL that is protected
by basic authentication and returns JSON.</p>
</div>
<div class="paragraph">
<p>A <code>401</code> response indicates failed authentication.</p>
</div>
<div class="paragraph">
<p>A non-<code>200</code> status, or the presence of a non-empty "error" key, indicates an
error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"error":"Error message"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>200</code> status with a <code>sub</code> (subject) key indicates success:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid"} <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The subject must be unique to the authenticated user and must not be able to
be modified.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A successful response can optionally provide additional data, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A display name using the <code>name</code> key. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid", "name": "User Name", ...}</code></pre>
</div>
</div>
</li>
<li>
<p>An email address using the <code>email</code> key. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid", "email":"user@example.com", ...}</code></pre>
</div>
</div>
</li>
<li>
<p>A preferred user name using the <code>preferred_username</code> key. This is useful when
the unique, unchangeable subject is a database key or UID, and a more
human-readable name exists. This is used as a hint when provisioning the
OpenShift Container Platform user for the authenticated identity. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"014fbff9a07c", "preferred_username":"bob", ...}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret-tls_configuring-basic-authentication-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object that contains the key and certificate by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret tls &lt;secret_name&gt; --key=key.pem --cert=cert.pem -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: kubernetes.io/tls
data:
  tls.crt: &lt;base64_encoded_cert&gt;
  tls.key: &lt;base64_encoded_key&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-basic-authentication-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-basic-authentication-CR_configuring-basic-authentication-identity-provider">Sample basic authentication CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for a
basic authentication identity provider.</p>
</div>
<div class="listingblock">
<div class="title">Basic authentication CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: basicidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: BasicAuth
    basicAuth:
      url: https://www.example.com/remote-idp <b class="conum">(3)</b>
      ca: <b class="conum">(4)</b>
        name: ca-config-map
      tlsClientCert: <b class="conum">(5)</b>
        name: client-cert-secret
      tlsClientKey: <b class="conum">(6)</b>
        name: client-key-secret</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the returned user ID to form an identity
name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>URL accepting credentials in Basic authentication headers.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing the
PEM-encoded certificate authority bundle to use in validating server
certificates for the configured URL.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>Secret</code> object containing the client
certificate to present when making requests to the configured URL.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>Secret</code> object containing the key for the
client certificate. Required if <code>tlsClientCert</code> is specified.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-basic-authentication-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="example-apache-httpd-configuration_configuring-basic-authentication-identity-provider">Example Apache HTTPD configuration for basic identity providers</h4>
<div class="paragraph">
<p>The basic identify provider (IDP) configuration in OpenShift Container Platform 4 requires
that the IDP server respond with JSON for success and failures. You can use CGI
scripting in Apache HTTPD to accomplish this. This section provides examples.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>/etc/httpd/conf.d/login.conf</code></div>
<div class="content">
<pre class="nowrap">&lt;VirtualHost *:443&gt;
  # CGI Scripts in here
  DocumentRoot /var/www/cgi-bin

  # SSL Directives
  SSLEngine on
  SSLCipherSuite PROFILE=SYSTEM
  SSLProxyCipherSuite PROFILE=SYSTEM
  SSLCertificateFile /etc/pki/tls/certs/localhost.crt
  SSLCertificateKeyFile /etc/pki/tls/private/localhost.key

  # Configure HTTPD to execute scripts
  ScriptAlias /basic /var/www/cgi-bin

  # Handles a failed login attempt
  ErrorDocument 401 /basic/fail.cgi

  # Handles authentication
  &lt;Location /basic/login.cgi&gt;
    AuthType Basic
    AuthName "Please Log In"
    AuthBasicProvider file
    AuthUserFile /etc/httpd/conf/passwords
    Require valid-user
  &lt;/Location&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>/var/www/cgi-bin/login.cgi</code></div>
<div class="content">
<pre class="nowrap">#!/bin/bash
echo "Content-Type: application/json"
echo ""
echo '{"sub":"userid", "name":"'$REMOTE_USER'"}'
exit 0</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>/var/www/cgi-bin/fail.cgi</code></div>
<div class="content">
<pre class="nowrap">#!/bin/bash
echo "Content-Type: application/json"
echo ""
echo '{"error": "Login failure"}'
exit 0</pre>
</div>
</div>
<div class="sect4">
<h5 id="_file-requirements">File requirements</h5>
<div class="paragraph">
<p>These are the requirements for the files you create on an Apache HTTPD web
server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>login.cgi</code> and <code>fail.cgi</code> must be executable (<code>chmod +x</code>).</p>
</li>
<li>
<p><code>login.cgi</code> and <code>fail.cgi</code> must have proper SELinux contexts if SELinux is
enabled: <code>restorecon -RFv /var/www/cgi-bin</code>, or ensure that the context is
<code>httpd_sys_script_exec_t</code> using <code>ls -laZ</code>.</p>
</li>
<li>
<p><code>login.cgi</code> is only executed if your user successfully logs in per <code>Require
and Auth</code> directives.</p>
</li>
<li>
<p><code>fail.cgi</code> is executed if the user fails to log in, resulting in an <code>HTTP 401</code>
response.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-basic-authentication-troubleshooting_configuring-basic-authentication-identity-provider">Basic authentication troubleshooting</h4>
<div class="paragraph">
<p>The most common issue relates to network connectivity to the backend server. For
simple debugging, run <code>curl</code> commands on the master. To test for a successful
login, replace the <code>&lt;user&gt;</code> and <code>&lt;password&gt;</code> in the following example command
with valid credentials. To test an invalid login, replace them with false
credentials.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ curl --cacert /path/to/ca.crt --cert /path/to/client.crt --key /path/to/client.key -u &lt;user&gt;:&lt;password&gt; -v https://www.example.com/remote-idp</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Successful responses</strong></p>
</div>
<div class="paragraph">
<p>A <code>200</code> status with a <code>sub</code> (subject) key indicates success:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subject must be unique to the authenticated user, and must not be able to
be modified.</p>
</div>
<div class="paragraph">
<p>A successful response can optionally provide additional data, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A display name using the <code>name</code> key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid", "name": "User Name", ...}</code></pre>
</div>
</div>
</li>
<li>
<p>An email address using the <code>email</code> key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"userid", "email":"user@example.com", ...}</code></pre>
</div>
</div>
</li>
<li>
<p>A preferred user name using the <code>preferred_username</code> key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">{"sub":"014fbff9a07c", "preferred_username":"bob", ...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>preferred_username</code> key is useful when
the unique, unchangeable subject is a database key or UID, and a more
human-readable name exists. This is used as a hint when provisioning the
OpenShift Container Platform user for the authenticated identity.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Failed responses</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>401</code> response indicates failed authentication.</p>
</li>
<li>
<p>A non-<code>200</code> status or the presence of a non-empty "error" key indicates an
error: <code>{"error":"Error message"}</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-request-header-identity-provider">Configuring a request header identity provider</h3>
<div class="paragraph">
<p>Configure the <code>request-header</code> identity provider to identify users from request header values, such as <code>X-Remote-User</code>. It is typically used in combination with an authenticating proxy, which sets the request header value.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-request-header-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-about-request-header_configuring-request-header-identity-provider">About request header authentication</h4>
<div class="paragraph">
<p>A request header identity provider identifies users from request
header values, such as <code>X-Remote-User</code>. It is typically used in combination with
an authenticating proxy, which sets the request header value. The
request header identity provider cannot be combined with other identity providers
that use direct password logins, such as htpasswd, Keystone, LDAP or basic authentication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can also use the request header identity provider for advanced configurations
such as the community-supported <a href="https://github.com/openshift/request-header-saml-service-provider">SAML authentication</a>.
Note that this solution is not supported by Red Hat.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For users to authenticate using this identity provider, they must access
<code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code> (and subpaths) via an authenticating proxy.
To accomplish this, configure the OAuth server to redirect unauthenticated
requests for OAuth tokens to the proxy endpoint that proxies to
<code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code>.</p>
</div>
<div class="paragraph">
<p>To redirect unauthenticated requests from clients expecting browser-based login flows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the <code>provider.loginURL</code> parameter to the authenticating proxy URL that
will authenticate interactive clients and then proxy the request to
<code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To redirect unauthenticated requests from clients expecting <code>WWW-Authenticate</code> challenges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the <code>provider.challengeURL</code> parameter to the authenticating proxy URL that
will authenticate clients expecting <code>WWW-Authenticate</code> challenges and then proxy
the request to <code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>provider.challengeURL</code> and <code>provider.loginURL</code> parameters can include
the following tokens in the query portion of the URL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${url}</code> is replaced with the current URL, escaped to be safe in a query parameter.</p>
<div class="paragraph">
<p>For example: <code>https://www.example.com/sso-login?then=${url}</code></p>
</div>
</li>
<li>
<p><code>${query}</code> is replaced with the current query string, unescaped.</p>
<div class="paragraph">
<p>For example: <code>https://www.example.com/auth-proxy/oauth/authorize?${query}</code></p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>As of OpenShift Container Platform 4.1, your proxy must support mutual TLS.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="sspi-windows_configuring-request-header-identity-provider">SSPI connection support on Microsoft Windows</h5>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using SSPI connection support on Microsoft Windows is a Technology Preview feature only. Technology Preview features
are not supported with Red Hat production service level agreements (SLAs) and
might not be functionally complete. Red Hat does not recommend using them
in production. These features provide early access to upcoming product
features, enabling customers to test functionality and provide feedback during
the development process.</p>
</div>
<div class="paragraph">
<p>For more information about the support scope of Red Hat Technology Preview features, see <a href="https://access.redhat.com/support/offerings/techpreview/">Technology Preview Features Support Scope</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The OpenShift CLI (<code>oc</code>) supports the Security Support Provider Interface (SSPI) to allow for SSO
flows on Microsft Windows. If you use the request header identity provider with a
GSSAPI-enabled proxy to connect an Active Directory server to OpenShift Container Platform,
users can automatically authenticate to OpenShift Container Platform by using the <code>oc</code>  command
line interface from a domain-joined Microsoft Windows computer.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-request-header-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-request-header-CR_configuring-request-header-identity-provider">Sample request header CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and
acceptable values for a request header identity provider.</p>
</div>
<div class="listingblock">
<div class="title">Request header CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: requestheaderidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: RequestHeader
    requestHeader:
      challengeURL: "https://www.example.com/challenging-proxy/oauth/authorize?${query}" <b class="conum">(3)</b>
      loginURL: "https://www.example.com/login-proxy/oauth/authorize?${query}" <b class="conum">(4)</b>
      ca: <b class="conum">(5)</b>
        name: ca-config-map
      clientCommonNames: <b class="conum">(6)</b>
      - my-auth-proxy
      headers: <b class="conum">(7)</b>
      - X-Remote-User
      - SSO-User
      emailHeaders: <b class="conum">(8)</b>
      - X-Remote-User-Email
      nameHeaders: <b class="conum">(9)</b>
      - X-Remote-User-Display-Name
      preferredUsernameHeaders: <b class="conum">(10)</b>
      - X-Remote-User-Login</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the user name in the request header to
form an identity name.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>Optional: URL to redirect unauthenticated <code>/oauth/authorize</code> requests to,
that will authenticate browser-based clients and then proxy their request to
<code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code>.
The URL that proxies to <code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code> must end with <code>/authorize</code> (with no trailing slash),
and also proxy subpaths, in order for OAuth approval flows to work properly.
<code>${url}</code> is replaced with the current URL, escaped to be safe in a query parameter.
<code>${query}</code> is replaced with the current query string.
If this attribute is not defined, then <code>loginURL</code> must be used.</p>
</li>
<li>
<p>Optional: URL to redirect unauthenticated <code>/oauth/authorize</code> requests to,
that will authenticate clients which expect <code>WWW-Authenticate</code> challenges, and
then proxy them to <code>https://<em>&lt;namespace_route&gt;</em>/oauth/authorize</code>.
<code>${url}</code> is replaced with the current URL, escaped to be safe in a query parameter.
<code>${query}</code> is replaced with the current query string.
If this attribute is not defined, then <code>challengeURL</code> must be used.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing a PEM-encoded
certificate bundle. Used as a trust anchor to validate the TLS
certificates presented by the remote server.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>As of OpenShift Container Platform 4.1, the <code>ca</code> field is required for this identity
provider. This means that your proxy must support mutual TLS.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Optional: list of common names (<code>cn</code>). If set, a valid client certificate with
a Common Name (<code>cn</code>) in the specified list must be presented before the request headers
are checked for user names. If empty, any Common Name is allowed. Can only be used in combination
with <code>ca</code>.</p>
</li>
<li>
<p>Header names to check, in order, for the user identity. The first header containing
a value is used as the identity. Required, case-insensitive.</p>
</li>
<li>
<p>Header names to check, in order, for an email address. The first header containing
a value is used as the email address. Optional, case-insensitive.</p>
</li>
<li>
<p>Header names to check, in order, for a display name. The first header containing
a value is used as the display name. Optional, case-insensitive.</p>
</li>
<li>
<p>Header names to check, in order, for a preferred user name, if different than the immutable
identity determined from the headers specified in <code>headers</code>. The first header containing
a value is used as the preferred user name when provisioning. Optional, case-insensitive.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-request-header-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="example-apache-auth-config-using-request-header">Example Apache authentication configuration using request header</h4>
<div class="paragraph">
<p>This example configures an Apache authentication proxy for the OpenShift Container Platform
using the request header identity provider.</p>
</div>
<h5 id="identity-provider-apache-custom-proxy-configuration_configuring-request-header-identity-provider" class="discrete">Custom proxy configuration</h5>
<div class="paragraph">
<p>Using the <code>mod_auth_gssapi</code> module is a popular way to configure the Apache
authentication proxy using the request header identity provider; however, it is
not required. Other proxies can easily be used if the following requirements are
met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Block the <code>X-Remote-User</code> header from client requests to prevent spoofing.</p>
</li>
<li>
<p>Enforce client certificate authentication in the <code>RequestHeaderIdentityProvider</code>
configuration.</p>
</li>
<li>
<p>Require the <code>X-Csrf-Token</code> header be set for all authentication requests using
the challenge flow.</p>
</li>
<li>
<p>Make sure only the <code>/oauth/authorize</code> endpoint and its subpaths are proxied;
redirects must be rewritten to allow the backend server to send the client to
the correct location.</p>
</li>
<li>
<p>The URL that proxies to <code>https://&lt;namespace_route&gt;/oauth/authorize</code> must end
with <code>/authorize</code> with no trailing slash. For example, <code>https://proxy.example.com/login-proxy/authorize?&#8230;&#8203;</code>
must proxy to <code>https://&lt;namespace_route&gt;/oauth/authorize?&#8230;&#8203;</code>.</p>
</li>
<li>
<p>Subpaths of the URL that proxies to <code>https://&lt;namespace_route&gt;/oauth/authorize</code>
must proxy to subpaths of <code>https://&lt;namespace_route&gt;/oauth/authorize</code>. For
example, <code>https://proxy.example.com/login-proxy/authorize/approve?&#8230;&#8203;</code> must
proxy to <code>https://&lt;namespace_route&gt;/oauth/authorize/approve?&#8230;&#8203;</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>https://&lt;namespace_route&gt;</code> address is the route to the OAuth server and
can be obtained by running <code>oc get route -n openshift-authentication</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="identity-provider-configuring-apache-request-header_configuring-request-header-identity-provider" class="discrete">Configuring Apache authentication using request header</h5>
<div class="paragraph">
<p>This example uses the <code>mod_auth_gssapi</code> module to configure an Apache
authentication proxy using the request header identity provider.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Obtain the <code>mod_auth_gssapi</code> module from the
<a href="https://access.redhat.com/solutions/392003">Optional channel</a>.
You must have the following packages installed on your local machine:</p>
<div class="ulist">
<ul>
<li>
<p><code>httpd</code></p>
</li>
<li>
<p><code>mod_ssl</code></p>
</li>
<li>
<p><code>mod_session</code></p>
</li>
<li>
<p><code>apr-util-openssl</code></p>
</li>
<li>
<p><code>mod_auth_gssapi</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Generate a CA for validating requests that submit the trusted header. Define
an OpenShift Container Platform <code>ConfigMap</code> object containing the CA. This is done by running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The CA must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Generate a client certificate for the proxy. You can generate this certificate
by using any x509 certificate tooling. The client certificate must be signed by
the CA you generated for validating requests that submit the trusted header.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>This proxy uses a client certificate to connect to the OAuth server, which
is configured to trust the <code>X-Remote-User</code> header.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the certificate for the Apache configuration. The certificate that you
specify as the <code>SSLProxyMachineCertificateFile</code> parameter value is the proxy&#8217;s
client certificate that is used to authenticate the proxy to the server. It must
use <code>TLS Web Client Authentication</code> as the extended key type.</p>
</li>
<li>
<p>Create the Apache configuration. Use the following template to provide your
required settings and values:</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Carefully review the template and customize its contents to fit your
environment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">LoadModule request_module modules/mod_request.so
LoadModule auth_gssapi_module modules/mod_auth_gssapi.so
# Some Apache configurations might require these modules.
# LoadModule auth_form_module modules/mod_auth_form.so
# LoadModule session_module modules/mod_session.so

# Nothing needs to be served over HTTP.  This virtual host simply redirects to
# HTTPS.
&lt;VirtualHost *:80&gt;
  DocumentRoot /var/www/html
  RewriteEngine              On
  RewriteRule     ^(.*)$     https://%{HTTP_HOST}$1 [R,L]
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
  # This needs to match the certificates you generated.  See the CN and X509v3
  # Subject Alternative Name in the output of:
  # openssl x509 -text -in /etc/pki/tls/certs/localhost.crt
  ServerName www.example.com

  DocumentRoot /var/www/html
  SSLEngine on
  SSLCertificateFile /etc/pki/tls/certs/localhost.crt
  SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
  SSLCACertificateFile /etc/pki/CA/certs/ca.crt

  SSLProxyEngine on
  SSLProxyCACertificateFile /etc/pki/CA/certs/ca.crt
  # It is critical to enforce client certificates. Otherwise, requests can
  # spoof the X-Remote-User header by accessing the /oauth/authorize endpoint
  # directly.
  SSLProxyMachineCertificateFile /etc/pki/tls/certs/authproxy.pem

  # To use the challenging-proxy, an X-Csrf-Token must be present.
  RewriteCond %{REQUEST_URI} ^/challenging-proxy
  RewriteCond %{HTTP:X-Csrf-Token} ^$ [NC]
  RewriteRule ^.* - [F,L]

  &lt;Location /challenging-proxy/oauth/authorize&gt;
      # Insert your backend server name/ip here.
      ProxyPass https://&lt;namespace_route&gt;/oauth/authorize
      AuthName "SSO Login"
      # For Kerberos
      AuthType GSSAPI
      Require valid-user
      RequestHeader set X-Remote-User %{REMOTE_USER}s

      GssapiCredStore keytab:/etc/httpd/protected/auth-proxy.keytab
      # Enable the following if you want to allow users to fallback
      # to password based authentication when they do not have a client
      # configured to perform kerberos authentication.
      GssapiBasicAuth On

      # For ldap:
      # AuthBasicProvider ldap
      # AuthLDAPURL "ldap://ldap.example.com:389/ou=People,dc=my-domain,dc=com?uid?sub?(objectClass=*)"
    &lt;/Location&gt;

    &lt;Location /login-proxy/oauth/authorize&gt;
    # Insert your backend server name/ip here.
    ProxyPass https://&lt;namespace_route&gt;/oauth/authorize

      AuthName "SSO Login"
      AuthType GSSAPI
      Require valid-user
      RequestHeader set X-Remote-User %{REMOTE_USER}s env=REMOTE_USER

      GssapiCredStore keytab:/etc/httpd/protected/auth-proxy.keytab
      # Enable the following if you want to allow users to fallback
      # to password based authentication when they do not have a client
      # configured to perform kerberos authentication.
      GssapiBasicAuth On

      ErrorDocument 401 /login.html
    &lt;/Location&gt;

&lt;/VirtualHost&gt;

RequestHeader unset X-Remote-User</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>https://&lt;namespace_route&gt;</code> address is the route to the OAuth server and
can be obtained by running <code>oc get route -n openshift-authentication</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Update the <code>identityProviders</code> stanza in the custom resource (CR):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">identityProviders:
  - name: requestheaderidp
    type: RequestHeader
    requestHeader:
      challengeURL: "https://&lt;namespace_route&gt;/challenging-proxy/oauth/authorize?${query}"
      loginURL: "https://&lt;namespace_route&gt;/login-proxy/oauth/authorize?${query}"
      ca:
        name: ca-config-map
        clientCommonNames:
        - my-auth-proxy
        headers:
        - X-Remote-User</code></pre>
</div>
</div>
</li>
<li>
<p>Verify the configuration.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Confirm that you can bypass the proxy by requesting a token by supplying the
correct client certificate and header:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># curl -L -k -H "X-Remote-User: joe" \
   --cert /etc/pki/tls/certs/authproxy.pem \
   https://&lt;namespace_route&gt;/oauth/token/request</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that requests that do not supply the client certificate fail by
requesting a token without the certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># curl -L -k -H "X-Remote-User: joe" \
   https://&lt;namespace_route&gt;/oauth/token/request</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the <code>challengeURL</code> redirect is active:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># curl -k -v -H 'X-Csrf-Token: 1' \
   https://&lt;namespace_route&gt;/oauth/authorize?client_id=openshift-challenging-client&amp;response_type=token</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <code>challengeURL</code> redirect to use in the next step.</p>
</div>
</li>
<li>
<p>Run this command to show a <code>401</code> response with a <code>WWW-Authenticate</code> basic
challenge, a negotiate challenge, or both challenges:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># curl -k -v -H 'X-Csrf-Token: 1' \
   &lt;challengeURL_redirect + query&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Test logging in to the OpenShift CLI (<code>oc</code>) with and without using a Kerberos
ticket:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If you generated a Kerberos ticket by using <code>kinit</code>, destroy it:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># kdestroy -c cache_name <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Make sure to provide the name of your Kerberos cache.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Log in to the <code>oc</code> tool by using your Kerberos credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># oc login -u &lt;username&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter your Kerberos password at the prompt.</p>
</div>
</li>
<li>
<p>Log out of the <code>oc</code> tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># oc logout</code></pre>
</div>
</div>
</li>
<li>
<p>Use your Kerberos credentials to get a ticket:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># kinit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter your Kerberos user name and password at the prompt.</p>
</div>
</li>
<li>
<p>Confirm that you can log in to the <code>oc</code> tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal"># oc login</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your configuration is correct, you are logged in without entering separate
credentials.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-github-identity-provider">Configuring a GitHub or GitHub Enterprise identity provider</h3>
<div class="paragraph">
<p>Configure the <code>github</code> identity provider to validate user names and passwords against GitHub or GitHub Enterprise&#8217;s OAuth authentication server. OAuth facilitates a token exchange flow between OpenShift Container Platform and GitHub or GitHub Enterprise.</p>
</div>
<div class="paragraph">
<p>You can use the GitHub integration to connect to either GitHub or GitHub Enterprise. For GitHub Enterprise integrations, you must provide the <code>hostname</code> of your instance and can optionally provide a <code>ca</code> certificate bundle to use in requests to the server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The following steps apply to both GitHub and GitHub Enterprise unless noted.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-github-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-github-about_configuring-github-identity-provider">About GitHub authentication</h4>
<div class="paragraph">
<p>Configuring <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/authorizing-oauth-apps">GitHub authentication</a> allows users to log in to OpenShift Container Platform with their GitHub credentials. To prevent anyone with any GitHub user ID from logging in to your OpenShift Container Platform cluster, you can restrict access to only those in specific GitHub organizations.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-registering-github_configuring-github-identity-provider">Registering a GitHub application</h4>
<div class="paragraph">
<p>To use GitHub or GitHub Enterprise as an identity provider, you must register
an application to use.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Register an application on GitHub:</p>
<div class="ulist">
<ul>
<li>
<p>For GitHub, click <a href="https://github.com/settings/profile"><strong>Settings</strong></a> &#8594;
<a href="https://github.com/settings/apps"><strong>Developer settings</strong></a> &#8594;
<a href="https://github.com/settings/developers"><strong>OAuth Apps</strong></a> &#8594;
<a href="https://github.com/settings/applications/new"><strong>Register a new OAuth application</strong></a>.</p>
</li>
<li>
<p>For GitHub Enterprise, go to your GitHub Enterprise home page and then click
<strong>Settings &#8594; Developer settings &#8594; Register a new application</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enter an application name, for example <code>My OpenShift Install</code>.</p>
</li>
<li>
<p>Enter a homepage URL, such as
<code>https://oauth-openshift.apps.&lt;cluster-name&gt;.&lt;cluster-domain&gt;</code>.</p>
</li>
<li>
<p>Optional: Enter an application description.</p>
</li>
<li>
<p>Enter the authorization callback URL, where the end of the URL contains the
identity provider <code>name</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://oauth-openshift.apps.&lt;cluster-name&gt;.&lt;cluster-domain&gt;/oauth2callback/&lt;idp-provider-name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://oauth-openshift.apps.openshift-cluster.example.com/oauth2callback/github</pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Register application</strong>. GitHub provides a client ID and a client secret.
You need these values to complete the identity provider configuration.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret_configuring-github-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object containing a string by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-literal=clientSecret=&lt;secret&gt; -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: Opaque
data:
  clientSecret: &lt;base64_encoded_client_secret&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can define a <code>Secret</code> object containing the contents of a file, such as a certificate file, by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-file=&lt;path_to_file&gt; -n openshift-config</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-github-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This procedure is only required for GitHub Enterprise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-github-CR_configuring-github-identity-provider">Sample GitHub CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for a
GitHub identity provider.</p>
</div>
<div class="listingblock">
<div class="title">GitHub CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: githubidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: GitHub
    github:
      ca: <b class="conum">(3)</b>
        name: ca-config-map
      clientID: {...} <b class="conum">(4)</b>
      clientSecret: <b class="conum">(5)</b>
        name: github-secret
      hostname: ... <b class="conum">(6)</b>
      organizations: <b class="conum">(7)</b>
      - myorganization1
      - myorganization2
      teams: <b class="conum">(8)</b>
      - myorganization1/team-a
      - myorganization2/team-b</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the GitHub numeric user ID to form an
identity name. It is also used to build the callback URL.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing the
PEM-encoded certificate authority bundle to use in validating server
certificates for the configured URL. Only for use in GitHub Enterprise
with a non-publicly trusted root certificate.</p>
</li>
<li>
<p>The client ID of a
<a href="https://github.com/settings/applications/new">registered GitHub OAuth
application</a>. The application must be configured with a callback URL of
<code>https://oauth-openshift.apps.&lt;cluster-name&gt;.&lt;cluster-domain&gt;/oauth2callback/&lt;idp-provider-name&gt;</code>.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>Secret</code> object containing the client secret
issued by GitHub.</p>
</li>
<li>
<p>For GitHub Enterprise, you must provide the hostname of your instance, such as
<code>example.com</code>. This value must match the GitHub Enterprise <code>hostname</code> value in
in the <code>/setup/settings</code> file and cannot include a port number. If this
value is not set, then either <code>teams</code> or <code>organizations</code> must be defined.
For GitHub, omit this parameter.</p>
</li>
<li>
<p>The list of organizations. Either the <code>organizations</code> or <code>teams</code> field must be set unless the <code>hostname</code> field is set, or if <code>mappingMethod</code> is set to <code>lookup</code>. Cannot be used in combination with the <code>teams</code> field.</p>
</li>
<li>
<p>The list of teams. Either the <code>teams</code> or <code>organizations</code> field must be set unless the <code>hostname</code> field is set, or if <code>mappingMethod</code> is set to <code>lookup</code>. Cannot be used in combination with the <code>organizations</code> field.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>organizations</code> or <code>teams</code> is specified, only GitHub users that are members of
at least one of the listed organizations will be allowed to log in. If the GitHub OAuth
application configured in <code>clientID</code> is not owned by the organization, an organization
owner must grant third-party access to use this option. This can be done during
the first GitHub login by the organization&#8217;s administrator, or from the GitHub organization settings.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-github-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Obtain a token from the OAuth server.</p>
<div class="paragraph">
<p>As long as the <code>kubeadmin</code> user has been removed, the <code>oc login</code> command provides instructions on how to access a web page where you can retrieve the token.</p>
</div>
<div class="paragraph">
<p>You can also access this page from the web console by navigating to <strong>(?) Help</strong> &#8594; <strong>Command Line Tools</strong> &#8594; <strong>Copy Login Command</strong>.</p>
</div>
</li>
<li>
<p>Log in to the cluster, passing in the token to authenticate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login --token=&lt;token&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This identity provider does not support logging in with a user name and password.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-gitlab-identity-provider">Configuring a GitLab identity provider</h3>
<div class="paragraph">
<p>Configure the <code>gitlab</code> identity provider using <a href="https://gitlab.com/">GitLab.com</a> or any other GitLab instance as an identity provider.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-gitlab-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-gitlab-about_configuring-gitlab-identity-provider">About GitLab authentication</h4>
<div class="paragraph">
<p>Configuring GitLab authentication allows users to log in to OpenShift Container Platform with their GitLab credentials.</p>
</div>
<div class="paragraph">
<p>If you use GitLab version 7.7.0 to 11.0, you connect using the <a href="http://doc.gitlab.com/ce/integration/oauth_provider.html">OAuth integration</a>. If you use GitLab version 11.1 or later, you can use <a href="https://docs.gitlab.com/ce/integration/openid_connect_provider.html">OpenID Connect</a> (OIDC) to connect instead of OAuth.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret_configuring-gitlab-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object containing a string by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-literal=clientSecret=&lt;secret&gt; -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: Opaque
data:
  clientSecret: &lt;base64_encoded_client_secret&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can define a <code>Secret</code> object containing the contents of a file, such as a certificate file, by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-file=&lt;path_to_file&gt; -n openshift-config</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-gitlab-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This procedure is only required for GitHub Enterprise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-gitlab-CR_configuring-gitlab-identity-provider">Sample GitLab CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable values for a
GitLab identity provider.</p>
</div>
<div class="listingblock">
<div class="title">GitLab CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: gitlabidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: GitLab
    gitlab:
      clientID: {...} <b class="conum">(3)</b>
      clientSecret: <b class="conum">(4)</b>
        name: gitlab-secret
      url: https://gitlab.com <b class="conum">(5)</b>
      ca: <b class="conum">(6)</b>
        name: ca-config-map</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the GitLab numeric user ID to form an
identity name. It is also used to build the callback URL.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>The client ID of a
<a href="https://docs.gitlab.com/ce/api/oauth2.html">registered GitLab OAuth application</a>.
The application must be configured with a callback URL of
<code>https://oauth-openshift.apps.&lt;cluster-name&gt;.&lt;cluster-domain&gt;/oauth2callback/&lt;idp-provider-name&gt;</code>.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>Secret</code> object containing the client secret
issued by GitLab.</p>
</li>
<li>
<p>The host URL of a GitLab provider. This could either be <code>https://gitlab.com/</code>
or any other self hosted instance of GitLab.</p>
</li>
<li>
<p>Optional: Reference to an OpenShift Container Platform <code>ConfigMap</code> object containing the
PEM-encoded certificate authority bundle to use in validating server
certificates for the configured URL.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-gitlab-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Log in to the cluster as a user from your identity provider, entering the
password when prompted.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-google-identity-provider">Configuring a Google identity provider</h3>
<div class="paragraph">
<p>Configure the <code>google</code> identity provider using the <a href="https://developers.google.com/identity/protocols/OpenIDConnect">Google OpenID Connect integration</a>.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-google-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-google-about_configuring-google-identity-provider">About Google authentication</h4>
<div class="paragraph">
<p>Using Google as an identity provider allows any Google user to authenticate to your server. You can limit authentication to members of a specific hosted domain with the <code>hostedDomain</code> configuration attribute.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using Google as an identity provider requires users to get a token using <code>&lt;namespace_route&gt;/oauth/token/request</code> to use with command-line tools.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret_configuring-google-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object containing a string by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-literal=clientSecret=&lt;secret&gt; -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: Opaque
data:
  clientSecret: &lt;base64_encoded_client_secret&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can define a <code>Secret</code> object containing the contents of a file, such as a certificate file, by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-file=&lt;path_to_file&gt; -n openshift-config</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-google-CR_configuring-google-identity-provider">Sample Google CR</h4>
<div class="paragraph">
<p>The following custom resource (CR) shows the parameters and acceptable
values for a Google identity provider.</p>
</div>
<div class="listingblock">
<div class="title">Google CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: googleidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: Google
    google:
      clientID: {...} <b class="conum">(3)</b>
      clientSecret: <b class="conum">(4)</b>
        name: google-secret
      hostedDomain: "example.com" <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the Google numeric user ID to form an
identity name. It is also used to build the redirect URL.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>The client ID of a <a href="https://console.developers.google.com/">registered
Google project</a>. The project must be configured with a redirect URI of
<code>https://oauth-openshift.apps.&lt;cluster-name&gt;.&lt;cluster-domain&gt;/oauth2callback/&lt;idp-provider-name&gt;</code>.</p>
</li>
<li>
<p>Reference to an OpenShift Container Platform <code>Secret</code> object containing the client secret
issued by Google.</p>
</li>
<li>
<p>A
<a href="https://developers.google.com/identity/protocols/OpenIDConnect#hd-param">hosted domain</a>
used to restrict sign-in accounts. Optional if the <code>lookup</code> <code>mappingMethod</code>
is used. If empty, any Google account is allowed to authenticate.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-google-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Obtain a token from the OAuth server.</p>
<div class="paragraph">
<p>As long as the <code>kubeadmin</code> user has been removed, the <code>oc login</code> command provides instructions on how to access a web page where you can retrieve the token.</p>
</div>
<div class="paragraph">
<p>You can also access this page from the web console by navigating to <strong>(?) Help</strong> &#8594; <strong>Command Line Tools</strong> &#8594; <strong>Copy Login Command</strong>.</p>
</div>
</li>
<li>
<p>Log in to the cluster, passing in the token to authenticate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login --token=&lt;token&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This identity provider does not support logging in with a user name and password.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-oidc-identity-provider">Configuring an OpenID Connect identity provider</h3>
<div class="paragraph">
<p>Configure the <code>oidc</code> identity provider to integrate with an OpenID Connect identity provider using an <a href="http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code Flow</a>.</p>
</div>
<div class="sect3">
<h4 id="identity-provider-overview_configuring-oidc-identity-provider">About identity providers in OpenShift Container Platform</h4>
<div class="paragraph">
<p>By default, only a <code>kubeadmin</code> user exists on your cluster. To specify an
identity provider, you must create a custom resource (CR) that describes
that identity provider and add it to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OpenShift Container Platform user names containing <code>/</code>, <code>:</code>, and <code>%</code> are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-oidc-about_configuring-oidc-identity-provider">About OpenID Connect authentication</h4>
<div class="paragraph">
<p>The Authentication Operator in OpenShift Container Platform requires that the configured OpenID Connect identity provider implements the <a href="https://openid.net/specs/openid-connect-discovery-1_0.html">OpenID Connect Discovery</a> specification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>ID Token</code> and <code>UserInfo</code> decryptions are not supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, the <code>openid</code> scope is requested. If required, extra scopes can be specified in the <code>extraScopes</code> field.</p>
</div>
<div class="paragraph">
<p>Claims are read from the JWT <code>id_token</code> returned from the OpenID identity provider and, if specified, from the JSON returned by the <code>UserInfo</code> URL.</p>
</div>
<div class="paragraph">
<p>At least one claim must be configured to use as the user&#8217;s identity. The standard identity claim is <code>sub</code>.</p>
</div>
<div class="paragraph">
<p>You can also indicate which claims to use as the user&#8217;s preferred user name, display name, and email address. If multiple claims are specified, the first one with a non-empty value is used. The following table lists the standard claims:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Claim</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sub</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short for "subject identifier." The remote identity for the user at the
issuer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>preferred_username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The preferred user name when provisioning a user. A shorthand name that the user wants to be referred to as, such as <code>janedoe</code>. Typically a value that corresponding to the user&#8217;s login or username in the authentication system, such as username or email.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>email</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Email address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <a href="http://openid.net/specs/openid-connect-core-1_0.html#StandardClaims">OpenID claims documentation</a> for more information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Unless your OpenID Connect identity provider supports the resource owner password credentials (ROPC) grant flow, users must get a token from <code>&lt;namespace_route&gt;/oauth/token/request</code> to use with command-line tools.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-oidc-supported_configuring-oidc-identity-provider">Supported OIDC providers</h4>
<div class="paragraph">
<p>Red Hat tests and supports specific OpenID Connect (OIDC) providers with OpenShift Container Platform. The following OpenID Connect (OIDC) providers are tested and supported with OpenShift Container Platform. Using an OIDC provider that is not on the following list might work with OpenShift Container Platform, but the provider was not tested by Red Hat and therefore is not supported by Red Hat.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Active Directory Federation Services for Windows Server</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, it is not supported to use Active Directory Federation Services for Windows Server with OpenShift Container Platform when custom claims are used.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>GitLab</p>
</li>
<li>
<p>Google</p>
</li>
<li>
<p>Keycloak</p>
</li>
<li>
<p>Microsoft identity platform (Azure Active Directory v2.0)</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, it is not supported to use Microsoft identity platform when group names are required to be synced.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Okta</p>
</li>
<li>
<p>Ping Identity</p>
</li>
<li>
<p>Red Hat Single Sign-On</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-secret_configuring-oidc-identity-provider">Creating the secret</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>Secret</code> objects in the <code>openshift-config</code> namespace to contain the client secret, client certificates, and keys.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create a <code>Secret</code> object containing a string by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-literal=clientSecret=&lt;secret&gt; -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;secret_name&gt;
  namespace: openshift-config
type: Opaque
data:
  clientSecret: &lt;base64_encoded_client_secret&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can define a <code>Secret</code> object containing the contents of a file, such as a certificate file, by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create secret generic &lt;secret_name&gt; --from-file=&lt;path_to_file&gt; -n openshift-config</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-creating-configmap_configuring-oidc-identity-provider">Creating a config map</h4>
<div class="paragraph">
<p>Identity providers use OpenShift Container Platform <code>ConfigMap</code> objects in the <code>openshift-config</code>
namespace to contain the certificate authority bundle. These are primarily
used to contain certificate bundles needed by the identity provider.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This procedure is only required for GitHub Enterprise.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define an OpenShift Container Platform <code>ConfigMap</code> object containing the
certificate authority by using the following command. The certificate
authority must be stored in the <code>ca.crt</code> key of the <code>ConfigMap</code> object.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create configmap ca-config-map --from-file=ca.crt=/path/to/ca -n openshift-config</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the config map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    &lt;CA_certificate_PEM&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-oidc-CR_configuring-oidc-identity-provider">Sample OpenID Connect CRs</h4>
<div class="paragraph">
<p>The following custom resources (CRs) show the parameters and acceptable values for an OpenID Connect identity provider.</p>
</div>
<div class="paragraph">
<p>If you must specify a custom certificate bundle, extra scopes, extra authorization request parameters, or a <code>userInfo</code> URL, use the full OpenID Connect CR.</p>
</div>
<div class="listingblock">
<div class="title">Standard OpenID Connect CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: oidcidp <b class="conum">(1)</b>
    mappingMethod: claim <b class="conum">(2)</b>
    type: OpenID
    openID:
      clientID: ... <b class="conum">(3)</b>
      clientSecret: <b class="conum">(4)</b>
        name: idp-secret
      claims: <b class="conum">(5)</b>
        preferredUsername:
        - preferred_username
        name:
        - name
        email:
        - email
        groups:
        - groups
      issuer: https://www.idp-issuer.com <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This provider name is prefixed to the value of the identity claim to form an identity name. It is also used to build the redirect URL.</p>
</li>
<li>
<p>Controls how mappings are established between this provider&#8217;s identities and <code>User</code> objects.</p>
</li>
<li>
<p>The client ID of a client registered with the OpenID provider. The client must be allowed to redirect to <code>https://oauth-openshift.apps.&lt;cluster_name&gt;.&lt;cluster_domain&gt;/oauth2callback/&lt;idp_provider_name&gt;</code>.</p>
</li>
<li>
<p>A reference to an OpenShift Container Platform <code>Secret</code> object containing the client secret.</p>
</li>
<li>
<p>The list of claims to use as the identity. The first non-empty claim is used.</p>
</li>
<li>
<p>The <a href="https://openid.net/specs/openid-connect-core-1_0.html#IssuerIdentifier">Issuer Identifier</a> described in the OpenID spec. Must use <code>https</code> without query or fragment component.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Full OpenID Connect CR</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: oidcidp
    mappingMethod: claim
    type: OpenID
    openID:
      clientID: ...
      clientSecret:
        name: idp-secret
      ca: <b class="conum">(1)</b>
        name: ca-config-map
      extraScopes: <b class="conum">(2)</b>
      - email
      - profile
      extraAuthorizeParameters: <b class="conum">(3)</b>
        include_granted_scopes: "true"
      claims:
        preferredUsername: <b class="conum">(4)</b>
        - preferred_username
        - email
        name: <b class="conum">(5)</b>
        - nickname
        - given_name
        - name
        email: <b class="conum">(6)</b>
        - custom_email_claim
        - email
        groups: <b class="conum">(7)</b>
        - groups
      issuer: https://www.idp-issuer.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Optional: Reference to an OpenShift Container Platform config map containing the PEM-encoded certificate authority bundle to use in validating server certificates for the configured URL.</p>
</li>
<li>
<p>Optional: The list of scopes to request, in addition to the <code>openid</code> scope, during the authorization token request.</p>
</li>
<li>
<p>Optional: A map of extra parameters to add to the authorization token request.</p>
</li>
<li>
<p>The list of claims to use as the preferred user name when provisioning a user
for this identity. The first non-empty claim is used.</p>
</li>
<li>
<p>The list of claims to use as the display name. The first non-empty claim is used.</p>
</li>
<li>
<p>The list of claims to use as the email address. The first non-empty claim is used.</p>
</li>
<li>
<p>The list of claims to use to synchronize groups from the OpenID Connect provider to OpenShift Container Platform upon user login. The first non-empty claim is used.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See <a href="#identity-provider-parameters_understanding-identity-provider">Identity provider parameters</a> for information on parameters, such as <code>mappingMethod</code>, that are common to all identity providers.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="add-identity-provider_configuring-oidc-identity-provider">Adding an identity provider to your cluster</h4>
<div class="paragraph">
<p>After you install your cluster, add an identity provider to it so your
users can authenticate.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Create the custom resource (CR) for your identity providers.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the defined CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc apply -f &lt;/path/to/CR&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a CR does not exist, <code>oc apply</code> creates a new CR and might trigger the following warning: <code>Warning: oc apply should be used on resources created by either oc create --save-config or oc apply</code>. In this case you can safely ignore this warning.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Obtain a token from the OAuth server.</p>
<div class="paragraph">
<p>As long as the <code>kubeadmin</code> user has been removed, the <code>oc login</code> command provides instructions on how to access a web page where you can retrieve the token.</p>
</div>
<div class="paragraph">
<p>You can also access this page from the web console by navigating to <strong>(?) Help</strong> &#8594; <strong>Command Line Tools</strong> &#8594; <strong>Copy Login Command</strong>.</p>
</div>
</li>
<li>
<p>Log in to the cluster, passing in the token to authenticate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login --token=&lt;token&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If your OpenID Connect identity provider supports the resource owner password credentials (ROPC) grant flow, you can log in with a user name and password. You might need to take steps to enable the ROPC grant flow for your identity provider.</p>
</div>
<div class="paragraph">
<p>After the OIDC identity provider is configured in OpenShift Container Platform, you can log in by using the following command, which prompts for your user name and password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc login -u &lt;identity_provider_username&gt; --server=&lt;api_server_url_and_port&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Confirm that the user logged in successfully, and display the user name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc whoami</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="identity-provider-configuring-using-the-web-console_configuring-oidc-identity-provider">Configuring identity providers using the web console</h4>
<div class="paragraph">
<p>Configure your identity provider (IDP) through the web console instead of the CLI.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must be logged in to the web console as a cluster administrator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to <strong>Administration</strong> &#8594; <strong>Cluster Settings</strong>.</p>
</li>
<li>
<p>Under the <strong>Configuration</strong> tab, click <strong>OAuth</strong>.</p>
</li>
<li>
<p>Under the <strong>Identity Providers</strong> section, select your identity provider from the
<strong>Add</strong> drop-down menu.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can specify multiple IDPs through the web console without overwriting
existing IDPs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-rbac">Using RBAC to define and apply permissions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="authorization-overview_using-rbac">RBAC overview</h3>
<div class="paragraph">
<p>Role-based access control (RBAC) objects determine whether a user is allowed to
perform a given action within a project.</p>
</div>
<div class="paragraph">
<p>Cluster
administrators can use the cluster roles and
bindings to control who has various access levels to the OpenShift Container Platform
platform itself and all projects.</p>
</div>
<div class="paragraph">
<p>Developers can use local roles and bindings to control who has access
to their projects. Note that authorization is a separate step from
authentication, which is more about determining the identity of who is taking the action.</p>
</div>
<div class="paragraph">
<p>Authorization is managed using:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Authorization object</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets of permitted verbs on a set of objects. For example,
whether a user or service account can <code>create</code> pods.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collections of rules. You can associate, or bind, users and groups
to multiple roles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bindings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associations between users and/or groups with a role.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are two levels of RBAC roles and bindings that control authorization:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">RBAC level</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster RBAC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles and bindings that are applicable across
all projects. <em>Cluster roles</em> exist cluster-wide, and <em>cluster role bindings</em>
can reference only cluster roles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local RBAC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roles and bindings that are scoped to a given project. While
<em>local roles</em> exist only in a single project, local role bindings can
reference <em>both</em> cluster and local roles.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A cluster role binding is a binding that exists at the cluster level.
A role binding exists at the project level. The cluster role <em>view</em> must be
bound to a user using a local role binding for that user to view the project.
Create local roles only if a cluster role does not provide the set
of permissions needed for a particular situation.</p>
</div>
<div class="paragraph">
<p>This two-level hierarchy allows reuse across multiple projects through the
cluster roles while allowing customization inside of individual projects
through local roles.</p>
</div>
<div class="paragraph">
<p>During evaluation, both the cluster role bindings and the local role bindings are used.
For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cluster-wide "allow" rules are checked.</p>
</li>
<li>
<p>Locally-bound "allow" rules are checked.</p>
</li>
<li>
<p>Deny by default.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="default-roles_using-rbac">Default cluster roles</h4>
<div class="paragraph">
<p>OpenShift Container Platform includes a set of default cluster roles that you can bind to users and groups cluster-wide or locally.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>It is not recommended to manually modify the default cluster roles. Modifications to these system roles can prevent a cluster from functioning properly.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Default cluster role</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A project manager. If used in a local binding, an <code>admin</code> has
rights to view any resource in the project and modify any resource in the
project except for quota.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>basic-user</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user that can get basic information about projects and users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A super-user that can perform any action in any project. When
bound to a user with a local binding, they have full control over quota and
every action on every resource in the project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user that can get basic cluster status information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-reader</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user that can get or view most of the objects but
cannot modify them.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>edit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user that can modify most objects in a project but does not have the
power to view or modify roles or bindings.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>self-provisioner</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user that can create their own projects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>view</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user who cannot make any modifications, but can see most objects in a
project. They cannot view or modify roles or bindings.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Be mindful of the difference between local and cluster bindings. For example,
if you bind the <code>cluster-admin</code> role to a user by using a local role binding,
it might appear that this user has the privileges of a cluster administrator.
This is not the case. Binding the <code>cluster-admin</code> to a user in a project
grants super administrator privileges for only that
project to the user. That user has the permissions of the cluster role
<code>admin</code>, plus a few additional permissions like the ability to edit rate limits,
for that project.
This binding can be confusing via the web console UI, which does not list
cluster role bindings that are bound to true cluster administrators. However, it
does list local role bindings that you can use to locally bind <code>cluster-admin</code>.</p>
</div>
<div class="paragraph">
<p>The relationships between cluster roles, local roles, cluster role bindings,
local role bindings, users, groups and service accounts are illustrated below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rbac.png" alt="OpenShift Container Platform RBAC">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>get pods/exec</code>, <code>get pods/*</code>, and <code>get *</code> rules grant execution privileges when they are applied to a role. Apply the principle of least privilege and assign only the minimal RBAC rights required for users and agents. For more information, see <a href="https://access.redhat.com/solutions/6989997">RBAC rules allow execution privileges</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="evaluating-authorization_using-rbac">Evaluating authorization</h4>
<div class="paragraph">
<p>OpenShift Container Platform evaluates authorization by using:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Identity</dt>
<dd>
<p>The user name and list of groups that the user belongs to.</p>
</dd>
<dt class="hdlist1">Action</dt>
<dd>
<p>The action you perform. In most cases, this consists of:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: The project you access. A project is a Kubernetes namespace with
additional annotations that allows a community of users to organize and manage
their content in isolation from other communities.</p>
</li>
<li>
<p><strong>Verb</strong> : The action itself:  <code>get</code>, <code>list</code>, <code>create</code>, <code>update</code>, <code>delete</code>, <code>deletecollection</code>, or <code>watch</code>.</p>
</li>
<li>
<p><strong>Resource name</strong>: The API endpoint that you access.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Bindings</dt>
<dd>
<p>The full list of bindings, the associations between users or groups
with a role.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>OpenShift Container Platform evaluates authorization by using the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The identity and the project-scoped action is used to find all bindings that
apply to the user or their groups.</p>
</li>
<li>
<p>Bindings are used to locate all the roles that apply.</p>
</li>
<li>
<p>Roles are used to find all the rules that apply.</p>
</li>
<li>
<p>The action is checked against each rule to find a match.</p>
</li>
<li>
<p>If no matching rule is found, the action is then denied by default.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that users and groups can be associated with, or bound to, multiple
roles at the same time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Project administrators can use the CLI to
view local roles and bindings,
including a matrix of the verbs and resources each are associated with.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>The cluster role bound to the project administrator is limited in a project
through a local binding.
It is not bound cluster-wide like the cluster roles granted to the
<strong>cluster-admin</strong> or <strong>system:admin</strong>.</p>
</div>
<div class="paragraph">
<p>Cluster roles are roles defined at the cluster level but can be bound either at
the cluster level or at the project level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="cluster-role-aggregations_using-rbac">Cluster role aggregation</h5>
<div class="paragraph">
<p>The default admin, edit, view, and cluster-reader cluster roles support
<a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles">cluster role aggregation</a>,
where the cluster rules for each role are dynamically updated as
new rules are created. This feature is relevant only if you extend the
Kubernetes API by creating custom resources.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rbac-projects-namespaces_using-rbac">Projects and namespaces</h3>
<div class="paragraph">
<p>A Kubernetes <em>namespace</em> provides a mechanism to scope resources in a cluster.
The
<a href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces/">Kubernetes documentation</a>
has more information on namespaces.</p>
</div>
<div class="paragraph">
<p>Namespaces provide a unique scope for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Named resources to avoid basic naming collisions.</p>
</li>
<li>
<p>Delegated management authority to trusted users.</p>
</li>
<li>
<p>The ability to limit community resource consumption.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most objects in the system are scoped by namespace, but some are
excepted and have no namespace, including nodes and users.</p>
</div>
<div class="paragraph">
<p>A <em>project</em> is a Kubernetes namespace with additional annotations and is the central vehicle
by which access to resources for regular users is managed.
A project allows a community of users to organize and manage their content in
isolation from other communities. Users must be given access to projects by administrators,
or if allowed to create projects, automatically have access to their own projects.</p>
</div>
<div class="paragraph">
<p>Projects can have a separate <code>name</code>, <code>displayName</code>, and <code>description</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The mandatory <code>name</code> is a unique identifier for the project and is most visible when using the CLI tools or API. The maximum name length is 63 characters.</p>
</li>
<li>
<p>The optional <code>displayName</code> is how the project is displayed in the web console (defaults to <code>name</code>).</p>
</li>
<li>
<p>The optional <code>description</code> can be a more detailed description of the project and is also visible in the web console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each project scopes its own set of:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Object</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Objects</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pods, services, replication controllers, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Policies</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rules for which users can or cannot perform actions on objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Constraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quotas for each kind of object that can be limited.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Service accounts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service accounts act automatically with designated access to objects in the project.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Cluster administrators can create projects and delegate administrative rights
for the project to any member of the user community. Cluster administrators can
also allow developers to create their own projects.</p>
</div>
<div class="paragraph">
<p>Developers and administrators can interact with projects by using the CLI or the
web console.</p>
</div>
</div>
<div class="sect2">
<h3 id="rbac-default-projects_using-rbac">Default projects</h3>
<div class="paragraph">
<p>OpenShift Container Platform comes with a number of default projects, and projects
starting with <code>openshift-</code> are the most essential to users.
These projects host master components that run as pods and other infrastructure
components. The pods created in these namespaces that have a
<a href="https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/#rescheduler-guaranteed-scheduling-of-critical-add-ons">critical pod annotation</a>
are considered critical, and the have guaranteed admission by kubelet.
Pods created for master components in these namespaces are already marked as
critical.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot assign an SCC to pods created in one of the default namespaces: <code>default</code>, <code>kube-system</code>, <code>kube-public</code>, <code>openshift-node</code>, <code>openshift-infra</code>, and <code>openshift</code>. You cannot use these namespaces for running pods or services.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="viewing-cluster-roles_using-rbac">Viewing cluster roles and bindings</h3>
<div class="paragraph">
<p>You can use the <code>oc</code> CLI to view cluster roles and bindings by using the
<code>oc describe</code> command.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install the <code>oc</code> CLI.</p>
</li>
<li>
<p>Obtain permission to view the cluster roles and bindings.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users with the <code>cluster-admin</code> default cluster role bound cluster-wide can
perform any action on any resource, including viewing cluster roles and bindings.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To view the cluster roles and their associated rule sets:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe clusterrole.rbac</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:         admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
PolicyRule:
  Resources                                                  Non-Resource URLs  Resource Names  Verbs
  ---------                                                  -----------------  --------------  -----
  .packages.apps.redhat.com                                  []                 []              [* create update patch delete get list watch]
  imagestreams                                               []                 []              [create delete deletecollection get list patch update watch create get list watch]
  imagestreams.image.openshift.io                            []                 []              [create delete deletecollection get list patch update watch create get list watch]
  secrets                                                    []                 []              [create delete deletecollection get list patch update watch get list watch create delete deletecollection patch update]
  buildconfigs/webhooks                                      []                 []              [create delete deletecollection get list patch update watch get list watch]
  buildconfigs                                               []                 []              [create delete deletecollection get list patch update watch get list watch]
  buildlogs                                                  []                 []              [create delete deletecollection get list patch update watch get list watch]
  deploymentconfigs/scale                                    []                 []              [create delete deletecollection get list patch update watch get list watch]
  deploymentconfigs                                          []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreamimages                                          []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreammappings                                        []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreamtags                                            []                 []              [create delete deletecollection get list patch update watch get list watch]
  processedtemplates                                         []                 []              [create delete deletecollection get list patch update watch get list watch]
  routes                                                     []                 []              [create delete deletecollection get list patch update watch get list watch]
  templateconfigs                                            []                 []              [create delete deletecollection get list patch update watch get list watch]
  templateinstances                                          []                 []              [create delete deletecollection get list patch update watch get list watch]
  templates                                                  []                 []              [create delete deletecollection get list patch update watch get list watch]
  deploymentconfigs.apps.openshift.io/scale                  []                 []              [create delete deletecollection get list patch update watch get list watch]
  deploymentconfigs.apps.openshift.io                        []                 []              [create delete deletecollection get list patch update watch get list watch]
  buildconfigs.build.openshift.io/webhooks                   []                 []              [create delete deletecollection get list patch update watch get list watch]
  buildconfigs.build.openshift.io                            []                 []              [create delete deletecollection get list patch update watch get list watch]
  buildlogs.build.openshift.io                               []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreamimages.image.openshift.io                       []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreammappings.image.openshift.io                     []                 []              [create delete deletecollection get list patch update watch get list watch]
  imagestreamtags.image.openshift.io                         []                 []              [create delete deletecollection get list patch update watch get list watch]
  routes.route.openshift.io                                  []                 []              [create delete deletecollection get list patch update watch get list watch]
  processedtemplates.template.openshift.io                   []                 []              [create delete deletecollection get list patch update watch get list watch]
  templateconfigs.template.openshift.io                      []                 []              [create delete deletecollection get list patch update watch get list watch]
  templateinstances.template.openshift.io                    []                 []              [create delete deletecollection get list patch update watch get list watch]
  templates.template.openshift.io                            []                 []              [create delete deletecollection get list patch update watch get list watch]
  serviceaccounts                                            []                 []              [create delete deletecollection get list patch update watch impersonate create delete deletecollection patch update get list watch]
  imagestreams/secrets                                       []                 []              [create delete deletecollection get list patch update watch]
  rolebindings                                               []                 []              [create delete deletecollection get list patch update watch]
  roles                                                      []                 []              [create delete deletecollection get list patch update watch]
  rolebindings.authorization.openshift.io                    []                 []              [create delete deletecollection get list patch update watch]
  roles.authorization.openshift.io                           []                 []              [create delete deletecollection get list patch update watch]
  imagestreams.image.openshift.io/secrets                    []                 []              [create delete deletecollection get list patch update watch]
  rolebindings.rbac.authorization.k8s.io                     []                 []              [create delete deletecollection get list patch update watch]
  roles.rbac.authorization.k8s.io                            []                 []              [create delete deletecollection get list patch update watch]
  networkpolicies.extensions                                 []                 []              [create delete deletecollection patch update create delete deletecollection get list patch update watch get list watch]
  networkpolicies.networking.k8s.io                          []                 []              [create delete deletecollection patch update create delete deletecollection get list patch update watch get list watch]
  configmaps                                                 []                 []              [create delete deletecollection patch update get list watch]
  endpoints                                                  []                 []              [create delete deletecollection patch update get list watch]
  persistentvolumeclaims                                     []                 []              [create delete deletecollection patch update get list watch]
  pods                                                       []                 []              [create delete deletecollection patch update get list watch]
  replicationcontrollers/scale                               []                 []              [create delete deletecollection patch update get list watch]
  replicationcontrollers                                     []                 []              [create delete deletecollection patch update get list watch]
  services                                                   []                 []              [create delete deletecollection patch update get list watch]
  daemonsets.apps                                            []                 []              [create delete deletecollection patch update get list watch]
  deployments.apps/scale                                     []                 []              [create delete deletecollection patch update get list watch]
  deployments.apps                                           []                 []              [create delete deletecollection patch update get list watch]
  replicasets.apps/scale                                     []                 []              [create delete deletecollection patch update get list watch]
  replicasets.apps                                           []                 []              [create delete deletecollection patch update get list watch]
  statefulsets.apps/scale                                    []                 []              [create delete deletecollection patch update get list watch]
  statefulsets.apps                                          []                 []              [create delete deletecollection patch update get list watch]
  horizontalpodautoscalers.autoscaling                       []                 []              [create delete deletecollection patch update get list watch]
  cronjobs.batch                                             []                 []              [create delete deletecollection patch update get list watch]
  jobs.batch                                                 []                 []              [create delete deletecollection patch update get list watch]
  daemonsets.extensions                                      []                 []              [create delete deletecollection patch update get list watch]
  deployments.extensions/scale                               []                 []              [create delete deletecollection patch update get list watch]
  deployments.extensions                                     []                 []              [create delete deletecollection patch update get list watch]
  ingresses.extensions                                       []                 []              [create delete deletecollection patch update get list watch]
  replicasets.extensions/scale                               []                 []              [create delete deletecollection patch update get list watch]
  replicasets.extensions                                     []                 []              [create delete deletecollection patch update get list watch]
  replicationcontrollers.extensions/scale                    []                 []              [create delete deletecollection patch update get list watch]
  poddisruptionbudgets.policy                                []                 []              [create delete deletecollection patch update get list watch]
  deployments.apps/rollback                                  []                 []              [create delete deletecollection patch update]
  deployments.extensions/rollback                            []                 []              [create delete deletecollection patch update]
  catalogsources.operators.coreos.com                        []                 []              [create update patch delete get list watch]
  clusterserviceversions.operators.coreos.com                []                 []              [create update patch delete get list watch]
  installplans.operators.coreos.com                          []                 []              [create update patch delete get list watch]
  packagemanifests.operators.coreos.com                      []                 []              [create update patch delete get list watch]
  subscriptions.operators.coreos.com                         []                 []              [create update patch delete get list watch]
  buildconfigs/instantiate                                   []                 []              [create]
  buildconfigs/instantiatebinary                             []                 []              [create]
  builds/clone                                               []                 []              [create]
  deploymentconfigrollbacks                                  []                 []              [create]
  deploymentconfigs/instantiate                              []                 []              [create]
  deploymentconfigs/rollback                                 []                 []              [create]
  imagestreamimports                                         []                 []              [create]
  localresourceaccessreviews                                 []                 []              [create]
  localsubjectaccessreviews                                  []                 []              [create]
  podsecuritypolicyreviews                                   []                 []              [create]
  podsecuritypolicyselfsubjectreviews                        []                 []              [create]
  podsecuritypolicysubjectreviews                            []                 []              [create]
  resourceaccessreviews                                      []                 []              [create]
  routes/custom-host                                         []                 []              [create]
  subjectaccessreviews                                       []                 []              [create]
  subjectrulesreviews                                        []                 []              [create]
  deploymentconfigrollbacks.apps.openshift.io                []                 []              [create]
  deploymentconfigs.apps.openshift.io/instantiate            []                 []              [create]
  deploymentconfigs.apps.openshift.io/rollback               []                 []              [create]
  localsubjectaccessreviews.authorization.k8s.io             []                 []              [create]
  localresourceaccessreviews.authorization.openshift.io      []                 []              [create]
  localsubjectaccessreviews.authorization.openshift.io       []                 []              [create]
  resourceaccessreviews.authorization.openshift.io           []                 []              [create]
  subjectaccessreviews.authorization.openshift.io            []                 []              [create]
  subjectrulesreviews.authorization.openshift.io             []                 []              [create]
  buildconfigs.build.openshift.io/instantiate                []                 []              [create]
  buildconfigs.build.openshift.io/instantiatebinary          []                 []              [create]
  builds.build.openshift.io/clone                            []                 []              [create]
  imagestreamimports.image.openshift.io                      []                 []              [create]
  routes.route.openshift.io/custom-host                      []                 []              [create]
  podsecuritypolicyreviews.security.openshift.io             []                 []              [create]
  podsecuritypolicyselfsubjectreviews.security.openshift.io  []                 []              [create]
  podsecuritypolicysubjectreviews.security.openshift.io      []                 []              [create]
  jenkins.build.openshift.io                                 []                 []              [edit view view admin edit view]
  builds                                                     []                 []              [get create delete deletecollection get list patch update watch get list watch]
  builds.build.openshift.io                                  []                 []              [get create delete deletecollection get list patch update watch get list watch]
  projects                                                   []                 []              [get delete get delete get patch update]
  projects.project.openshift.io                              []                 []              [get delete get delete get patch update]
  namespaces                                                 []                 []              [get get list watch]
  pods/attach                                                []                 []              [get list watch create delete deletecollection patch update]
  pods/exec                                                  []                 []              [get list watch create delete deletecollection patch update]
  pods/portforward                                           []                 []              [get list watch create delete deletecollection patch update]
  pods/proxy                                                 []                 []              [get list watch create delete deletecollection patch update]
  services/proxy                                             []                 []              [get list watch create delete deletecollection patch update]
  routes/status                                              []                 []              [get list watch update]
  routes.route.openshift.io/status                           []                 []              [get list watch update]
  appliedclusterresourcequotas                               []                 []              [get list watch]
  bindings                                                   []                 []              [get list watch]
  builds/log                                                 []                 []              [get list watch]
  deploymentconfigs/log                                      []                 []              [get list watch]
  deploymentconfigs/status                                   []                 []              [get list watch]
  events                                                     []                 []              [get list watch]
  imagestreams/status                                        []                 []              [get list watch]
  limitranges                                                []                 []              [get list watch]
  namespaces/status                                          []                 []              [get list watch]
  pods/log                                                   []                 []              [get list watch]
  pods/status                                                []                 []              [get list watch]
  replicationcontrollers/status                              []                 []              [get list watch]
  resourcequotas/status                                      []                 []              [get list watch]
  resourcequotas                                             []                 []              [get list watch]
  resourcequotausages                                        []                 []              [get list watch]
  rolebindingrestrictions                                    []                 []              [get list watch]
  deploymentconfigs.apps.openshift.io/log                    []                 []              [get list watch]
  deploymentconfigs.apps.openshift.io/status                 []                 []              [get list watch]
  controllerrevisions.apps                                   []                 []              [get list watch]
  rolebindingrestrictions.authorization.openshift.io         []                 []              [get list watch]
  builds.build.openshift.io/log                              []                 []              [get list watch]
  imagestreams.image.openshift.io/status                     []                 []              [get list watch]
  appliedclusterresourcequotas.quota.openshift.io            []                 []              [get list watch]
  imagestreams/layers                                        []                 []              [get update get]
  imagestreams.image.openshift.io/layers                     []                 []              [get update get]
  builds/details                                             []                 []              [update]
  builds.build.openshift.io/details                          []                 []              [update]


Name:         basic-user
Labels:       &lt;none&gt;
Annotations:  openshift.io/description: A user that can get basic information about projects.
	              rbac.authorization.kubernetes.io/autoupdate: true
PolicyRule:
	Resources                                           Non-Resource URLs  Resource Names  Verbs
	  ---------                                           -----------------  --------------  -----
	  selfsubjectrulesreviews                             []                 []              [create]
	  selfsubjectaccessreviews.authorization.k8s.io       []                 []              [create]
	  selfsubjectrulesreviews.authorization.openshift.io  []                 []              [create]
	  clusterroles.rbac.authorization.k8s.io              []                 []              [get list watch]
	  clusterroles                                        []                 []              [get list]
	  clusterroles.authorization.openshift.io             []                 []              [get list]
	  storageclasses.storage.k8s.io                       []                 []              [get list]
	  users                                               []                 [~]             [get]
	  users.user.openshift.io                             []                 [~]             [get]
	  projects                                            []                 []              [list watch]
	  projects.project.openshift.io                       []                 []              [list watch]
	  projectrequests                                     []                 []              [list]
	  projectrequests.project.openshift.io                []                 []              [list]

Name:         cluster-admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
PolicyRule:
Resources  Non-Resource URLs  Resource Names  Verbs
---------  -----------------  --------------  -----
*.*        []                 []              [*]
           [*]                []              [*]

...</code></pre>
</div>
</div>
</li>
<li>
<p>To view the current set of cluster role bindings, which shows the users and
groups that are bound to various roles:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe clusterrolebinding.rbac</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:         alertmanager-main
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  alertmanager-main
Subjects:
  Kind            Name               Namespace
  ----            ----               ---------
  ServiceAccount  alertmanager-main  openshift-monitoring


Name:         basic-users
Labels:       &lt;none&gt;
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  basic-user
Subjects:
  Kind   Name                  Namespace
  ----   ----                  ---------
  Group  system:authenticated


Name:         cloud-credential-operator-rolebinding
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  cloud-credential-operator-role
Subjects:
  Kind            Name     Namespace
  ----            ----     ---------
  ServiceAccount  default  openshift-cloud-credential-operator


Name:         cluster-admin
Labels:       kubernetes.io/bootstrapping=rbac-defaults
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  cluster-admin
Subjects:
  Kind   Name            Namespace
  ----   ----            ---------
  Group  system:masters


Name:         cluster-admins
Labels:       &lt;none&gt;
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  cluster-admin
Subjects:
  Kind   Name                   Namespace
  ----   ----                   ---------
  Group  system:cluster-admins
  User   system:admin


Name:         cluster-api-manager-rolebinding
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  cluster-api-manager-role
Subjects:
  Kind            Name     Namespace
  ----            ----     ---------
  ServiceAccount  default  openshift-machine-api

...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="viewing-local-roles_using-rbac">Viewing local roles and bindings</h3>
<div class="paragraph">
<p>You can use the <code>oc</code> CLI to view local roles and bindings by using the
<code>oc describe</code> command.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install the <code>oc</code> CLI.</p>
</li>
<li>
<p>Obtain permission to view the local roles and bindings:</p>
<div class="ulist">
<ul>
<li>
<p>Users with the <code>cluster-admin</code> default cluster role bound cluster-wide can
perform any action on any resource, including viewing local roles and bindings.</p>
</li>
<li>
<p>Users with the <code>admin</code> default cluster role bound locally can view and manage
roles and bindings in that project.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To view the current set of local role bindings, which show the users and groups
that are bound to various roles for the current project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe rolebinding.rbac</code></pre>
</div>
</div>
</li>
<li>
<p>To view the local role bindings for a different project, add the <code>-n</code> flag
to the command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe rolebinding.rbac -n joe-project</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:         admin
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  admin
Subjects:
  Kind  Name        Namespace
  ----  ----        ---------
  User  kube:admin


Name:         system:deployers
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows deploymentconfigs in this namespace to rollout pods in
                this namespace.  It is auto-managed by a controller; remove
                subjects to disa...
Role:
  Kind:  ClusterRole
  Name:  system:deployer
Subjects:
  Kind            Name      Namespace
  ----            ----      ---------
  ServiceAccount  deployer  joe-project


Name:         system:image-builders
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows builds in this namespace to push images to this
                namespace.  It is auto-managed by a controller; remove subjects
                to disable.
Role:
  Kind:  ClusterRole
  Name:  system:image-builder
Subjects:
  Kind            Name     Namespace
  ----            ----     ---------
  ServiceAccount  builder  joe-project


Name:         system:image-pullers
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows all pods in this namespace to pull images from this
                namespace.  It is auto-managed by a controller; remove subjects
                to disable.
Role:
  Kind:  ClusterRole
  Name:  system:image-puller
Subjects:
  Kind   Name                                Namespace
  ----   ----                                ---------
  Group  system:serviceaccounts:joe-project</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-roles_using-rbac">Adding roles to users</h3>
<div class="paragraph">
<p>You can use  the <code>oc adm</code> administrator CLI to manage the roles and bindings.</p>
</div>
<div class="paragraph">
<p>Binding, or adding, a role to users or groups gives the user or group the access
that is granted by the role. You can add and remove roles to and from users and
groups using <code>oc adm policy</code> commands.</p>
</div>
<div class="paragraph">
<p>You can bind any of the default cluster roles to local users or groups in your
project.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add a role to a user in a specific project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm policy add-role-to-user &lt;role&gt; &lt;user&gt; -n &lt;project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, you can add the <code>admin</code> role to the <code>alice</code> user in <code>joe</code> project
by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm policy add-role-to-user admin alice -n joe</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to add the role to the user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: admin-0
  namespace: joe
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: alice</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>View the local role bindings and verify the addition in the output:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe rolebinding.rbac -n &lt;project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, to view the local role bindings for the <code>joe</code> project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe rolebinding.rbac -n joe</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:         admin
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  admin
Subjects:
  Kind  Name        Namespace
  ----  ----        ---------
  User  kube:admin


Name:         admin-0
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  ClusterRole
  Name:  admin
Subjects:
  Kind  Name   Namespace
  ----  ----   ---------
  User  alice <b class="conum">(1)</b>


Name:         system:deployers
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows deploymentconfigs in this namespace to rollout pods in
                this namespace.  It is auto-managed by a controller; remove
                subjects to disa...
Role:
  Kind:  ClusterRole
  Name:  system:deployer
Subjects:
  Kind            Name      Namespace
  ----            ----      ---------
  ServiceAccount  deployer  joe


Name:         system:image-builders
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows builds in this namespace to push images to this
                namespace.  It is auto-managed by a controller; remove subjects
                to disable.
Role:
  Kind:  ClusterRole
  Name:  system:image-builder
Subjects:
  Kind            Name     Namespace
  ----            ----     ---------
  ServiceAccount  builder  joe


Name:         system:image-pullers
Labels:       &lt;none&gt;
Annotations:  openshift.io/description:
                Allows all pods in this namespace to pull images from this
                namespace.  It is auto-managed by a controller; remove subjects
                to disable.
Role:
  Kind:  ClusterRole
  Name:  system:image-puller
Subjects:
  Kind   Name                                Namespace
  ----   ----                                ---------
  Group  system:serviceaccounts:joe</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>alice</code> user has been added to the <code>admins</code> <code>RoleBinding</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-local-role_using-rbac">Creating a local role</h3>
<div class="paragraph">
<p>You can create a local role for a project and then bind it to a user.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To create a local role for a project, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create role &lt;name&gt; --verb=&lt;verb&gt; --resource=&lt;resource&gt; -n &lt;project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this command, specify:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>&lt;name&gt;</code>, the local role&#8217;s name</p>
</li>
<li>
<p><code>&lt;verb&gt;</code>, a comma-separated list of the verbs to apply to the role</p>
</li>
<li>
<p><code>&lt;resource&gt;</code>, the resources that the role applies to</p>
</li>
<li>
<p><code>&lt;project&gt;</code>, the project name</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>For example, to create a local role that allows a user to view pods in the
<code>blue</code> project, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create role podview --verb=get --resource=pod -n blue</code></pre>
</div>
</div>
</li>
<li>
<p>To bind the new role to a user, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm policy add-role-to-user podview user2 --role-namespace=blue -n blue</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-cluster-role_using-rbac">Creating a cluster role</h3>
<div class="paragraph">
<p>You can create a cluster role.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To create a cluster role, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create clusterrole &lt;name&gt; --verb=&lt;verb&gt; --resource=&lt;resource&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this command, specify:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>&lt;name&gt;</code>, the local role&#8217;s name</p>
</li>
<li>
<p><code>&lt;verb&gt;</code>, a comma-separated list of the verbs to apply to the role</p>
</li>
<li>
<p><code>&lt;resource&gt;</code>, the resources that the role applies to</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>For example, to create a cluster role that allows a user to view pods, run the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create clusterrole podviewonly --verb=get --resource=pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="local-role-binding-commands_using-rbac">Local role binding commands</h3>
<div class="paragraph">
<p>When you manage a user or group&#8217;s associated roles for local role bindings using the
following operations, a project may be specified with the <code>-n</code> flag. If it is
not specified, then the current project is used.</p>
</div>
<div class="paragraph">
<p>You can use the following commands for local RBAC management.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Local role binding operations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy who-can <em>&lt;verb&gt;</em> <em>&lt;resource&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates which users can perform an action on a resource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy add-role-to-user <em>&lt;role&gt;</em> <em>&lt;username&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binds a specified role to specified users in the current project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-role-from-user <em>&lt;role&gt;</em> <em>&lt;username&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes a given role from specified users in the current project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-user <em>&lt;username&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes specified users and all of their roles in the current project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy add-role-to-group <em>&lt;role&gt;</em> <em>&lt;groupname&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binds a given role to specified groups in the current project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-role-from-group <em>&lt;role&gt;</em> <em>&lt;groupname&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes a given role from specified groups in the current project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-group <em>&lt;groupname&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes specified groups and all of their roles in the current project.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="cluster-role-binding-commands_using-rbac">Cluster role binding commands</h3>
<div class="paragraph">
<p>You can also manage cluster role bindings using the following
operations. The <code>-n</code> flag is not used for these operations because
cluster role bindings use non-namespaced resources.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Cluster role binding operations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy add-cluster-role-to-user <em>&lt;role&gt;</em> <em>&lt;username&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binds a given role to specified users for all projects in the cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-cluster-role-from-user <em>&lt;role&gt;</em> <em>&lt;username&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes a given role from specified users for all projects in the cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy add-cluster-role-to-group <em>&lt;role&gt;</em> <em>&lt;groupname&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binds a given role to specified groups for all projects in the cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$ oc adm policy remove-cluster-role-from-group <em>&lt;role&gt;</em> <em>&lt;groupname&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes a given role from specified groups for all projects in the cluster.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="creating-cluster-admin_using-rbac">Creating a cluster admin</h3>
<div class="paragraph">
<p>The <code>cluster-admin</code> role is required to perform administrator
level tasks on the OpenShift Container Platform cluster, such as modifying
cluster resources.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have created a user to define as the cluster admin.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Define the user as a cluster admin:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm policy add-cluster-role-to-user cluster-admin &lt;user&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="removing-kubeadmin">Removing the kubeadmin user</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="understanding-kubeadmin_removing-kubeadmin">The kubeadmin user</h3>
<div class="paragraph">
<p>OpenShift Container Platform creates a cluster administrator, <code>kubeadmin</code>, after the
installation process completes.</p>
</div>
<div class="paragraph">
<p>This user has the <code>cluster-admin</code> role automatically applied and is treated
as the root user for the cluster. The password is dynamically generated
and unique to your OpenShift Container Platform environment. After installation
completes the password is provided in the installation program&#8217;s output.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">INFO Install complete!
INFO Run 'export KUBECONFIG=&lt;your working directory&gt;/auth/kubeconfig' to manage the cluster with 'oc', the OpenShift CLI.
INFO The cluster is ready when 'oc login -u kubeadmin -p &lt;provided&gt;' succeeds (wait a few minutes).
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.demo1.openshift4-beta-abcorp.com
INFO Login to the console with user: kubeadmin, password: &lt;provided&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="removing-kubeadmin_removing-kubeadmin">Removing the kubeadmin user</h3>
<div class="paragraph">
<p>After you define an identity provider and create a new <code>cluster-admin</code>
user, you can remove the <code>kubeadmin</code> to improve cluster security.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you follow this procedure before another user is a <code>cluster-admin</code>,
then OpenShift Container Platform must be reinstalled. It is not possible to undo
this command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have configured at least one identity provider.</p>
</li>
<li>
<p>You must have added the <code>cluster-admin</code> role to a user.</p>
</li>
<li>
<p>You must be logged in as an administrator.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Remove the <code>kubeadmin</code> secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete secrets kubeadmin -n kube-system</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-and-creating-service-accounts">Understanding and creating service accounts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="service-accounts-overview_understanding-service-accounts">Service accounts overview</h3>
<div class="paragraph">
<p>A service account is an OpenShift Container Platform account that allows a component to
directly access the API. Service accounts are API objects that exist within each project.
Service accounts provide a flexible way to control API
access without sharing a regular user&#8217;s credentials.</p>
</div>
<div class="paragraph">
<p>When you use the OpenShift Container Platform CLI or web console, your API token
authenticates you to the API. You can associate a component with a service account
so that they can access the API without using a regular user&#8217;s credentials.
For example, service accounts can allow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replication controllers to make API calls to create or delete pods.</p>
</li>
<li>
<p>Applications inside containers to make API calls for discovery purposes.</p>
</li>
<li>
<p>External applications to make API calls for monitoring or integration purposes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each service account&#8217;s user name is derived from its project and name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-text" data-lang="text">system:serviceaccount:&lt;project&gt;:&lt;name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every service account is also a member of two groups:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Group</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:serviceaccounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all service accounts in the system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:serviceaccounts:&lt;project&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all service accounts in the
specified project.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each service account automatically contains two secrets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An API token</p>
</li>
<li>
<p>Credentials for the OpenShift Container Registry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The generated API token and registry credentials do not expire, but you can
revoke them by deleting the secret. When you delete the secret, a new one is
automatically generated to take its place.</p>
</div>
</div>
<div class="sect2">
<h3 id="service-accounts-managing_understanding-service-accounts">Creating service accounts</h3>
<div class="paragraph">
<p>You can create a service account in a project and grant it permissions by
binding it to a role.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: To view the service accounts in the current project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get sa</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME       SECRETS   AGE
builder    2         2d
default    2         2d
deployer   2         2d</code></pre>
</div>
</div>
</li>
<li>
<p>To create a new service account in the current project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create sa &lt;service_account_name&gt; <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>To create a service account in a different project, specify <code>-n &lt;project_name&gt;</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">serviceaccount "robot" created</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the service account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: &lt;service_account_name&gt;
  namespace: &lt;current_project&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Optional: View the secrets for the service account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe sa robot</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:                robot
Namespace:           project1
Labels:	             &lt;none&gt;
Annotations:	     &lt;none&gt;
Image pull secrets:  robot-dockercfg-qzbhb
Mountable secrets:   robot-dockercfg-qzbhb
Tokens:              robot-token-f4khf
Events:              &lt;none&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="service-accounts-granting-roles_understanding-service-accounts">Examples of granting roles to service accounts</h3>
<div class="paragraph">
<p>You can grant roles to service accounts in the same way that you grant roles
to a regular user account.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can modify the service accounts for the current project. For example, to add
the <code>view</code> role to the <code>robot</code> service account in the <code>top-secret</code> project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc policy add-role-to-user view system:serviceaccount:top-secret:robot</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to add the role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: view
  namespace: top-secret
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- kind: ServiceAccount
  name: robot
  namespace: top-secret</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can also grant access to a specific service account in a project. For
example, from the project to which the service account belongs, use
the <code>-z</code> flag and specify the <code>&lt;service_account_name&gt;</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc policy add-role-to-user &lt;role_name&gt; -z &lt;service_account_name&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to grant access to a specific service account in a project, use the
<code>-z</code> flag. Using this flag helps prevent typos and ensures that access
is granted to only the specified service account.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to add the role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: &lt;rolebinding_name&gt;
  namespace: &lt;current_project_name&gt;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: &lt;role_name&gt;
subjects:
- kind: ServiceAccount
  name: &lt;service_account_name&gt;
  namespace: &lt;current_project_name&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To modify a different namespace, you can use the <code>-n</code> option to indicate the
project namespace it applies to, as shown in the following examples.</p>
<div class="ulist">
<ul>
<li>
<p>For example, to allow all service accounts in all projects to view resources in
the <code>my-project</code> project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc policy add-role-to-group view system:serviceaccounts -n my-project</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to add the role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: view
  namespace: my-project
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:serviceaccounts</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To allow all service accounts in the <code>managers</code> project to edit resources in the
<code>my-project</code> project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc policy add-role-to-group edit system:serviceaccounts:managers -n my-project</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to add the role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: edit
  namespace: my-project
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: edit
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:serviceaccounts:managers</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-service-accounts">Using service accounts in applications</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="service-accounts-overview_using-service-accounts">Service accounts overview</h3>
<div class="paragraph">
<p>A service account is an OpenShift Container Platform account that allows a component to
directly access the API. Service accounts are API objects that exist within each project.
Service accounts provide a flexible way to control API
access without sharing a regular user&#8217;s credentials.</p>
</div>
<div class="paragraph">
<p>When you use the OpenShift Container Platform CLI or web console, your API token
authenticates you to the API. You can associate a component with a service account
so that they can access the API without using a regular user&#8217;s credentials.
For example, service accounts can allow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replication controllers to make API calls to create or delete pods.</p>
</li>
<li>
<p>Applications inside containers to make API calls for discovery purposes.</p>
</li>
<li>
<p>External applications to make API calls for monitoring or integration purposes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each service account&#8217;s user name is derived from its project and name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-text" data-lang="text">system:serviceaccount:&lt;project&gt;:&lt;name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every service account is also a member of two groups:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Group</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:serviceaccounts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all service accounts in the system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system:serviceaccounts:&lt;project&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all service accounts in the
specified project.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each service account automatically contains two secrets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An API token</p>
</li>
<li>
<p>Credentials for the OpenShift Container Registry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The generated API token and registry credentials do not expire, but you can
revoke them by deleting the secret. When you delete the secret, a new one is
automatically generated to take its place.</p>
</div>
</div>
<div class="sect2">
<h3 id="service-accounts-default_using-service-accounts">Default service accounts</h3>
<div class="paragraph">
<p>Your OpenShift Container Platform cluster contains default service accounts for
cluster management and generates more service accounts for each project.</p>
</div>
<div class="sect3">
<h4 id="default-cluster-service-accounts_using-service-accounts">Default cluster service accounts</h4>
<div class="paragraph">
<p>Several infrastructure controllers run using service account credentials. The
following service accounts are created in the OpenShift Container Platform infrastructure
project (<code>openshift-infra</code>) at server start, and given the following roles
cluster-wide:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Account</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>replication-controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigned the <code>system:replication-controller</code> role</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployment-controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigned the <code>system:deployment-controller</code> role</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>build-controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Assigned the <code>system:build-controller</code> role. Additionally, the
<code>build-controller</code> service account is included in the privileged
security context constraint to create privileged
build pods.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="default-service-accounts-and-roles_using-service-accounts">Default project service accounts and roles</h4>
<div class="paragraph">
<p>Three service accounts are automatically created in each project:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Account</th>
<th class="tableblock halign-left valign-top">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>builder</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used by build pods. It is given the <code>system:image-builder</code> role, which allows
pushing images to any imagestream in the project using the internal Docker
registry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used by deployment pods and given the <code>system:deployer</code> role, which allows
viewing and modifying replication controllers and pods in the project.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to run all other pods unless they specify a different service account.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All service accounts in a project are given the <code>system:image-puller</code> role,
which allows pulling images from any imagestream in the project using the
internal container image registry.</p>
</div>
</div>
<div class="sect3">
<h4 id="auto-generated-sa-token-secrets_using-service-accounts">About automatically-generated service account token secrets</h4>
<div class="paragraph">
<p>In 4.13, OpenShift Container Platform is adopting an <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md#urgent-upgrade-notes-1">enhancement from upstream Kubernetes</a>, which enables the <code>LegacyServiceAccountTokenNoAutoGeneration</code> feature by default. As a result, when creating new service accounts (SA), a service account token secret is no longer automatically generated. Previously, OpenShift Container Platform automatically added a service account token to a secret for each new SA.</p>
</div>
<div class="paragraph">
<p>However, some features and workloads need service account token secrets to communicate with the Kubernetes API server, for example, the OpenShift Controller Manager. While this requirement will be changed in a future release, it remains in OpenShift Container Platform 4.13. As a result, if you need a service account token secret, you must manually use the TokenRequest API to request bound service account tokens or create a service account token secret.</p>
</div>
<div class="paragraph">
<p>After upgrading to 4.13, existing service account token secrets are not deleted and continue to function as expected.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In 4.13, service account token secrets are still automatically generated. Instead of creating two secrets per service account, OpenShift Container Platform now only creates one. In a future release, the number will be further reduced to zero. Note that <code>dockercfg</code> secrets are still generated and no secrets are deleted during upgrades.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For information about requesting bound service account tokens, see <a href="#bound-sa-tokens-configuring_bound-service-account-tokens">Configuring bound service account tokens using volume projection</a></p>
</li>
<li>
<p>For information about creating a service account token secret, see <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/nodes/#nodes-pods-secrets-creating-sa_nodes-pods-secrets">Creating a service account token secret</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-accounts-managing_using-service-accounts">Creating service accounts</h3>
<div class="paragraph">
<p>You can create a service account in a project and grant it permissions by
binding it to a role.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: To view the service accounts in the current project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get sa</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME       SECRETS   AGE
builder    2         2d
default    2         2d
deployer   2         2d</code></pre>
</div>
</div>
</li>
<li>
<p>To create a new service account in the current project:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create sa &lt;service_account_name&gt; <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>To create a service account in a different project, specify <code>-n &lt;project_name&gt;</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">serviceaccount "robot" created</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to create the service account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: &lt;service_account_name&gt;
  namespace: &lt;current_project&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Optional: View the secrets for the service account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe sa robot</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:                robot
Namespace:           project1
Labels:	             &lt;none&gt;
Annotations:	     &lt;none&gt;
Image pull secrets:  robot-dockercfg-qzbhb
Mountable secrets:   robot-dockercfg-qzbhb
Tokens:              robot-token-f4khf
Events:              &lt;none&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-service-accounts-as-oauth-client">Using a service account as an OAuth client</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="service-accounts-as-oauth-clients_using-service-accounts-as-oauth-client">Service accounts as OAuth clients</h3>
<div class="paragraph">
<p>You can use a service account as a constrained form of OAuth client.
Service accounts can request only a subset of scopes that
allow access to some basic user information
and role-based power inside of the service account&#8217;s own namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user:info</code></p>
</li>
<li>
<p><code>user:check-access</code></p>
</li>
<li>
<p><code>role:&lt;any_role&gt;:&lt;service_account_namespace&gt;</code></p>
</li>
<li>
<p><code>role:&lt;any_role&gt;:&lt;service_account_namespace&gt;:!</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using a service account as an OAuth client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>client_id</code> is <code>system:serviceaccount:&lt;service_account_namespace&gt;:&lt;service_account_name&gt;</code>.</p>
</li>
<li>
<p><code>client_secret</code> can be any of the API tokens for that service account. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc sa get-token &lt;service_account_name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>To get <code>WWW-Authenticate</code> challenges, set an
<code>serviceaccounts.openshift.io/oauth-want-challenges</code> annotation on the service
account to <code>true</code>.</p>
</li>
<li>
<p><code>redirect_uri</code> must match an annotation on the service account.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="redirect-uris-for-service-accounts_using-service-accounts-as-oauth-client">Redirect URIs for service accounts as OAuth clients</h4>
<div class="paragraph">
<p>Annotation keys must have the prefix
<code>serviceaccounts.openshift.io/oauth-redirecturi.</code> or
<code>serviceaccounts.openshift.io/oauth-redirectreference.</code> such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">serviceaccounts.openshift.io/oauth-redirecturi.&lt;name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In its simplest form, the annotation can be used to directly specify valid
redirect URIs. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">"serviceaccounts.openshift.io/oauth-redirecturi.first":  "https://example.com"
"serviceaccounts.openshift.io/oauth-redirecturi.second": "https://other.com"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>first</code> and <code>second</code> postfixes in the above example are used to separate the
two valid redirect URIs.</p>
</div>
<div class="paragraph">
<p>In more complex configurations, static redirect URIs may not be enough. For
example, perhaps you want all Ingresses for a route to be considered valid. This
is where dynamic redirect URIs via the
<code>serviceaccounts.openshift.io/oauth-redirectreference.</code> prefix come into play.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">"serviceaccounts.openshift.io/oauth-redirectreference.first": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"jenkins\"}}"</pre>
</div>
</div>
<div class="paragraph">
<p>Since the value for this annotation contains serialized JSON data, it is easier
to see in an expanded format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "kind": "OAuthRedirectReference",
  "apiVersion": "v1",
  "reference": {
    "kind": "Route",
    "name": "jenkins"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can see that an <code>OAuthRedirectReference</code> allows us to reference the
route named <code>jenkins</code>. Thus, all Ingresses for that route will now be considered
valid.  The full specification for an <code>OAuthRedirectReference</code> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "kind": "OAuthRedirectReference",
  "apiVersion": "v1",
  "reference": {
    "kind": ..., <b class="conum">(1)</b>
    "name": ..., <b class="conum">(2)</b>
    "group": ... <b class="conum">(3)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>kind</code> refers to the type of the object being referenced. Currently, only <code>route</code> is supported.</p>
</li>
<li>
<p><code>name</code> refers to the name of the object. The object must be in the same namespace as the service account.</p>
</li>
<li>
<p><code>group</code> refers to the group of the object. Leave this blank, as the group for a route is the empty string.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both annotation prefixes can be combined to override the data provided by the
reference object. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">"serviceaccounts.openshift.io/oauth-redirecturi.first":  "custompath"
"serviceaccounts.openshift.io/oauth-redirectreference.first": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"jenkins\"}}"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>first</code> postfix is used to tie the annotations together. Assuming that the
<code>jenkins</code> route had an Ingress of <code>https://example.com</code>, now
<code>https://example.com/custompath</code> is considered valid, but
<code>https://example.com</code> is not.  The format for partially supplying override
data is as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Scheme</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"https://"</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Hostname</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"//website.com"</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Port</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"//:8000"</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Path</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>"examplepath"</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Specifying a hostname override will replace the hostname data from the
referenced object, which is not likely to be desired behavior.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any combination of the above syntax can be combined using the following format:</p>
</div>
<div class="paragraph">
<p><code>&lt;scheme:&gt;//&lt;hostname&gt;&lt;:port&gt;/&lt;path&gt;</code></p>
</div>
<div class="paragraph">
<p>The same object can be referenced more than once for more flexibility:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">"serviceaccounts.openshift.io/oauth-redirecturi.first":  "custompath"
"serviceaccounts.openshift.io/oauth-redirectreference.first": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"jenkins\"}}"
"serviceaccounts.openshift.io/oauth-redirecturi.second":  "//:8000"
"serviceaccounts.openshift.io/oauth-redirectreference.second": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"jenkins\"}}"</pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that the route named <code>jenkins</code> has an Ingress of
<code>https://example.com</code>, then both <code>https://example.com:8000</code> and
<code>https://example.com/custompath</code> are considered valid.</p>
</div>
<div class="paragraph">
<p>Static and dynamic annotations can be used at the same time to achieve the
desired behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">"serviceaccounts.openshift.io/oauth-redirectreference.first": "{\"kind\":\"OAuthRedirectReference\",\"apiVersion\":\"v1\",\"reference\":{\"kind\":\"Route\",\"name\":\"jenkins\"}}"
"serviceaccounts.openshift.io/oauth-redirecturi.second": "https://other.com"</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tokens-scoping">Scoping tokens</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="tokens-scoping-about_configuring-internal-oauth">About scoping tokens</h3>
<div class="paragraph">
<p>You can create scoped tokens to delegate some of your permissions to another
user or service account.
For example, a project administrator might want to delegate the
power to create pods.</p>
</div>
<div class="paragraph">
<p>A scoped token is a token that identifies as a given user but is limited to
certain actions by its scope. Only a user with the <code>cluster-admin</code> role can create
scoped tokens.</p>
</div>
<div class="paragraph">
<p>Scopes are evaluated by converting the set of scopes for a token into a set of
<code>PolicyRules</code>. Then, the request is matched against those rules. The request
attributes must match at least one of the scope rules to be passed to the
"normal" authorizer for further authorization checks.</p>
</div>
<div class="sect3">
<h4 id="scoping-tokens-user-scopes_configuring-internal-oauth">User scopes</h4>
<div class="paragraph">
<p>User scopes are focused on getting information about a given user. They are
intent-based, so the rules are automatically created for you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>user:full</code> - Allows full read/write access to the API with all of the user&#8217;s permissions.</p>
</li>
<li>
<p><code>user:info</code> - Allows read-only access to information about the user, such as name and groups.</p>
</li>
<li>
<p><code>user:check-access</code> - Allows access to <code>self-localsubjectaccessreviews</code> and <code>self-subjectaccessreviews</code>.
These are the variables where you pass an empty user and groups in your request object.</p>
</li>
<li>
<p><code>user:list-projects</code> - Allows read-only access to list the projects the user has access to.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scoping-tokens-role-scope_configuring-internal-oauth">Role scope</h4>
<div class="paragraph">
<p>The role scope allows you to have the same level of access as a given role
filtered by namespace.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>role:&lt;cluster-role name&gt;:&lt;namespace or * for all&gt;</code> - Limits the scope to the
rules specified by the cluster-role, but only in the specified namespace .</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Caveat: This prevents escalating access. Even if the role allows access to
resources like secrets, rolebindings, and roles, this scope will deny access
to those resources. This helps prevent unexpected escalations. Many people do
not think of a role like <code>edit</code> as being an escalating role, but with access to
a secret it is.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>role:&lt;cluster-role name&gt;:&lt;namespace or * for all&gt;:!</code> -  This is similar to the
example above, except that including the bang causes this scope to allow
escalating access.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bound-service-account-tokens">Using bound service account tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use bound service account tokens, which improves the ability to integrate with cloud provider identity access management (IAM) services, such as AWS IAM.</p>
</div>
<div class="sect2">
<h3 id="bound-sa-tokens-about_bound-service-account-tokens">About bound service account tokens</h3>
<div class="paragraph">
<p>You can use bound service account tokens to limit the scope of permissions for a given service account token. These tokens are audience and time-bound. This facilitates the authentication of a service account to an IAM role and the generation of temporary credentials mounted to a pod. You can request bound service account tokens by using volume projection and the TokenRequest API.</p>
</div>
</div>
<div class="sect2">
<h3 id="bound-sa-tokens-configuring_bound-service-account-tokens">Configuring bound service account tokens using volume projection</h3>
<div class="paragraph">
<p>You can configure pods to request bound service account tokens by using volume projection.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You have created a service account. This procedure assumes that the service account is named <code>build-robot</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: Set the service account issuer.</p>
<div class="paragraph">
<p>This step is typically not required if the bound tokens are used only within the cluster.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you change the service account issuer to a custom one, the previous service account issuer is still trusted for the next 24 hours.</p>
</div>
<div class="paragraph">
<p>You can force all holders to request a new bound token either by manually restarting all pods in the cluster or by performing a rolling node restart. Before performing either action, wait for a new revision of the Kubernetes API server pods to roll out with your service account issuer changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>cluster</code> <code>Authentication</code> object:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit authentications cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Set the <code>spec.serviceAccountIssuer</code> field to the desired service account issuer value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  serviceAccountIssuer: https://test.default.svc <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This value should be a URL from which the recipient of a bound token can source the public keys necessary to verify the signature of the token. The default is <code>https://kubernetes.default.svc</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file to apply the changes.</p>
</li>
<li>
<p>Wait for a new revision of the Kubernetes API server pods to roll out. It can take several minutes for all nodes to update to the new revision. Run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get kubeapiserver -o=jsonpath='{range .items[0].status.conditions[?(@.type=="NodeInstallerProgressing")]}{.reason}{"\n"}{.message}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Review the <code>NodeInstallerProgressing</code> status condition for the Kubernetes API server to verify that all nodes are at the latest revision. The output shows <code>AllNodesAtLatestRevision</code> upon successful update:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">AllNodesAtLatestRevision
3 nodes are at revision 12 <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In this example, the latest revision number is <code>12</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the output shows a message similar to one of the following messages, the update is still in progress. Wait a few minutes and try again.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>3 nodes are at revision 11; 0 nodes have achieved new revision 12</code></p>
</li>
<li>
<p><code>2 nodes are at revision 11; 1 nodes are at revision 12</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: Force the holder to request a new bound token either by performing a rolling node restart or by manually restarting all pods in the cluster.</p>
<div class="ulist">
<ul>
<li>
<p>Perform a rolling node restart:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>It is not recommended to perform a rolling node restart if you have custom workloads running on your cluster, because it can cause a service interruption. Instead, manually restart all pods in the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart nodes sequentially. Wait for the node to become fully available before restarting the next node. See <em>Rebooting a node gracefully</em> for instructions on how to drain, restart, and mark a node as schedulable again.</p>
</div>
</li>
<li>
<p>Manually restart all pods in the cluster:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Be aware that running this command causes a service interruption, because it deletes every running pod in every namespace. These pods will automatically restart after they are deleted.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ for I in $(oc get ns -o jsonpath='{range .items[*]} {.metadata.name}{"\n"} {end}'); \
      do oc delete pods --all -n $I; \
      sleep 1; \
      done</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure a pod to use a bound service account token by using volume projection.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a file called <code>pod-projected-svc-token.yaml</code> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - image: nginx
    name: nginx
    volumeMounts:
    - mountPath: /var/run/secrets/tokens
      name: vault-token
  serviceAccountName: build-robot <b class="conum">(1)</b>
  volumes:
  - name: vault-token
    projected:
      sources:
      - serviceAccountToken:
          path: vault-token <b class="conum">(2)</b>
          expirationSeconds: 7200 <b class="conum">(3)</b>
          audience: vault <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A reference to an existing service account.</p>
</li>
<li>
<p>The path relative to the mount point of the file to project the token into.</p>
</li>
<li>
<p>Optionally set the expiration of the service account token, in seconds. The default is 3600 seconds (1 hour) and must be at least 600 seconds (10 minutes). The kubelet will start trying to rotate the token if the token is older than 80 percent of its time to live or if the token is older than 24 hours.</p>
</li>
<li>
<p>Optionally set the intended audience of the token. The recipient of a token should verify that the recipient identity matches the audience claim of the token, and should otherwise reject the token. The audience defaults to the identifier of the API server.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f pod-projected-svc-token.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The kubelet requests and stores the token on behalf of the pod, makes the token available to the pod at a configurable file path, and refreshes the token as it approaches expiration.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>The application that uses the bound token must handle reloading the token when it rotates.</p>
<div class="paragraph">
<p>The kubelet rotates the token if it is older than 80 percent of its time to live, or if the token is older than 24 hours.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="bound-sa-tokens-configuring-externally_bound-service-account-tokens">Creating bound service account tokens outside the pod</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You have created a service account. This procedure assumes that the service account is named <code>build-robot</code>.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create the bound service account token outside the pod by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create token build-robot</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">eyJhbGciOiJSUzI1NiIsImtpZCI6IkY2M1N4MHRvc2xFNnFSQlA4eG9GYzVPdnN3NkhIV0tRWmFrUDRNcWx4S0kifQ.eyJhdWQiOlsiaHR0cHM6Ly9pc3N1ZXIyLnRlc3QuY29tIiwiaHR0cHM6Ly9pc3N1ZXIxLnRlc3QuY29tIiwiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjIl0sImV4cCI6MTY3OTU0MzgzMCwiaWF0IjoxNjc5NTQwMjMwLCJpc3MiOiJodHRwczovL2lzc3VlcjIudGVzdC5jb20iLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6ImRlZmF1bHQiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoidGVzdC1zYSIsInVpZCI6ImM3ZjA4MjkwLWIzOTUtNGM4NC04NjI4LTMzMTM1NTVhNWY1OSJ9fSwibmJmIjoxNjc5NTQwMjMwLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDp0ZXN0LXNhIn0.WyAOPvh1BFMUl3LNhBCrQeaB5wSynbnCfojWuNNPSilT4YvFnKibxwREwmzHpV4LO1xOFZHSi6bXBOmG_o-m0XNDYL3FrGHd65mymiFyluztxa2lgHVxjw5reIV5ZLgNSol3Y8bJqQqmNg3rtQQWRML2kpJBXdDHNww0E5XOypmffYkfkadli8lN5QQD-MhsCbiAF8waCYs8bj6V6Y7uUKTcxee8sCjiRMVtXKjQtooERKm-CH_p57wxCljIBeM89VdaR51NJGued4hVV5lxvVrYZFu89lBEAq4oyQN_d6N1vBWGXQMyoihnt_fQjn-NfnlJWk-3NSZDIluDJAv7e-MTEk3geDrHVQKNEzDei2-Un64hSzb-n1g1M0Vn0885wQBQAePC9UlZm8YZlMNk1tq6wIUKQTMv3HPfi5HtBRqVc2eVs0EfMX4-x-PHhPCasJ6qLJWyj6DvyQ08dP4DW_TWZVGvKlmId0hzwpg59TTcLR0iCklSEJgAVEEd13Aa_M0-faD11L3MhUGxw0qxgOsPczdXUsolSISbefs7OKymzFSIkTAn9sDQ8PHMOsuyxsK8vzfrR-E0z7MAeguZ2kaIY7cZqbN6WFy0caWgx46hrKem9vCKALefElRYbCg3hcBmowBcRTOqaFHLNnHghhU1LaRpoFzH7OUarqX9SGQ</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/nodes/#nodes-nodes-rebooting-gracefully_nodes-nodes-rebooting">Rebooting a node gracefully</a></p>
</li>
<li>
<p><a href="#service-accounts-managing_understanding-service-accounts">Creating service accounts</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-pod-security-policies">Managing security context constraints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In OpenShift Container Platform, you can use security context constraints (SCCs) to control permissions for the pods in your cluster.</p>
</div>
<div class="paragraph">
<p>Default SCCs are created during installation and when you install some Operators or other components. As a cluster administrator, you can also create your own SCCs by using the OpenShift CLI (<code>oc</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Do not modify the default SCCs. Customizing the default SCCs can lead to issues when some of the platform pods deploy or
OpenShift Container Platform
is upgraded. Additionally, the default SCC values are reset to the defaults during some cluster upgrades, which discards all customizations to those SCCs.</p>
</div>
<div class="paragraph">
<p>Instead of modifying the default SCCs, create and modify your own SCCs as needed. For detailed steps, see <a href="#security-context-constraints-creating_configuring-internal-oauth">Creating security context constraints</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="security-context-constraints-about_configuring-internal-oauth">About security context constraints</h3>
<div class="paragraph">
<p>Similar to the way that RBAC resources control user access, administrators can use security context constraints (SCCs) to control permissions for pods. These permissions determine the actions that a pod can perform and what resources it can access. You can use SCCs to define a set of conditions that a pod must run with to be accepted into the system.</p>
</div>
<div class="paragraph">
<p>Security context constraints allow an administrator to control:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whether a pod can run privileged containers with the <code>allowPrivilegedContainer</code> flag</p>
</li>
<li>
<p>Whether a pod is constrained with the <code>allowPrivilegeEscalation</code> flag</p>
</li>
<li>
<p>The capabilities that a container can request</p>
</li>
<li>
<p>The use of host directories as volumes</p>
</li>
<li>
<p>The SELinux context of the container</p>
</li>
<li>
<p>The container user ID</p>
</li>
<li>
<p>The use of host namespaces and networking</p>
</li>
<li>
<p>The allocation of an <code>FSGroup</code> that owns the pod volumes</p>
</li>
<li>
<p>The configuration of allowable supplemental groups</p>
</li>
<li>
<p>Whether a container requires write access to its root file system</p>
</li>
<li>
<p>The usage of volume types</p>
</li>
<li>
<p>The configuration of allowable <code>seccomp</code> profiles</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Do not set the <code>openshift.io/run-level</code> label on any namespaces in OpenShift Container Platform. This label is for use by internal OpenShift Container Platform components to manage the startup of major API groups, such as the Kubernetes API server and OpenShift API server. If the <code>openshift.io/run-level</code> label is set, no SCCs are applied to pods in that namespace, causing any workloads running in that namespace to be highly privileged.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="default-sccs_configuring-internal-oauth">Default security context constraints</h4>
<div class="paragraph">
<p>The cluster contains several default security context constraints (SCCs) as described in the table below. Additional SCCs might be installed when you install Operators or other components to OpenShift Container Platform.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Do not modify the default SCCs. Customizing the default SCCs can lead to issues when some of the platform pods deploy or
OpenShift Container Platform
is upgraded. Additionally, the default SCC values are reset to the defaults during some cluster upgrades, which discards all customizations to those SCCs.</p>
</div>
<div class="paragraph">
<p>Instead of modifying the default SCCs, create and modify your own SCCs as needed. For detailed steps, see <em>Creating security context constraints</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Default security context constraints</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Security context constraint</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>anyuid</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Provides all features of the <code>restricted</code> SCC, but allows users to run with any UID and any GID.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hostaccess</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Allows access to all host namespaces but still requires pods to be run with a UID and SELinux context that are allocated to the namespace.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This SCC allows host access to namespaces, file systems, and PIDs. It should only be used by trusted pods. Grant with caution.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hostmount-anyuid</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Provides all the features of the <code>restricted</code> SCC, but allows host mounts and running as any UID and any GID on the system.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This SCC allows host file system access as any UID, including UID 0. Grant with caution.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hostnetwork</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Allows using host networking and host ports but still requires pods to be run with a UID and SELinux context that are allocated to the namespace.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If additional workloads are run on control plane hosts, use caution when providing access to <code>hostnetwork</code>. A workload that runs <code>hostnetwork</code> on a control plane host is effectively root on the cluster and must be trusted accordingly.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hostnetwork-v2</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Like the <code>hostnetwork</code> SCC, but with the following differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALL</code> capabilities are dropped from containers.</p>
</li>
<li>
<p>The <code>NET_BIND_SERVICE</code> capability can be added explicitly.</p>
</li>
<li>
<p><code>seccompProfile</code> is set to <code>runtime/default</code> by default.</p>
</li>
<li>
<p><code>allowPrivilegeEscalation</code> must be unset or set to <code>false</code> in security contexts.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>node-exporter</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Used for the Prometheus node exporter.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This SCC allows host file system access as any UID, including UID 0. Grant with caution.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nonroot</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Provides all features of the <code>restricted</code> SCC, but allows users to run with any non-root UID. The user must specify the UID or it must be specified in the manifest of the container runtime.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nonroot-v2</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Like the <code>nonroot</code> SCC, but with the following differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALL</code> capabilities are dropped from containers.</p>
</li>
<li>
<p>The <code>NET_BIND_SERVICE</code> capability can be added explicitly.</p>
</li>
<li>
<p><code>seccompProfile</code> is set to <code>runtime/default</code> by default.</p>
</li>
<li>
<p><code>allowPrivilegeEscalation</code> must be unset or set to <code>false</code> in security contexts.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>privileged</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Allows access to all privileged and host features and the ability to run as any user, any group, any FSGroup, and with any SELinux context.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This is the most relaxed SCC and should be used only for cluster administration. Grant with caution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>privileged</code> SCC allows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Users to run privileged pods</p>
</li>
<li>
<p>Pods to mount host directories as volumes</p>
</li>
<li>
<p>Pods to run as any user</p>
</li>
<li>
<p>Pods to run with any MCS label</p>
</li>
<li>
<p>Pods to use the host&#8217;s IPC namespace</p>
</li>
<li>
<p>Pods to use the host&#8217;s PID namespace</p>
</li>
<li>
<p>Pods to use any FSGroup</p>
</li>
<li>
<p>Pods to use any supplemental group</p>
</li>
<li>
<p>Pods to use any seccomp profiles</p>
</li>
<li>
<p>Pods to request any capabilities</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Setting <code>privileged: true</code> in the pod specification does not necessarily select the <code>privileged</code> SCC. The SCC that has <code>allowPrivilegedContainer: true</code> and has the highest prioritization will be chosen if the user has the permissions to use it.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restricted</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Denies access to all host features and requires pods to be run with a UID, and SELinux context that are allocated to the namespace.</p>
</div>
<div class="paragraph">
<p>The <code>restricted</code> SCC:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensures that pods cannot run as privileged</p>
</li>
<li>
<p>Ensures that pods cannot mount host directory volumes</p>
</li>
<li>
<p>Requires that a pod is run as a user in a pre-allocated range of UIDs</p>
</li>
<li>
<p>Requires that a pod is run with a pre-allocated MCS label</p>
</li>
<li>
<p>Allows pods to use any FSGroup</p>
</li>
<li>
<p>Allows pods to use any supplemental group</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In clusters that were upgraded from OpenShift Container Platform 4.10 or earlier, this SCC is available for use by any authenticated user. The <code>restricted</code> SCC is no longer available to users of new OpenShift Container Platform 4.11 or later installations, unless the access is explicitly granted.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restricted-v2</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Like the <code>restricted</code> SCC, but with the following differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALL</code> capabilities are dropped from containers.</p>
</li>
<li>
<p>The <code>NET_BIND_SERVICE</code> capability can be added explicitly.</p>
</li>
<li>
<p><code>seccompProfile</code> is set to <code>runtime/default</code> by default.</p>
</li>
<li>
<p><code>allowPrivilegeEscalation</code> must be unset or set to <code>false</code> in security contexts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the most restrictive SCC provided by a new installation and will be used by default for authenticated users.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>restricted-v2</code> SCC is the most restrictive of the SCCs that is included by default with the system. However, you can create a custom SCC that is even more restrictive. For example, you can create an SCC that restricts <code>readOnlyRootFilesystem</code> to <code>true</code>.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="scc-settings_configuring-internal-oauth">Security context constraints settings</h4>
<div class="paragraph">
<p>Security context constraints (SCCs) are composed of settings and strategies that control the security features
a pod has access to. These settings fall into three categories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controlled by a boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fields of this type default to the most restrictive value. For example,
<code>AllowPrivilegedContainer</code> is always set to <code>false</code> if unspecified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controlled by an allowable set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fields of this type are checked against the set to ensure their value is
allowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controlled by a strategy</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Items that have a strategy to generate a value provide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A mechanism to generate the value, and</p>
</li>
<li>
<p>A mechanism to ensure that a specified value falls into the set of allowable
values.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>CRI-O has the following default list of capabilities that are allowed for each container of a pod:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CHOWN</code></p>
</li>
<li>
<p><code>DAC_OVERRIDE</code></p>
</li>
<li>
<p><code>FSETID</code></p>
</li>
<li>
<p><code>FOWNER</code></p>
</li>
<li>
<p><code>SETGID</code></p>
</li>
<li>
<p><code>SETUID</code></p>
</li>
<li>
<p><code>SETPCAP</code></p>
</li>
<li>
<p><code>NET_BIND_SERVICE</code></p>
</li>
<li>
<p><code>KILL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The containers use the capabilities from this default list, but pod manifest authors can alter the list by requesting additional capabilities or removing some of the default behaviors. Use the <code>allowedCapabilities</code>, <code>defaultAddCapabilities</code>, and <code>requiredDropCapabilities</code> parameters to control such requests from the pods. With these parameters you can specify which capabilities can be requested, which ones must be added to each container, and which ones must be forbidden, or dropped, from each container.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can drop all capabilites from containers by setting the <code>requiredDropCapabilities</code> parameter to <code>ALL</code>. This is what the <code>restricted-v2</code> SCC does.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="authorization-SCC-strategies_configuring-internal-oauth">Security context constraints strategies</h4>
<div class="ulist">
<div class="title">RunAsUser</div>
<ul>
<li>
<p><code>MustRunAs</code> - Requires a <code>runAsUser</code> to be configured. Uses the configured
<code>runAsUser</code> as the default. Validates against the configured <code>runAsUser</code>.</p>
<div class="listingblock">
<div class="title">Example <code>MustRunAs</code> snippet</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
runAsUser:
  type: MustRunAs
  uid: &lt;id&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p><code>MustRunAsRange</code> - Requires minimum and maximum values to be defined if not
using pre-allocated values. Uses the minimum as the default. Validates against
the entire allowable range.</p>
<div class="listingblock">
<div class="title">Example <code>MustRunAsRange</code> snippet</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
runAsUser:
  type: MustRunAsRange
  uidRangeMax: &lt;maxvalue&gt;
  uidRangeMin: &lt;minvalue&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p><code>MustRunAsNonRoot</code> - Requires that the pod be submitted with a non-zero
<code>runAsUser</code> or have the <code>USER</code> directive defined in the image. No default
provided.</p>
<div class="listingblock">
<div class="title">Example <code>MustRunAsNonRoot</code> snippet</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
runAsUser:
  type: MustRunAsNonRoot
...</code></pre>
</div>
</div>
</li>
<li>
<p><code>RunAsAny</code> - No default provided. Allows any <code>runAsUser</code> to be specified.</p>
<div class="listingblock">
<div class="title">Example <code>RunAsAny</code> snippet</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
runAsUser:
  type: RunAsAny
...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">SELinuxContext</div>
<ul>
<li>
<p><code>MustRunAs</code> - Requires <code>seLinuxOptions</code> to be configured if not using
pre-allocated values. Uses <code>seLinuxOptions</code> as the default. Validates against
<code>seLinuxOptions</code>.</p>
</li>
<li>
<p><code>RunAsAny</code> - No default provided. Allows any <code>seLinuxOptions</code> to be
specified.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">SupplementalGroups</div>
<ul>
<li>
<p><code>MustRunAs</code> - Requires at least one range to be specified if not using
pre-allocated values. Uses the minimum value of the first range as the default.
Validates against all ranges.</p>
</li>
<li>
<p><code>RunAsAny</code> - No default provided. Allows any <code>supplementalGroups</code> to be
specified.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">FSGroup</div>
<ul>
<li>
<p><code>MustRunAs</code> - Requires at least one range to be specified if not using
pre-allocated values. Uses the minimum value of the first range as the default.
Validates against the first ID in the first range.</p>
</li>
<li>
<p><code>RunAsAny</code> - No default provided. Allows any <code>fsGroup</code> ID to be specified.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="authorization-controlling-volumes_configuring-internal-oauth">Controlling volumes</h4>
<div class="paragraph">
<p>The usage of specific volume types
can be controlled by setting the <code>volumes</code>
field of the SCC.</p>
</div>
<div class="paragraph">
<p>The allowable values of this field correspond to the volume
sources that are defined when creating a volume:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#awselasticblockstore"><code>awsElasticBlockStore</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#azuredisk"><code>azureDisk</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#azurefile"><code>azureFile</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#cephfs"><code>cephFS</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#cinder"><code>cinder</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#configmap"><code>configMap</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#csi-ephemeral-volumes"><code>csi</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#downwardapi"><code>downwardAPI</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir"><code>emptyDir</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#fc"><code>fc</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#flexvolume"><code>flexVolume</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#flocker"><code>flocker</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#gcepersistentdisk"><code>gcePersistentDisk</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo"><code>gitRepo</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#glusterfs"><code>glusterfs</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath"><code>hostPath</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#iscsi"><code>iscsi</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#nfs"><code>nfs</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#persistentvolumeclaim"><code>persistentVolumeClaim</code></a></p>
</li>
<li>
<p><code>photonPersistentDisk</code></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#portworxvolume"><code>portworxVolume</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#projected"><code>projected</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#quobyte"><code>quobyte</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#rbd"><code>rbd</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#scaleio"><code>scaleIO</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#secret"><code>secret</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#storageos"><code>storageos</code></a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#vspherevolume"><code>vsphereVolume</code></a></p>
</li>
<li>
<p><strong>*</strong> (A special value to allow the use of all volume types.)</p>
</li>
<li>
<p><code>none</code> (A special value to disallow the use of all volumes types. Exists only for backwards compatibility.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The recommended minimum set of allowed volumes for new SCCs are <code>configMap</code>,
<code>downwardAPI</code>, <code>emptyDir</code>, <code>persistentVolumeClaim</code>, <code>secret</code>, and <code>projected</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This list of allowable volume types is not exhaustive because new types are
added with each release of OpenShift Container Platform.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For backwards compatibility, the usage of <code>allowHostDirVolumePlugin</code> overrides
settings in the <code>volumes</code> field. For example, if <code>allowHostDirVolumePlugin</code>
is set to false but allowed in the <code>volumes</code> field, then the <code>hostPath</code>
value will be removed from <code>volumes</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="admission_configuring-internal-oauth">Admission control</h4>
<div class="paragraph">
<p><em>Admission control</em> with SCCs allows for control over the creation of resources
based on the capabilities granted to a user.</p>
</div>
<div class="paragraph">
<p>In terms of the SCCs, this means that an admission controller can inspect the
user information made available in the context to retrieve an appropriate set of
SCCs. Doing so ensures the pod is authorized to make requests about its
operating environment or to generate a set of constraints to apply to the pod.</p>
</div>
<div class="paragraph">
<p>The set of SCCs that admission uses to authorize a pod are determined by the
user identity and groups that the user belongs to. Additionally, if the pod
specifies a service account, the set of allowable SCCs includes any constraints
accessible to the service account.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>When you create a workload resource, such as a deployment, only the service account is used to find the SCCs and is used to admit the pods when they are created.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>When creating pods directly, SCCs admission considers SCC permissions of both the caller and the Service Account that runs the pod. When a pod is created by a pod controller such as a deployment or a job, only Service Account SCC permissions are considered.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Admission uses the following approach to create the final security context for
the pod:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieve all SCCs available for use.</p>
</li>
<li>
<p>Generate field values for security context settings that were not specified
on the request.</p>
</li>
<li>
<p>Validate the final settings against the available constraints.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If a matching set of constraints is found, then the pod is accepted. If the
request cannot be matched to an SCC, the pod is rejected.</p>
</div>
<div class="paragraph">
<p>A pod must validate every field against the SCC. The following are examples for
just two of the fields that must be validated:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>These examples are in the context of a strategy using the pre-allocated values.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>An FSGroup SCC strategy of <code>MustRunAs</code></strong></p>
</div>
<div class="paragraph">
<p>If the pod defines a <code>fsGroup</code> ID, then that ID must equal the default
<code>fsGroup</code> ID. Otherwise, the pod is not validated by that SCC and the next SCC
is evaluated.</p>
</div>
<div class="paragraph">
<p>If the <code>SecurityContextConstraints.fsGroup</code> field has value <code>RunAsAny</code>
and the pod specification omits the <code>Pod.spec.securityContext.fsGroup</code>,
then this field is considered valid. Note that it is possible that during
validation, other SCC settings will reject other pod fields and thus cause the
pod to fail.</p>
</div>
<div class="paragraph">
<p><strong>A <code>SupplementalGroups</code> SCC strategy of <code>MustRunAs</code></strong></p>
</div>
<div class="paragraph">
<p>If the pod specification defines one or more <code>supplementalGroups</code> IDs, then
the pod&#8217;s IDs must equal one of the IDs in the namespace&#8217;s
<code>openshift.io/sa.scc.supplemental-groups</code> annotation. Otherwise, the pod is not
validated by that SCC and the next SCC is evaluated.</p>
</div>
<div class="paragraph">
<p>If the <code>SecurityContextConstraints.supplementalGroups</code> field has value <code>RunAsAny</code>
and the pod specification omits the <code>Pod.spec.securityContext.supplementalGroups</code>,
then this field is considered valid. Note that it is possible that during
validation, other SCC settings will reject other pod fields and thus cause the
pod to fail.</p>
</div>
</div>
<div class="sect3">
<h4 id="scc-prioritization_configuring-internal-oauth">Security context constraints prioritization</h4>
<div class="paragraph">
<p>Security context constraints (SCCs) have a priority field that affects the ordering when attempting to validate a request by the admission controller.</p>
</div>
<div class="paragraph">
<p>A priority value of <code>0</code> is the lowest possible priority. A nil priority is considered a <code>0</code>, or lowest, priority. Higher priority SCCs are moved to the front of the set when sorting.</p>
</div>
<div class="paragraph">
<p>When the complete set of available SCCs is determined, the SCCs are ordered in the following manner:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The highest priority SCCs are ordered first.</p>
</li>
<li>
<p>If the priorities are equal, the SCCs are sorted from most restrictive to least restrictive.</p>
</li>
<li>
<p>If both the priorities and restrictions are equal, the SCCs are sorted by name.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By default, the <code>anyuid</code> SCC granted to cluster administrators is given priority
in their SCC set. This allows cluster administrators to run pods as any
user by specifying <code>RunAsUser</code> in the pod&#8217;s <code>SecurityContext</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-pre-allocated-values_configuring-internal-oauth">About pre-allocated security context constraints values</h3>
<div class="paragraph">
<p>The admission controller is aware of certain conditions in the security context
constraints (SCCs) that trigger it to look up pre-allocated values from a namespace and
populate the SCC before processing the pod. Each SCC
strategy is evaluated independently of other strategies, with the pre-allocated
values, where allowed, for each policy aggregated with pod specification values
to make the final values for the various IDs defined in the running pod.</p>
</div>
<div class="paragraph">
<p>The following SCCs cause the admission controller to look for pre-allocated
values when no ranges are defined in the pod specification:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>RunAsUser</code> strategy of <code>MustRunAsRange</code> with no minimum or maximum set.
Admission looks for the <code>openshift.io/sa.scc.uid-range</code> annotation to populate
range fields.</p>
</li>
<li>
<p>An <code>SELinuxContext</code> strategy of <code>MustRunAs</code> with no level set. Admission
looks for the <code>openshift.io/sa.scc.mcs</code> annotation to populate the level.</p>
</li>
<li>
<p>A <code>FSGroup</code> strategy of <code>MustRunAs</code>. Admission looks for the
<code>openshift.io/sa.scc.supplemental-groups</code> annotation.</p>
</li>
<li>
<p>A <code>SupplementalGroups</code> strategy of <code>MustRunAs</code>. Admission looks for the
<code>openshift.io/sa.scc.supplemental-groups</code> annotation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>During the generation phase, the security context provider uses default values
for any parameter values that are not specifically set in the pod. Default values
are based on the selected strategy:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>RunAsAny</code> and <code>MustRunAsNonRoot</code> strategies do not provide default
values. If the pod needs a parameter value, such as a group ID, you
must define the value in the pod specification.</p>
</li>
<li>
<p><code>MustRunAs</code> (single value) strategies provide a default value that is
always used. For example, for group IDs, even if the pod specification defines
its own ID value, the namespace&#8217;s default parameter value also appears in the pod&#8217;s
groups.</p>
</li>
<li>
<p><code>MustRunAsRange</code> and <code>MustRunAs</code> (range-based) strategies provide the
minimum value of the range. As with a single value <code>MustRunAs</code> strategy, the
namespace&#8217;s default parameter value appears in the running pod. If a range-based
strategy is configurable with multiple ranges, it provides the minimum value
of the first configured range.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>FSGroup</code> and <code>SupplementalGroups</code> strategies fall back to the
<code>openshift.io/sa.scc.uid-range</code> annotation if the
<code>openshift.io/sa.scc.supplemental-groups</code> annotation does not exist on the
namespace. If neither exists, the SCC is not created.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the annotation-based <code>FSGroup</code> strategy configures itself with a
single range based on the minimum value for the annotation. For example, if your
annotation reads <code>1/3</code>, the <code>FSGroup</code> strategy configures itself with a
minimum and maximum value of <code>1</code>. If you want to allow more groups to be accepted for
the <code>FSGroup</code> field, you can configure a custom SCC that does not use the
annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>openshift.io/sa.scc.supplemental-groups</code> annotation accepts a comma-delimited
list of blocks in the format of <code>&lt;start&gt;/&lt;length</code> or <code>&lt;start&gt;-&lt;end&gt;</code>.
The <code>openshift.io/sa.scc.uid-range</code> annotation accepts only a single block.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-example_configuring-internal-oauth">Example security context constraints</h3>
<div class="paragraph">
<p>The following examples show the security context constraints (SCC) format and
annotations:</p>
</div>
<div class="listingblock">
<div class="title">Annotated <code>privileged</code> SCC</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">allowHostDirVolumePlugin: true
allowHostIPC: true
allowHostNetwork: true
allowHostPID: true
allowHostPorts: true
allowPrivilegedContainer: true
allowedCapabilities: <b class="conum">(1)</b>
- '*'
apiVersion: security.openshift.io/v1
defaultAddCapabilities: [] <b class="conum">(2)</b>
fsGroup: <b class="conum">(3)</b>
  type: RunAsAny
groups: <b class="conum">(4)</b>
- system:cluster-admins
- system:nodes
kind: SecurityContextConstraints
metadata:
  annotations:
    kubernetes.io/description: 'privileged allows access to all privileged and host
      features and the ability to run as any user, any group, any fsGroup, and with
      any SELinux context.  WARNING: this is the most relaxed SCC and should be used
      only for cluster administration. Grant with caution.'
  creationTimestamp: null
  name: privileged
priority: null
readOnlyRootFilesystem: false
requiredDropCapabilities: <b class="conum">(5)</b>
- KILL
- MKNOD
- SETUID
- SETGID
runAsUser: <b class="conum">(6)</b>
  type: RunAsAny
seLinuxContext: <b class="conum">(7)</b>
  type: RunAsAny
seccompProfiles:
- '*'
supplementalGroups: <b class="conum">(8)</b>
  type: RunAsAny
users: <b class="conum">(9)</b>
- system:serviceaccount:default:registry
- system:serviceaccount:default:router
- system:serviceaccount:openshift-infra:build-controller
volumes: <b class="conum">(10)</b>
- '*'</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A list of capabilities that a pod can request. An empty list means
that none of capabilities can be requested while the special symbol <code><strong>*</strong></code>
allows any capabilities.</p>
</li>
<li>
<p>A list of additional capabilities that are added to any pod.</p>
</li>
<li>
<p>The <code>FSGroup</code> strategy, which dictates the allowable values for the
security context.</p>
</li>
<li>
<p>The groups that can access this SCC.</p>
</li>
<li>
<p>A list of capabilities to drop from a pod. Or, specify <code>ALL</code> to drop all
capabilities.</p>
</li>
<li>
<p>The <code>runAsUser</code> strategy type, which dictates the allowable values for the
security context.</p>
</li>
<li>
<p>The <code>seLinuxContext</code> strategy type, which dictates the allowable values for
the security context.</p>
</li>
<li>
<p>The <code>supplementalGroups</code> strategy, which dictates the allowable supplemental
groups for the security context.</p>
</li>
<li>
<p>The users who can access this SCC.</p>
</li>
<li>
<p>The allowable volume types for the security context. In the example, <code>*</code> allows the use of all volume types.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>users</code> and <code>groups</code> fields on the SCC control which users can access the
SCC.
By default, cluster administrators, nodes, and the build controller are granted
access to the privileged SCC. All authenticated users are granted access to the
<code>restricted-v2</code> SCC.</p>
</div>
<div class="listingblock">
<div class="title">Without explicit <code>runAsUser</code> setting</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: security-context-demo
spec:
  securityContext: <b class="conum">(1)</b>
  containers:
  - name: sec-ctx-demo
    image: gcr.io/google-samples/node-hello:1.0</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>When a container or pod does not request a user ID under which it should be run,
the effective UID depends on the SCC that emits this pod. Because the <code>restricted-v2</code> SCC
is granted to all authenticated users by default, it will be available to all
users and service accounts and used in most cases. The <code>restricted-v2</code> SCC uses
<code>MustRunAsRange</code> strategy for constraining and defaulting the possible values of
the <code>securityContext.runAsUser</code> field. The admission plugin will look for the
<code>openshift.io/sa.scc.uid-range</code> annotation on the current project to populate
range fields, as it does not provide this range. In the end, a container will
have <code>runAsUser</code> equal to the first value of the range that is
hard to predict because every project has different ranges.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">With explicit <code>runAsUser</code> setting</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: security-context-demo
spec:
  securityContext:
    runAsUser: 1000 <b class="conum">(1)</b>
  containers:
    - name: sec-ctx-demo
      image: gcr.io/google-samples/node-hello:1.0</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A container or pod that requests a specific user ID will be accepted by
OpenShift Container Platform only when a service account or a user is granted access to a SCC
that allows such a user ID. The SCC can allow arbitrary IDs, an ID that falls
into a range, or the exact user ID specific to the request.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This configuration is valid for SELinux, fsGroup, and Supplemental Groups.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-creating_configuring-internal-oauth">Creating security context constraints</h3>
<div class="paragraph">
<p>You can create security context constraints (SCCs) by using the OpenShift CLI (<code>oc</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Creating and modifying your own SCCs are advanced operations that might cause instability to your cluster. If you have questions about using your own SCCs, contact Red Hat Support. For information about contacting Red Hat support, see <em>Getting support</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install the OpenShift CLI (<code>oc</code>).</p>
</li>
<li>
<p>Log in to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define the SCC in a YAML file named <code>scc-admin.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: SecurityContextConstraints
apiVersion: security.openshift.io/v1
metadata:
  name: scc-admin
allowPrivilegedContainer: true
runAsUser:
  type: RunAsAny
seLinuxContext:
  type: RunAsAny
fsGroup:
  type: RunAsAny
supplementalGroups:
  type: RunAsAny
users:
- my-admin-user
groups:
- my-admin-group</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can drop specific capabilities for an SCC by setting the <code>requiredDropCapabilities</code> field with the desired values. Any specified capabilities are dropped from the container. To drop all capabilities, specify <code>ALL</code>. For example, to create an SCC that drops the <code>KILL</code>, <code>MKNOD</code>, and <code>SYS_CHROOT</code> capabilities, add the following to the SCC object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">requiredDropCapabilities:
- KILL
- MKNOD
- SYS_CHROOT</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot list a capability in both <code>allowedCapabilities</code> and <code>requiredDropCapabilities</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>CRI-O supports the same list of capability values that are found in the <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">Docker documentation</a>.</p>
</div>
</li>
<li>
<p>Create the SCC by passing in the file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f scc-admin.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">securitycontextconstraints "scc-admin" created</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>Verify that the SCC was created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get scc scc-admin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME        PRIV      CAPS      SELINUX    RUNASUSER   FSGROUP    SUPGROUP   PRIORITY   READONLYROOTFS   VOLUMES
scc-admin   true      []        RunAsAny   RunAsAny    RunAsAny   RunAsAny   &lt;none&gt;     false            [awsElasticBlockStore azureDisk azureFile cephFS cinder configMap downwardAPI emptyDir fc flexVolume flocker gcePersistentDisk gitRepo glusterfs iscsi nfs persistentVolumeClaim photonPersistentDisk quobyte rbd secret vsphere]</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="role-based-access-to-ssc_configuring-internal-oauth">Role-based access to security context constraints</h3>
<div class="paragraph">
<p>You can specify SCCs as resources that are handled by RBAC. This allows
you to scope access to your SCCs to a certain project or to the entire
cluster. Assigning users, groups, or service accounts directly to an
SCC retains cluster-wide scope.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot assign a SCC to pods created in one of the default namespaces: <code>default</code>, <code>kube-system</code>, <code>kube-public</code>, <code>openshift-node</code>, <code>openshift-infra</code>, <code>openshift</code>. These namespaces should not be used for running pods or services.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To include access to SCCs for your role, specify the <code>scc</code> resource
when creating a role.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create role &lt;role-name&gt; --verb=use --resource=scc --resource-name=&lt;scc-name&gt; -n &lt;namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following role definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
...
  name: role-name <b class="conum">(1)</b>
  namespace: namespace <b class="conum">(2)</b>
...
rules:
- apiGroups:
  - security.openshift.io <b class="conum">(3)</b>
  resourceNames:
  - scc-name <b class="conum">(4)</b>
  resources:
  - securitycontextconstraints <b class="conum">(5)</b>
  verbs: <b class="conum">(6)</b>
  - use</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The role&#8217;s name.</p>
</li>
<li>
<p>Namespace of the defined role. Defaults to <code>default</code> if not specified.</p>
</li>
<li>
<p>The API group that includes the <code>SecurityContextConstraints</code> resource.
Automatically defined when <code>scc</code> is specified as a resource.</p>
</li>
<li>
<p>An example name for an SCC you want to have access.</p>
</li>
<li>
<p>Name of the resource group that allows users to specify SCC names in
the <code>resourceNames</code> field.</p>
</li>
<li>
<p>A list of verbs to apply to the role.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A local or cluster role with such a rule allows the subjects that are
bound to it with a role binding or a cluster role binding to use the
user-defined SCC called <code>scc-name</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Because RBAC is designed to prevent escalation, even project administrators
are unable to grant access to an SCC. By default, they are not
allowed to use the verb <code>use</code> on SCC resources, including the
<code>restricted-v2</code> SCC.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-command-reference_configuring-internal-oauth">Reference of security context constraints commands</h3>
<div class="paragraph">
<p>You can manage security context constraints (SCCs) in your instance as normal API objects using the OpenShift CLI (<code>oc</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You must have <code>cluster-admin</code> privileges to manage SCCs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="listing-security-context-constraints_configuring-internal-oauth">Listing security context constraints</h4>
<div class="paragraph">
<p>To get a current list of SCCs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get scc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">NAME                              PRIV    CAPS                   SELINUX     RUNASUSER          FSGROUP     SUPGROUP    PRIORITY     READONLYROOTFS   VOLUMES
anyuid                            false   &lt;no value&gt;             MustRunAs   RunAsAny           RunAsAny    RunAsAny    10           false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
hostaccess                        false   &lt;no value&gt;             MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","hostPath","persistentVolumeClaim","projected","secret"]
hostmount-anyuid                  false   &lt;no value&gt;             MustRunAs   RunAsAny           RunAsAny    RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","hostPath","nfs","persistentVolumeClaim","projected","secret"]
hostnetwork                       false   &lt;no value&gt;             MustRunAs   MustRunAsRange     MustRunAs   MustRunAs   &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
hostnetwork-v2                    false   ["NET_BIND_SERVICE"]   MustRunAs   MustRunAsRange     MustRunAs   MustRunAs   &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
node-exporter                     true    &lt;no value&gt;             RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;no value&gt;   false            ["*"]
nonroot                           false   &lt;no value&gt;             MustRunAs   MustRunAsNonRoot   RunAsAny    RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
nonroot-v2                        false   ["NET_BIND_SERVICE"]   MustRunAs   MustRunAsNonRoot   RunAsAny    RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
privileged                        true    ["*"]                  RunAsAny    RunAsAny           RunAsAny    RunAsAny    &lt;no value&gt;   false            ["*"]
restricted                        false   &lt;no value&gt;             MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]
restricted-v2                     false   ["NET_BIND_SERVICE"]   MustRunAs   MustRunAsRange     MustRunAs   RunAsAny    &lt;no value&gt;   false            ["configMap","downwardAPI","emptyDir","persistentVolumeClaim","projected","secret"]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="examining-a-security-context-constraints-object_configuring-internal-oauth">Examining security context constraints</h4>
<div class="paragraph">
<p>You can view information about a particular SCC, including which users, service accounts, and groups the SCC is applied to.</p>
</div>
<div class="paragraph">
<p>For example, to examine the <code>restricted</code> SCC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc describe scc restricted</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Name:                                  restricted
Priority:                              &lt;none&gt;
Access:
  Users:                               &lt;none&gt; <b class="conum">(1)</b>
  Groups:                              &lt;none&gt; <b class="conum">(2)</b>
Settings:
  Allow Privileged:                    false
  Allow Privilege Escalation:          true
  Default Add Capabilities:            &lt;none&gt;
  Required Drop Capabilities:          KILL,MKNOD,SETUID,SETGID
  Allowed Capabilities:                &lt;none&gt;
  Allowed Seccomp Profiles:            &lt;none&gt;
  Allowed Volume Types:                configMap,downwardAPI,emptyDir,persistentVolumeClaim,projected,secret
  Allowed Flexvolumes:                 &lt;all&gt;
  Allowed Unsafe Sysctls:              &lt;none&gt;
  Forbidden Sysctls:                   &lt;none&gt;
  Allow Host Network:                  false
  Allow Host Ports:                    false
  Allow Host PID:                      false
  Allow Host IPC:                      false
  Read Only Root Filesystem:           false
  Run As User Strategy: MustRunAsRange
    UID:                               &lt;none&gt;
    UID Range Min:                     &lt;none&gt;
    UID Range Max:                     &lt;none&gt;
  SELinux Context Strategy: MustRunAs
    User:                              &lt;none&gt;
    Role:                              &lt;none&gt;
    Type:                              &lt;none&gt;
    Level:                             &lt;none&gt;
  FSGroup Strategy: MustRunAs
    Ranges:                            &lt;none&gt;
  Supplemental Groups Strategy: RunAsAny
    Ranges:                            &lt;none&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Lists which users and service accounts the SCC is applied to.</p>
</li>
<li>
<p>Lists which groups the SCC is applied to.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>To preserve customized SCCs during upgrades, do not edit settings on
the default SCCs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="deleting-security-context-constraints_configuring-internal-oauth">Deleting security context constraints</h4>
<div class="paragraph">
<p>To delete an SCC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete scc &lt;scc_name&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you delete a default SCC, it will regenerate when you restart the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="updating-security-context-constraints_configuring-internal-oauth">Updating security context constraints</h4>
<div class="paragraph">
<p>To update an existing SCC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit scc &lt;scc_name&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>To preserve customized SCCs during upgrades, do not edit settings on
the default SCCs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 _additional-resources">
<h3 id="additional-resources_configuring-internal-oauth">Additional resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/support/#getting-support">Getting support</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-and-managing-pod-security-admission">Understanding and managing pod security admission</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pod security admission is an implementation of the <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/">Kubernetes pod security standards</a>. Use pod security admission to restrict the behavior of pods.</p>
</div>
<div class="sect2">
<h3 id="security-context-constraints-psa-synchronization_understanding-and-managing-pod-security-admission">Security context constraint synchronization with pod security standards</h3>
<div class="paragraph">
<p>OpenShift Container Platform includes <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission">Kubernetes pod security admission</a>. Globally, the <code>privileged</code> profile is enforced, and the <code>restricted</code> profile is used for warnings and audits.</p>
</div>
<div class="paragraph">
<p>In addition to the global pod security admission control configuration, a controller exists that applies pod security admission control <code>warn</code> and <code>audit</code> labels to namespaces according to the SCC permissions of the service accounts that are in a given namespace.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Namespaces that are defined as part of the cluster payload have pod security admission synchronization disabled permanently. You can enable pod security admission synchronization on other namespaces as necessary. If an Operator is installed in a user-created <code>openshift-*</code> namespace, synchronization is turned on by default after a cluster service version (CSV) is created in the namespace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The controller examines <code>ServiceAccount</code> object permissions to use security context constraints in each namespace. Security context constraints (SCCs) are mapped to pod security profiles based on their field values; the controller uses these translated profiles. Pod security admission <code>warn</code> and <code>audit</code> labels are set to the most privileged pod security profile found in the namespace to prevent warnings and audit logging as pods are created.</p>
</div>
<div class="paragraph">
<p>Namespace labeling is based on consideration of namespace-local service account privileges.</p>
</div>
<div class="paragraph">
<p>Applying pods directly might use the SCC privileges of the user who runs the pod. However, user privileges are not considered during automatic labeling.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-psa-opting_understanding-and-managing-pod-security-admission">Controlling pod security admission synchronization</h3>
<div class="paragraph">
<p>You can enable or disable automatic pod security admission synchronization for most namespaces.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Namespaces that are defined as part of the cluster payload have pod security admission synchronization disabled permanently. These namespaces include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default</code></p>
</li>
<li>
<p><code>kube-node-lease</code></p>
</li>
<li>
<p><code>kube-system</code></p>
</li>
<li>
<p><code>kube-public</code></p>
</li>
<li>
<p><code>openshift</code></p>
</li>
<li>
<p>All system-created namespaces that are prefixed with <code>openshift-</code>, except for <code>openshift-operators</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, all namespaces that have an <code>openshift-</code> prefix are not synchronized. You can enable synchronization for any user-created <code>openshift-*</code> namespaces. You cannot enable synchronization for any system-created <code>openshift-*</code> namespaces, except for <code>openshift-operators</code>.</p>
</div>
<div class="paragraph">
<p>If an Operator is installed in a user-created <code>openshift-*</code> namespace, synchronization is turned on by default after a cluster service version (CSV) is created in the namespace. The synchronized label inherits the permissions of the service accounts in the namespace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>For each namespace that you want to configure, set a value for the <code>security.openshift.io/scc.podSecurityLabelSync</code> label:</p>
<div class="ulist">
<ul>
<li>
<p>To disable pod security admission label synchronization in a namespace, set the value of the <code>security.openshift.io/scc.podSecurityLabelSync</code> label to <code>false</code>.</p>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc label namespace &lt;namespace&gt; security.openshift.io/scc.podSecurityLabelSync=false</code></pre>
</div>
</div>
</li>
<li>
<p>To enable pod security admission label synchronization in a namespace, set the value of the <code>security.openshift.io/scc.podSecurityLabelSync</code> label to <code>true</code>.</p>
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc label namespace &lt;namespace&gt; security.openshift.io/scc.podSecurityLabelSync=true</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="security-context-constraints-psa-rectifying_understanding-and-managing-pod-security-admission">About pod security admission alerts</h3>
<div class="paragraph">
<p>A <code>PodSecurityViolation</code> alert is triggered when the Kubernetes API server reports that there is a pod denial on the audit level of the pod security admission controller. This alert persists for one day.</p>
</div>
<div class="paragraph">
<p>View the Kubernetes API server audit logs to investigate alerts that were triggered. As an example, a workload is likely to fail admission if global enforcement is set to the <code>restricted</code> pod security level.</p>
</div>
<div class="paragraph">
<p>For assistance in identifying pod security admission violation audit events, see <a href="https://kubernetes.io/docs/reference/labels-annotations-taints/audit-annotations/#pod-security-kubernetes-io-audit-violations">Audit annotations</a> in the Kubernetes documentation.</p>
</div>
<div class="sect3">
<h4 id="security-context-constraints-psa-alert-eval_understanding-and-managing-pod-security-admission">Identifying pod security violations</h4>
<div class="paragraph">
<p>The <code>PodSecurityViolation</code> alert does not provide details on which workloads are causing pod security violations. You can identify the affected workloads by reviewing the Kubernetes API server audit logs. This procedure uses the <code>must-gather</code> tool to gather the audit logs and then searches for the <code>pod-security.kubernetes.io/audit-violations</code> annotation.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have installed <code>jq</code>.</p>
</li>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To gather the audit logs, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm must-gather -- /usr/bin/gather_audit_logs</code></pre>
</div>
</div>
</li>
<li>
<p>To output the affected workload details, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ zgrep -h pod-security.kubernetes.io/audit-violations must-gather.local.&lt;archive_id&gt;/quay*/audit_logs/kube-apiserver/*log.gz \
  | jq -r 'select((.annotations["pod-security.kubernetes.io/audit-violations"] != null) and (.objectRef.resource=="pods")) | .objectRef.namespace + " " + .objectRef.name + " " + .objectRef.resource' \
  | sort | uniq -c</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>must-gather.local.&lt;archive_id&gt;</code> with the actual directory name.</p>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-text" data-lang="text">15 ci namespace-ttl-controller deployments
 1 ci-op-k5whzrsh rpm-repo-546f98d8b replicasets
 1 ci-op-k5whzrsh rpm-repo deployments</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2 _additional-resources">
<h3 id="additional-resources_managing-pod-security-admission">Additional resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/security_and_compliance/#nodes-nodes-audit-log-basic-viewing_audit-log-view">Viewing audit logs</a></p>
</li>
<li>
<p><a href="#managing-pod-security-policies">Managing security context constraints</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="impersonating-system-admin">Impersonating the system:admin user</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="authentication-api-impersonation_impersonating-system-admin">API impersonation</h3>
<div class="paragraph">
<p>You can configure a request to the OpenShift Container Platform API to act as though it originated from another user. For more information, see <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation">User impersonation</a> in the Kubernetes documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="impersonation-system-admin-user_impersonating-system-admin">Impersonating the system:admin user</h3>
<div class="paragraph">
<p>You can grant a user permission to impersonate <code>system:admin</code>, which grants them
cluster administrator permissions.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To grant a user permission to impersonate <code>system:admin</code>, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create clusterrolebinding &lt;any_valid_name&gt; --clusterrole=sudoer --user=&lt;username&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can alternatively apply the following YAML to grant permission to impersonate <code>system:admin</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: &lt;any_valid_name&gt;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sudoer
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: &lt;username&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="impersonation-system-admin-group_impersonating-system-admin">Impersonating the system:admin group</h3>
<div class="paragraph">
<p>When a <code>system:admin</code> user is granted cluster administration permissions through a group, you must include the
<code>--as=&lt;user&gt; --as-group=&lt;group1&gt; --as-group=&lt;group2&gt;</code> parameters in the command to impersonate the associated groups.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To grant a user permission to impersonate a <code>system:admin</code> by impersonating the associated cluster administration groups,
run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create clusterrolebinding &lt;any_valid_name&gt; --clusterrole=sudoer --as=&lt;user&gt; \
--as-group=&lt;group1&gt; --as-group=&lt;group2&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ldap-syncing">Syncing LDAP groups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an administrator,
you can use groups to manage users, change
their permissions, and enhance collaboration. Your organization may have already
created user groups and stored them in an LDAP server. OpenShift Container Platform can sync
those LDAP records with internal OpenShift Container Platform records, enabling you to manage
your groups in one place. OpenShift Container Platform currently supports group sync with
LDAP servers using three common schemas for defining group membership: RFC 2307,
Active Directory, and augmented Active Directory.</p>
</div>
<div class="paragraph">
<p>For more information on configuring LDAP, see
<a href="#configuring-ldap-identity-provider">Configuring an LDAP identity provider</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You must have <code>cluster-admin</code> privileges to sync groups.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ldap-syncing-about_ldap-syncing-groups">About configuring LDAP sync</h3>
<div class="paragraph">
<p>Before you can run LDAP sync, you need a sync
configuration file. This file contains the following LDAP client configuration details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration for connecting to your LDAP server.</p>
</li>
<li>
<p>Sync configuration options that are dependent on the schema used in your LDAP
server.</p>
</li>
<li>
<p>An administrator-defined list of name mappings that maps OpenShift Container Platform group names to groups in your LDAP server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The format of the configuration file depends upon the schema you are using: RFC 2307, Active Directory, or augmented Active Directory.</p>
</div>
<div id="ldap-client-configuration" class="dlist">
<dl>
<dt class="hdlist1">LDAP client configuration</dt>
<dd>
<p>The LDAP client configuration section of the configuration defines the connections to your LDAP server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The LDAP client configuration section of the configuration defines the connections to your LDAP server.</p>
</div>
<div class="listingblock">
<div class="title">LDAP client configuration</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">url: ldap://10.0.0.0:389 <b class="conum">(1)</b>
bindDN: cn=admin,dc=example,dc=com <b class="conum">(2)</b>
bindPassword: password <b class="conum">(3)</b>
insecure: false <b class="conum">(4)</b>
ca: my-ldap-ca-bundle.crt <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The connection protocol, IP address of the LDAP server hosting your
database, and the port to connect to, formatted as <code>scheme://host:port</code>.</p>
</li>
<li>
<p>Optional distinguished name (DN) to use as the Bind DN.
OpenShift Container Platform uses this if elevated privilege is required to retrieve entries for
the sync operation.</p>
</li>
<li>
<p>Optional password to use to bind. OpenShift Container Platform uses this if elevated privilege is
necessary to retrieve entries for the sync operation. This value may also be
provided in an environment variable, external file, or encrypted file.</p>
</li>
<li>
<p>When <code>false</code>, secure
LDAP (<code>ldaps://</code>) URLs connect using TLS, and insecure LDAP (<code>ldap://</code>) URLs are
upgraded to TLS. When <code>true</code>, no TLS connection is made to the server and you cannot use <code>ldaps://</code> URL schemes.</p>
</li>
<li>
<p>The certificate bundle to use for validating server certificates for the
configured URL. If empty, OpenShift Container Platform uses system-trusted roots. This only applies
if <code>insecure</code> is set to <code>false</code>.</p>
</li>
</ol>
</div>
<div id="ldap-query-definition" class="dlist">
<dl>
<dt class="hdlist1">LDAP query definition</dt>
<dd>
<p>Sync configurations consist of LDAP query definitions for the entries that are
required for synchronization. The specific definition of an LDAP query depends
on the schema used to store membership information in the LDAP server.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">LDAP query definition</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">baseDN: ou=users,dc=example,dc=com <b class="conum">(1)</b>
scope: sub <b class="conum">(2)</b>
derefAliases: never <b class="conum">(3)</b>
timeout: 0 <b class="conum">(4)</b>
filter: (objectClass=person) <b class="conum">(5)</b>
pageSize: 0 <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The distinguished name (DN) of the branch of the directory where all
searches will start from. It is required that you specify the top of your
directory tree, but you can also specify a subtree in the directory.</p>
</li>
<li>
<p>The scope of the search. Valid values are <code>base</code>, <code>one</code>, or <code>sub</code>. If this
is left undefined, then a scope of <code>sub</code> is assumed. Descriptions of the scope
options can be found in the table below.</p>
</li>
<li>
<p>The behavior of the search with respect to aliases in the LDAP tree. Valid
values are <code>never</code>, <code>search</code>, <code>base</code>, or <code>always</code>. If this is left undefined,
then the default is to <code>always</code> dereference aliases. Descriptions of the
dereferencing behaviors can be found in the table below.</p>
</li>
<li>
<p>The time limit allowed for the search by the client, in seconds. A value of
<code>0</code> imposes no client-side limit.</p>
</li>
<li>
<p>A valid LDAP search filter. If this is left undefined, then the default is
<code>(objectClass=*)</code>.</p>
</li>
<li>
<p>The optional maximum size of response pages from the server, measured in LDAP
entries. If set to <code>0</code>, no size restrictions will be made on pages of responses.
Setting paging sizes is necessary when queries return more entries than the
client or server allow by default.</p>
</li>
</ol>
</div>
<table id="ldap-search" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. LDAP search scope options</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LDAP search scope</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>base</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Only consider the object specified by the base DN given for the query.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>one</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Consider all of the objects on the same level in the tree as the base DN for
the query.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>sub</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Consider the entire subtree rooted at the base DN given for the query.</p>
</div></div></td>
</tr>
</tbody>
</table>
<table id="deref-aliases" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. LDAP dereferencing behaviors</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Dereferencing behavior</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>never</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Never dereference any aliases found in the LDAP tree.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>search</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Only dereference aliases found while searching.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>base</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Only dereference aliases while finding the base object.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><code>always</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Always dereference all aliases found in the LDAP tree.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="user-defined-name-mapping" class="dlist">
<dl>
<dt class="hdlist1">User-defined name mapping</dt>
<dd>
<p>A user-defined name mapping explicitly maps the names of OpenShift Container Platform groups to
unique identifiers that find groups on your LDAP server. The mapping uses normal
YAML syntax. A user-defined mapping can contain an entry for every group in your
LDAP server or only a subset of those groups. If there are groups on the LDAP
server that do not have a user-defined name mapping, the default behavior during
sync is to use the attribute specified as the OpenShift Container Platform group&#8217;s name.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">User-defined name mapping</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">groupUIDNameMapping:
  "cn=group1,ou=groups,dc=example,dc=com": firstgroup
  "cn=group2,ou=groups,dc=example,dc=com": secondgroup
  "cn=group3,ou=groups,dc=example,dc=com": thirdgroup</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-config-rfc2307_ldap-syncing-groups">About the RFC 2307 configuration file</h4>
<div class="paragraph">
<p>The RFC 2307 schema requires you to provide an LDAP query definition for both user
and group entries, as well as the attributes with which to represent them in the
internal OpenShift Container Platform records.</p>
</div>
<div class="paragraph">
<p>For clarity, the group you create in OpenShift Container Platform should use attributes other
than the distinguished name whenever possible for user- or administrator-facing
fields. For example, identify the users of an OpenShift Container Platform group by their e-mail, and use the
name of the group as the common name. The following configuration file creates
these relationships:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If using user-defined name mappings, your configuration file will differ.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses RFC 2307 schema: <code>rfc2307_config.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://LDAP_SERVICE_IP:389 <b class="conum">(1)</b>
insecure: false <b class="conum">(2)</b>
rfc2307:
    groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    groupUIDAttribute: dn <b class="conum">(3)</b>
    groupNameAttributes: [ cn ] <b class="conum">(4)</b>
    groupMembershipAttributes: [ member ] <b class="conum">(5)</b>
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    userUIDAttribute: dn <b class="conum">(6)</b>
    userNameAttributes: [ mail ] <b class="conum">(7)</b>
    tolerateMemberNotFoundErrors: false
    tolerateMemberOutOfScopeErrors: false</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The IP address and host of the LDAP server where this group&#8217;s record is
stored.</p>
</li>
<li>
<p>When <code>false</code>, secure
LDAP (<code>ldaps://</code>) URLs connect using TLS, and insecure LDAP (<code>ldap://</code>) URLs are
upgraded to TLS. When <code>true</code>, no TLS connection is made to the server and you cannot use <code>ldaps://</code> URL schemes.</p>
</li>
<li>
<p>The attribute that uniquely identifies a group on the LDAP server.
You cannot specify <code>groupsQuery</code> filters when using DN for <code>groupUIDAttribute</code>.
For fine-grained filtering, use the whitelist / blacklist method.</p>
</li>
<li>
<p>The attribute to use as the name of the group.</p>
</li>
<li>
<p>The attribute on the group that stores the membership information.</p>
</li>
<li>
<p>The attribute that uniquely identifies a user on the LDAP server. You
cannot specify <code>usersQuery</code> filters when using DN for userUIDAttribute. For
fine-grained  filtering, use the whitelist / blacklist method.</p>
</li>
<li>
<p>The attribute to use as the name of the user in the OpenShift Container Platform group record.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-config-activedir_ldap-syncing-groups">About the Active Directory configuration file</h4>
<div class="paragraph">
<p>The Active Directory schema requires you to provide an LDAP query definition for
user entries, as well as the attributes to represent them with in the internal
OpenShift Container Platform group records.</p>
</div>
<div class="paragraph">
<p>For clarity, the group you create in OpenShift Container Platform should use attributes other
than the distinguished name whenever possible for user- or administrator-facing
fields. For example, identify the users of an OpenShift Container Platform group by their e-mail, but define
the name of the group by the name of the group on the LDAP server.
The following configuration file creates these relationships:</p>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses Active Directory schema: <code>active_directory_config.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://LDAP_SERVICE_IP:389
activeDirectory:
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        filter: (objectclass=person)
        pageSize: 0
    userNameAttributes: [ mail ] <b class="conum">(1)</b>
    groupMembershipAttributes: [ memberOf ] <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The attribute to use as the name of the user in the OpenShift Container Platform group record.</p>
</li>
<li>
<p>The attribute on the user that stores the membership information.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-config-augmented-activedir_ldap-syncing-groups">About the augmented Active Directory configuration file</h4>
<div class="paragraph">
<p>The augmented Active Directory schema requires you to provide an LDAP query
definition for both user entries and group entries, as well as the attributes
with which to represent them in the internal OpenShift Container Platform group records.</p>
</div>
<div class="paragraph">
<p>For clarity, the group you create in OpenShift Container Platform should use attributes other
than the distinguished name whenever possible for user- or administrator-facing
fields. For example, identify the users of an OpenShift Container Platform group by their e-mail,
and use the name of the group as the common name. The following configuration
file creates these relationships.</p>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses augmented Active Directory schema: <code>augmented_active_directory_config.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://LDAP_SERVICE_IP:389
augmentedActiveDirectory:
    groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    groupUIDAttribute: dn <b class="conum">(1)</b>
    groupNameAttributes: [ cn ] <b class="conum">(2)</b>
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        filter: (objectclass=person)
        pageSize: 0
    userNameAttributes: [ mail ] <b class="conum">(3)</b>
    groupMembershipAttributes: [ memberOf ] <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The attribute that uniquely identifies a group on the LDAP server. You
cannot specify <code>groupsQuery</code> filters when using DN for groupUIDAttribute. For
fine-grained filtering, use the whitelist / blacklist method.</p>
</li>
<li>
<p>The attribute to use as the name of the group.</p>
</li>
<li>
<p>The attribute to use as the name of the user in the OpenShift Container Platform group record.</p>
</li>
<li>
<p>The attribute on the user that stores the membership information.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ldap-syncing-running_ldap-syncing-groups">Running LDAP sync</h3>
<div class="paragraph">
<p>Once you have created a sync configuration file,
you can begin to sync. OpenShift Container Platform allows administrators to perform a number of
different sync types with the same server.</p>
</div>
<div class="sect3">
<h4 id="ldap-syncing-running-all-ldap_ldap-syncing-groups">Syncing the LDAP server with OpenShift Container Platform</h4>
<div class="paragraph">
<p>You can sync all groups from the LDAP server with OpenShift Container Platform.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a sync configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To sync all groups from the LDAP server with OpenShift Container Platform:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=config.yaml --confirm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, all group synchronization operations are dry-run, so you
must set the <code>--confirm</code> flag on the <code>oc adm groups sync</code> command to make
changes to OpenShift Container Platform group records.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-running-openshift_ldap-syncing-groups">Syncing OpenShift Container Platform groups with the LDAP server</h4>
<div class="paragraph">
<p>You can sync all groups already in OpenShift Container Platform that correspond to groups in the
LDAP server specified in the configuration file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a sync configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To sync OpenShift Container Platform groups with the LDAP server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --type=openshift --sync-config=config.yaml --confirm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, all group synchronization operations are dry-run, so you
must set the <code>--confirm</code> flag on the <code>oc adm groups sync</code> command to make
changes to OpenShift Container Platform group records.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-running-subset_ldap-syncing-groups">Syncing subgroups from the LDAP server with OpenShift Container Platform</h4>
<div class="paragraph">
<p>You can sync a subset of LDAP groups with OpenShift Container Platform using whitelist files,
blacklist files, or both.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can use any combination of blacklist files, whitelist files, or whitelist
literals. Whitelist and blacklist files must contain one unique group identifier
per line, and you can include whitelist literals directly in the command itself.
These guidelines apply to groups found on LDAP servers as well as groups already
present in OpenShift Container Platform.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a sync configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To sync a subset of LDAP groups with OpenShift Container Platform, use any the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --whitelist=&lt;whitelist_file&gt; \
                   --sync-config=config.yaml      \
                   --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --blacklist=&lt;blacklist_file&gt; \
                   --sync-config=config.yaml      \
                   --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync &lt;group_unique_identifier&gt;    \
                   --sync-config=config.yaml      \
                   --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync &lt;group_unique_identifier&gt;  \
                   --whitelist=&lt;whitelist_file&gt; \
                   --blacklist=&lt;blacklist_file&gt; \
                   --sync-config=config.yaml    \
                   --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --type=openshift           \
                   --whitelist=&lt;whitelist_file&gt; \
                   --sync-config=config.yaml    \
                   --confirm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, all group synchronization operations are dry-run, so you
must set the <code>--confirm</code> flag on the <code>oc adm groups sync</code> command to make
changes to OpenShift Container Platform group records.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ldap-syncing-pruning_ldap-syncing-groups">Running a group pruning job</h3>
<div class="paragraph">
<p>An administrator can also choose to remove groups from OpenShift Container Platform records
if the records on the LDAP server that created them are no longer present. The
prune job will accept the same sync configuration file and whitelists or blacklists
as used for the sync job.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm prune groups --sync-config=/path/to/ldap-sync-config.yaml --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm prune groups --whitelist=/path/to/whitelist.txt --sync-config=/path/to/ldap-sync-config.yaml --confirm</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm prune groups --blacklist=/path/to/blacklist.txt --sync-config=/path/to/ldap-sync-config.yaml --confirm</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ldap-auto-syncing_ldap-syncing-groups">Automatically syncing LDAP groups</h3>
<div class="paragraph">
<p>You can automatically sync LDAP groups on a periodic basis by configuring a cron job.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>You have configured an LDAP identity provider (IDP).</p>
<div class="paragraph">
<p>This procedure assumes that you created an LDAP secret named <code>ldap-secret</code> and a config map named <code>ca-config-map</code>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a project where the cron job will run:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc new-project ldap-sync <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This procedure uses a project called <code>ldap-sync</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Locate the secret and config map that you created when configuring the LDAP identity provider and copy them to this new project.</p>
<div class="paragraph">
<p>The secret and config map exist in the <code>openshift-config</code> project and must be copied to the new <code>ldap-sync</code> project.</p>
</div>
</li>
<li>
<p>Define a service account:</p>
<div class="listingblock">
<div class="title">Example <code>ldap-sync-service-account.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ServiceAccount
apiVersion: v1
metadata:
  name: ldap-group-syncer
  namespace: ldap-sync</code></pre>
</div>
</div>
</li>
<li>
<p>Create the service account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f ldap-sync-service-account.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Define a cluster role:</p>
<div class="listingblock">
<div class="title">Example <code>ldap-sync-cluster-role.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ldap-group-syncer
rules:
  - apiGroups:
      - ''
      - user.openshift.io
    resources:
      - groups
    verbs:
      - get
      - list
      - create
      - update</code></pre>
</div>
</div>
</li>
<li>
<p>Create the cluster role:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f ldap-sync-cluster-role.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Define a cluster role binding to bind the cluster role to the service account:</p>
<div class="listingblock">
<div class="title">Example <code>ldap-sync-cluster-role-binding.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ldap-group-syncer
subjects:
  - kind: ServiceAccount
    name: ldap-group-syncer              <b class="conum">(1)</b>
    namespace: ldap-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ldap-group-syncer                <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Reference to the service account created earlier in this procedure.</p>
</li>
<li>
<p>Reference to the cluster role created earlier in this procedure.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the cluster role binding:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f ldap-sync-cluster-role-binding.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Define a config map that specifies the sync configuration file:</p>
<div class="listingblock">
<div class="title">Example <code>ldap-sync-config-map.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: ConfigMap
apiVersion: v1
metadata:
  name: ldap-group-syncer
  namespace: ldap-sync
data:
  sync.yaml: |                                 <b class="conum">(1)</b>
    kind: LDAPSyncConfig
    apiVersion: v1
    url: ldaps://10.0.0.0:389                  <b class="conum">(2)</b>
    insecure: false
    bindDN: cn=admin,dc=example,dc=com         <b class="conum">(3)</b>
    bindPassword:
      file: "/etc/secrets/bindPassword"
    ca: /etc/ldap-ca/ca.crt
    rfc2307:                                   <b class="conum">(4)</b>
      groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"  <b class="conum">(5)</b>
        scope: sub
        filter: "(objectClass=groupOfMembers)"
        derefAliases: never
        pageSize: 0
      groupUIDAttribute: dn
      groupNameAttributes: [ cn ]
      groupMembershipAttributes: [ member ]
      usersQuery:
        baseDN: "ou=users,dc=example,dc=com"   <b class="conum">(6)</b>
        scope: sub
        derefAliases: never
        pageSize: 0
      userUIDAttribute: dn
      userNameAttributes: [ uid ]
      tolerateMemberNotFoundErrors: false
      tolerateMemberOutOfScopeErrors: false</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Define the sync configuration file.</p>
</li>
<li>
<p>Specify the URL.</p>
</li>
<li>
<p>Specify the <code>bindDN</code>.</p>
</li>
<li>
<p>This example uses the RFC2307 schema; adjust values as necessary. You can also use a different schema.</p>
</li>
<li>
<p>Specify the <code>baseDN</code> for <code>groupsQuery</code>.</p>
</li>
<li>
<p>Specify the <code>baseDN</code> for <code>usersQuery</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the config map:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f ldap-sync-config-map.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Define a cron job:</p>
<div class="listingblock">
<div class="title">Example <code>ldap-sync-cron-job.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: CronJob
apiVersion: batch/v1
metadata:
  name: ldap-group-syncer
  namespace: ldap-sync
spec:                                                                                <b class="conum">(1)</b>
  schedule: "*/30 * * * *"                                                           <b class="conum">(2)</b>
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 1800                                                  <b class="conum">(3)</b>
      template:
        spec:
          containers:
            - name: ldap-group-sync
              image: "registry.redhat.io/openshift4/ose-cli:latest"
              command:
                - "/bin/bash"
                - "-c"
                - "oc adm groups sync --sync-config=/etc/config/sync.yaml --confirm" <b class="conum">(4)</b>
              volumeMounts:
                - mountPath: "/etc/config"
                  name: "ldap-sync-volume"
                - mountPath: "/etc/secrets"
                  name: "ldap-bind-password"
                - mountPath: "/etc/ldap-ca"
                  name: "ldap-ca"
          volumes:
            - name: "ldap-sync-volume"
              configMap:
                name: "ldap-group-syncer"
            - name: "ldap-bind-password"
              secret:
                secretName: "ldap-secret"                                            <b class="conum">(5)</b>
            - name: "ldap-ca"
              configMap:
                name: "ca-config-map"                                                <b class="conum">(6)</b>
          restartPolicy: "Never"
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 500
          dnsPolicy: "ClusterFirst"
          serviceAccountName: "ldap-group-syncer"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configure the settings for the cron job. See "Creating cron jobs" for more information on cron job settings.</p>
</li>
<li>
<p>The schedule for the job specified in <a href="https://en.wikipedia.org/wiki/Cron">cron format</a>. This example cron job runs every 30 minutes. Adjust the frequency as necessary, making sure to take into account how long the sync takes to run.</p>
</li>
<li>
<p>How long, in seconds, to keep finished jobs. This should match the period of the job schedule in order to clean old failed jobs and prevent unnecessary alerts. For more information, see <a href="https://kubernetes.io/docs/concepts/workloads/controllers/ttlafterfinished">TTL-after-finished Controller</a> in the Kubernetes documentation.</p>
</li>
<li>
<p>The LDAP sync command for the cron job to run. Passes in the sync configuration file that was defined in the config map.</p>
</li>
<li>
<p>This secret was created when the LDAP IDP was configured.</p>
</li>
<li>
<p>This config map was created when the LDAP IDP was configured.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the cron job:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc create -f ldap-sync-cron-job.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#configuring-ldap-identity-provider">Configuring an LDAP identity provider</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/nodes/#nodes-nodes-jobs-creating-cron_nodes-nodes-jobs">Creating cron jobs</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ldap-syncing-examples_ldap-syncing-groups">LDAP group sync examples</h3>
<div class="paragraph">
<p>This section contains examples for the RFC 2307, Active Directory, and
augmented Active Directory schemas.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>These examples assume that all users are direct members of their respective
groups. Specifically, no groups have other groups as members. See
the Nested Membership Sync Example for information on
how to sync nested groups.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ldap-syncing-rfc2307_ldap-syncing-groups">Syncing groups using the RFC 2307 schema</h4>
<div class="paragraph">
<p>For the RFC 2307 schema, the following examples synchronize a group named <code>admins</code> that has two
members: <code>Jane</code> and <code>Jim</code>. The examples explain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How the group and users are added to the LDAP server.</p>
</li>
<li>
<p>What the resulting group record in OpenShift Container Platform will be after synchronization.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>These examples assume that all users are direct members of their respective
groups. Specifically, no groups have other groups as members. See
the Nested Membership Sync Example for information on
how to sync nested groups.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the RFC 2307 schema, both users (Jane and Jim) and groups exist on the LDAP
server as first-class entries, and group membership is stored in attributes on
the group. The following snippet of <code>ldif</code> defines the users and group for this
schema:</p>
</div>
<div class="listingblock">
<div class="title">LDAP entries that use RFC 2307 schema: <code>rfc2307.ldif</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-ldif" data-lang="ldif">  dn: ou=users,dc=example,dc=com
  objectClass: organizationalUnit
  ou: users
  dn: cn=Jane,ou=users,dc=example,dc=com
  objectClass: person
  objectClass: organizationalPerson
  objectClass: inetOrgPerson
  cn: Jane
  sn: Smith
  displayName: Jane Smith
  mail: jane.smith@example.com
  dn: cn=Jim,ou=users,dc=example,dc=com
  objectClass: person
  objectClass: organizationalPerson
  objectClass: inetOrgPerson
  cn: Jim
  sn: Adams
  displayName: Jim Adams
  mail: jim.adams@example.com
  dn: ou=groups,dc=example,dc=com
  objectClass: organizationalUnit
  ou: groups
  dn: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(1)</b>
  objectClass: groupOfNames
  cn: admins
  owner: cn=admin,dc=example,dc=com
  description: System Administrators
  member: cn=Jane,ou=users,dc=example,dc=com <b class="conum">(2)</b>
  member: cn=Jim,ou=users,dc=example,dc=com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The group is a first-class entry in the LDAP server.</p>
</li>
<li>
<p>Members of a group are listed with an identifying reference as attributes on
the group.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>rfc2307_config.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=rfc2307_config.yaml --confirm</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>rfc2307_config.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400 <b class="conum">(1)</b>
    openshift.io/ldap.uid: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
    openshift.io/ldap.url: LDAP_SERVER_IP:389 <b class="conum">(3)</b>
  creationTimestamp:
  name: admins <b class="conum">(4)</b>
users: <b class="conum">(5)</b>
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The last time this OpenShift Container Platform group was synchronized with the LDAP server, in ISO 6801
format.</p>
</li>
<li>
<p>The unique identifier for the group on the LDAP server.</p>
</li>
<li>
<p>The IP address and host of the LDAP server where this group&#8217;s record is
stored.</p>
</li>
<li>
<p>The name of the group as specified by the sync file.</p>
</li>
<li>
<p>The users that are members of the group, named as specified by the sync file.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-rfc2307-user-defined_ldap-syncing-groups">Syncing groups using the RFC2307 schema with user-defined name mappings</h4>
<div class="paragraph">
<p>When syncing groups with user-defined name mappings, the configuration file
changes to contain these mappings as shown below.</p>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses RFC 2307 schema with user-defined name mappings: <code>rfc2307_config_user_defined.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
groupUIDNameMapping:
  "cn=admins,ou=groups,dc=example,dc=com": Administrators <b class="conum">(1)</b>
rfc2307:
    groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    groupUIDAttribute: dn <b class="conum">(2)</b>
    groupNameAttributes: [ cn ] <b class="conum">(3)</b>
    groupMembershipAttributes: [ member ]
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        pageSize: 0
    userUIDAttribute: dn <b class="conum">(4)</b>
    userNameAttributes: [ mail ]
    tolerateMemberNotFoundErrors: false
    tolerateMemberOutOfScopeErrors: false</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The user-defined name mapping.</p>
</li>
<li>
<p>The unique identifier attribute that is used for the keys in the
user-defined name mapping. You cannot specify <code>groupsQuery</code> filters when using
DN for groupUIDAttribute. For fine-grained filtering, use the whitelist / blacklist method.</p>
</li>
<li>
<p>The attribute to name OpenShift Container Platform groups with if their unique identifier is
not in the user-defined name mapping.</p>
</li>
<li>
<p>The attribute that uniquely identifies a user on the LDAP server. You
cannot specify <code>usersQuery</code> filters when using DN for userUIDAttribute. For
fine-grained  filtering, use the whitelist / blacklist method.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>rfc2307_config_user_defined.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=rfc2307_config_user_defined.yaml --confirm</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>rfc2307_config_user_defined.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400
    openshift.io/ldap.uid: cn=admins,ou=groups,dc=example,dc=com
    openshift.io/ldap.url: LDAP_SERVER_IP:389
  creationTimestamp:
  name: Administrators <b class="conum">(1)</b>
users:
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The name of the group as specified by the user-defined name mapping.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-rfc2307-user-defined-error_ldap-syncing-groups">Syncing groups using RFC 2307 with user-defined error tolerances</h4>
<div class="paragraph">
<p>By default, if the groups being synced contain members whose entries are outside
of the scope defined in the member query, the group sync fails with an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Error determining LDAP group membership for "&lt;group&gt;": membership lookup for user "&lt;user&gt;" in group "&lt;group&gt;" failed because of "search for entry with dn="&lt;user-dn&gt;" would search outside of the base dn specified (dn="&lt;base-dn&gt;")".</pre>
</div>
</div>
<div class="paragraph">
<p>This often indicates a misconfigured <code>baseDN</code> in the <code>usersQuery</code> field.
However, in cases where the <code>baseDN</code> intentionally does not contain some of the
members of the group, setting <code>tolerateMemberOutOfScopeErrors: true</code> allows
the group sync to continue. Out of scope members will be ignored.</p>
</div>
<div class="paragraph">
<p>Similarly, when the group sync process fails to locate a member for a group, it
fails outright with errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Error determining LDAP group membership for "&lt;group&gt;": membership lookup for user "&lt;user&gt;" in group "&lt;group&gt;" failed because of "search for entry with base dn="&lt;user-dn&gt;" refers to a non-existent entry".
Error determining LDAP group membership for "&lt;group&gt;": membership lookup for user "&lt;user&gt;" in group "&lt;group&gt;" failed because of "search for entry with base dn="&lt;user-dn&gt;" and filter "&lt;filter&gt;" did not return any results".</pre>
</div>
</div>
<div class="paragraph">
<p>This often indicates a misconfigured <code>usersQuery</code> field. However, in cases
where the group contains member entries that are known to be missing, setting
<code>tolerateMemberNotFoundErrors: true</code> allows the group sync to continue.
Problematic members will be ignored.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Enabling error tolerances for the LDAP group sync causes the sync process to
ignore problematic member entries. If the LDAP group sync is not configured
correctly, this could result in synced OpenShift Container Platform groups missing members.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">LDAP entries that use RFC 2307 schema with problematic group membership: <code>rfc2307_problematic_users.ldif</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-ldif" data-lang="ldif">  dn: ou=users,dc=example,dc=com
  objectClass: organizationalUnit
  ou: users
  dn: cn=Jane,ou=users,dc=example,dc=com
  objectClass: person
  objectClass: organizationalPerson
  objectClass: inetOrgPerson
  cn: Jane
  sn: Smith
  displayName: Jane Smith
  mail: jane.smith@example.com
  dn: cn=Jim,ou=users,dc=example,dc=com
  objectClass: person
  objectClass: organizationalPerson
  objectClass: inetOrgPerson
  cn: Jim
  sn: Adams
  displayName: Jim Adams
  mail: jim.adams@example.com
  dn: ou=groups,dc=example,dc=com
  objectClass: organizationalUnit
  ou: groups
  dn: cn=admins,ou=groups,dc=example,dc=com
  objectClass: groupOfNames
  cn: admins
  owner: cn=admin,dc=example,dc=com
  description: System Administrators
  member: cn=Jane,ou=users,dc=example,dc=com
  member: cn=Jim,ou=users,dc=example,dc=com
  member: cn=INVALID,ou=users,dc=example,dc=com <b class="conum">(1)</b>
  member: cn=Jim,ou=OUTOFSCOPE,dc=example,dc=com <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A member that does not exist on the LDAP server.</p>
</li>
<li>
<p>A member that may exist, but is not under the <code>baseDN</code> in the
user query for the sync job.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To tolerate the errors in the above example, the following additions to
your sync configuration file must be made:</p>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses RFC 2307 schema tolerating errors: <code>rfc2307_config_tolerating.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://LDAP_SERVICE_IP:389
rfc2307:
    groupsQuery:
        baseDN: "ou=groups,dc=example,dc=com"
        scope: sub
        derefAliases: never
    groupUIDAttribute: dn
    groupNameAttributes: [ cn ]
    groupMembershipAttributes: [ member ]
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
    userUIDAttribute: dn <b class="conum">(1)</b>
    userNameAttributes: [ mail ]
    tolerateMemberNotFoundErrors: true <b class="conum">(2)</b>
    tolerateMemberOutOfScopeErrors: true <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The attribute that uniquely identifies a user on the LDAP server. You
cannot specify <code>usersQuery</code> filters when using DN for userUIDAttribute. For
fine-grained  filtering, use the whitelist / blacklist method.</p>
</li>
<li>
<p>When <code>true</code>, the sync job tolerates groups for which some members were not
found, and members whose LDAP entries are not found are ignored. The
default behavior for the sync job is to fail if a member of a group is not
found.</p>
</li>
<li>
<p>When <code>true</code>, the sync job tolerates groups for which some members are outside
the user scope given in the <code>usersQuery</code> base DN, and members outside the member
query scope are ignored. The default behavior for the sync job is to fail if a
member of a group is out of scope.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>rfc2307_config_tolerating.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=rfc2307_config_tolerating.yaml --confirm</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>rfc2307_config.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400
    openshift.io/ldap.uid: cn=admins,ou=groups,dc=example,dc=com
    openshift.io/ldap.url: LDAP_SERVER_IP:389
  creationTimestamp:
  name: admins
users: <b class="conum">(1)</b>
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The users that are members of the group, as specified by the sync file.
Members for which lookup encountered tolerated errors are absent.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-activedir_ldap-syncing-groups">Syncing groups using the Active Directory schema</h4>
<div class="paragraph">
<p>In the Active Directory schema, both users (Jane and Jim) exist in the LDAP
server as first-class entries, and group membership is stored in attributes on
the user. The following snippet of <code>ldif</code> defines the users and group for this
schema:</p>
</div>
<div class="listingblock">
<div class="title">LDAP entries that use Active Directory schema: <code>active_directory.ldif</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-ldif" data-lang="ldif">dn: ou=users,dc=example,dc=com
objectClass: organizationalUnit
ou: users

dn: cn=Jane,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jane
sn: Smith
displayName: Jane Smith
mail: jane.smith@example.com
memberOf: admins <b class="conum">(1)</b>

dn: cn=Jim,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jim
sn: Adams
displayName: Jim Adams
mail: jim.adams@example.com
memberOf: admins</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The user&#8217;s group memberships are listed as attributes on the user, and the
group does not exist as an entry on the server. The <code>memberOf</code> attribute does
not have to be a literal attribute on the user; in some LDAP servers, it is created
during search and returned to the client, but not committed to the database.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>active_directory_config.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=active_directory_config.yaml --confirm</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>active_directory_config.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400 <b class="conum">(1)</b>
    openshift.io/ldap.uid: admins <b class="conum">(2)</b>
    openshift.io/ldap.url: LDAP_SERVER_IP:389 <b class="conum">(3)</b>
  creationTimestamp:
  name: admins <b class="conum">(4)</b>
users: <b class="conum">(5)</b>
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The last time this OpenShift Container Platform group was synchronized with the LDAP server, in ISO 6801
format.</p>
</li>
<li>
<p>The unique identifier for the group on the LDAP server.</p>
</li>
<li>
<p>The IP address and host of the LDAP server where this group&#8217;s record is
stored.</p>
</li>
<li>
<p>The name of the group as listed in the LDAP server.</p>
</li>
<li>
<p>The users that are members of the group, named as specified by the sync
file.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ldap-syncing-augmented-activedir_ldap-syncing-groups">Syncing groups using the augmented Active Directory schema</h4>
<div class="paragraph">
<p>In the augmented Active Directory schema, both users (Jane and Jim) and groups
exist in the LDAP server as first-class entries, and group membership is stored
in attributes on the user. The following snippet of <code>ldif</code> defines the users and
group for this schema:</p>
</div>
<div class="listingblock">
<div class="title">LDAP entries that use augmented Active Directory schema: <code>augmented_active_directory.ldif</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-ldif" data-lang="ldif">dn: ou=users,dc=example,dc=com
objectClass: organizationalUnit
ou: users

dn: cn=Jane,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jane
sn: Smith
displayName: Jane Smith
mail: jane.smith@example.com
memberOf: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(1)</b>

dn: cn=Jim,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jim
sn: Adams
displayName: Jim Adams
mail: jim.adams@example.com
memberOf: cn=admins,ou=groups,dc=example,dc=com

dn: ou=groups,dc=example,dc=com
objectClass: organizationalUnit
ou: groups

dn: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
objectClass: groupOfNames
cn: admins
owner: cn=admin,dc=example,dc=com
description: System Administrators
member: cn=Jane,ou=users,dc=example,dc=com
member: cn=Jim,ou=users,dc=example,dc=com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The user&#8217;s group memberships are listed as attributes on the user.</p>
</li>
<li>
<p>The group is a first-class entry on the LDAP server.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>augmented_active_directory_config.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync --sync-config=augmented_active_directory_config.yaml --confirm</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>augmented_active_directory_config.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400 <b class="conum">(1)</b>
    openshift.io/ldap.uid: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
    openshift.io/ldap.url: LDAP_SERVER_IP:389 <b class="conum">(3)</b>
  creationTimestamp:
  name: admins <b class="conum">(4)</b>
users: <b class="conum">(5)</b>
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The last time this OpenShift Container Platform group was synchronized with the LDAP server, in ISO 6801 format.</p>
</li>
<li>
<p>The unique identifier for the group on the LDAP server.</p>
</li>
<li>
<p>The IP address and host of the LDAP server where this group&#8217;s record is stored.</p>
</li>
<li>
<p>The name of the group as specified by the sync file.</p>
</li>
<li>
<p>The users that are members of the group, named as specified by the sync file.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="ldap-syncing-nesting_ldap-syncing-groups">LDAP nested membership sync example</h5>
<div class="paragraph">
<p>Groups in OpenShift Container Platform do not nest. The LDAP server must flatten group
membership before the data can be consumed. Microsoft&#8217;s Active Directory Server
supports this feature via the
<a href="https://msdn.microsoft.com/en-us/library/aa746475(v=vs.85).aspx"><code>LDAP_MATCHING_RULE_IN_CHAIN</code></a>
rule, which has the OID <code>1.2.840.113556.1.4.1941</code>. Furthermore, only explicitly
whitelisted groups can be synced when using this matching rule.</p>
</div>
<div class="paragraph">
<p>This section has an example for the augmented Active Directory schema, which
synchronizes a group named <code>admins</code> that has one user <code>Jane</code> and one group
<code>otheradmins</code> as members. The <code>otheradmins</code> group has one user member: <code>Jim</code>.
This example explains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How the group and users are added to the LDAP server.</p>
</li>
<li>
<p>What the LDAP sync configuration file looks like.</p>
</li>
<li>
<p>What the resulting group record in OpenShift Container Platform will be after synchronization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the augmented Active Directory schema, both users (<code>Jane</code> and <code>Jim</code>) and
groups exist in the LDAP server as first-class entries, and group membership is
stored in attributes on the user or the group. The following snippet of <code>ldif</code>
defines the users and groups for this schema:</p>
</div>
<div class="listingblock">
<div class="title">LDAP entries that use augmented Active Directory schema with nested members: <code>augmented_active_directory_nested.ldif</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-ldif" data-lang="ldif">dn: ou=users,dc=example,dc=com
objectClass: organizationalUnit
ou: users

dn: cn=Jane,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jane
sn: Smith
displayName: Jane Smith
mail: jane.smith@example.com
memberOf: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(1)</b>

dn: cn=Jim,ou=users,dc=example,dc=com
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: testPerson
cn: Jim
sn: Adams
displayName: Jim Adams
mail: jim.adams@example.com
memberOf: cn=otheradmins,ou=groups,dc=example,dc=com <b class="conum">(1)</b>

dn: ou=groups,dc=example,dc=com
objectClass: organizationalUnit
ou: groups

dn: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
objectClass: group
cn: admins
owner: cn=admin,dc=example,dc=com
description: System Administrators
member: cn=Jane,ou=users,dc=example,dc=com
member: cn=otheradmins,ou=groups,dc=example,dc=com

dn: cn=otheradmins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
objectClass: group
cn: otheradmins
owner: cn=admin,dc=example,dc=com
description: Other System Administrators
memberOf: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(1)</b> <b class="conum">(3)</b>
member: cn=Jim,ou=users,dc=example,dc=com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The user&#8217;s and group&#8217;s memberships are listed as attributes on the object.</p>
</li>
<li>
<p>The groups are first-class entries on the LDAP server.</p>
</li>
<li>
<p>The <code>otheradmins</code> group is a member of the <code>admins</code> group.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When syncing nested groups with Active Directory, you must provide an LDAP query
definition for both user entries and group entries, as well as the attributes
with which to represent them in the internal OpenShift Container Platform group records.
Furthermore, certain changes are required in this configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>oc adm groups sync</code> command must explicitly whitelist groups.</p>
</li>
<li>
<p>The user&#8217;s <code>groupMembershipAttributes</code> must include
<code>"memberOf:1.2.840.113556.1.4.1941:"</code> to comply with the
<a href="https://msdn.microsoft.com/en-us/library/aa746475(v=vs.85).aspx"><code>LDAP_MATCHING_RULE_IN_CHAIN</code></a>
rule.</p>
</li>
<li>
<p>The <code>groupUIDAttribute</code> must be set to <code>dn</code>.</p>
</li>
<li>
<p>The <code>groupsQuery</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Must not set <code>filter</code>.</p>
</li>
<li>
<p>Must set a valid <code>derefAliases</code>.</p>
</li>
<li>
<p>Should not set <code>baseDN</code> as that value is ignored.</p>
</li>
<li>
<p>Should not set <code>scope</code> as that value is ignored.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For clarity, the group you create in OpenShift Container Platform should use attributes other
than the distinguished name whenever possible for user- or administrator-facing
fields. For example, identify the users of an OpenShift Container Platform group by their e-mail, and use the
name of the group as the common name. The following configuration file creates
these relationships:</p>
</div>
<div class="listingblock">
<div class="title">LDAP sync configuration that uses augmented Active Directory schema with nested members: <code>augmented_active_directory_config_nested.yaml</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">kind: LDAPSyncConfig
apiVersion: v1
url: ldap://LDAP_SERVICE_IP:389
augmentedActiveDirectory:
    groupsQuery: <b class="conum">(1)</b>
        derefAliases: never
        pageSize: 0
    groupUIDAttribute: dn <b class="conum">(2)</b>
    groupNameAttributes: [ cn ] <b class="conum">(3)</b>
    usersQuery:
        baseDN: "ou=users,dc=example,dc=com"
        scope: sub
        derefAliases: never
        filter: (objectclass=person)
        pageSize: 0
    userNameAttributes: [ mail ] <b class="conum">(4)</b>
    groupMembershipAttributes: [ "memberOf:1.2.840.113556.1.4.1941:" ] <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>groupsQuery</code> filters cannot be specified. The <code>groupsQuery</code> base DN and scope
values are ignored. <code>groupsQuery</code> must set a valid <code>derefAliases</code>.</p>
</li>
<li>
<p>The attribute that uniquely identifies a group on the LDAP server. It must be set to <code>dn</code>.</p>
</li>
<li>
<p>The attribute to use as the name of the group.</p>
</li>
<li>
<p>The attribute to use as the name of the user in the OpenShift Container Platform group
record. <code>mail</code> or <code>sAMAccountName</code> are preferred choices in most installations.</p>
</li>
<li>
<p>The attribute on the user that stores the membership information. Note the use
of <a href="https://msdn.microsoft.com/en-us/library/aa746475(v=vs.85).aspx"><code>LDAP_MATCHING_RULE_IN_CHAIN</code></a>.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create the configuration file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Run the sync with the <code>augmented_active_directory_config_nested.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm groups sync \
    'cn=admins,ou=groups,dc=example,dc=com' \
    --sync-config=augmented_active_directory_config_nested.yaml \
    --confirm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You must explicitly whitelist the <code>cn=admins,ou=groups,dc=example,dc=com</code> group.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OpenShift Container Platform creates the following group record as a result of the above sync
operation:</p>
</div>
<div class="listingblock">
<div class="title">OpenShift Container Platform group created by using the <code>augmented_active_directory_config_nested.yaml</code> file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  annotations:
    openshift.io/ldap.sync-time: 2015-10-13T10:08:38-0400 <b class="conum">(1)</b>
    openshift.io/ldap.uid: cn=admins,ou=groups,dc=example,dc=com <b class="conum">(2)</b>
    openshift.io/ldap.url: LDAP_SERVER_IP:389 <b class="conum">(3)</b>
  creationTimestamp:
  name: admins <b class="conum">(4)</b>
users: <b class="conum">(5)</b>
- jane.smith@example.com
- jim.adams@example.com</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The last time this OpenShift Container Platform group was synchronized with the LDAP server, in ISO 6801 format.</p>
</li>
<li>
<p>The unique identifier for the group on the LDAP server.</p>
</li>
<li>
<p>The IP address and host of the LDAP server where this group&#8217;s record is stored.</p>
</li>
<li>
<p>The name of the group as specified by the sync file.</p>
</li>
<li>
<p>The users that are members of the group, named as specified by the sync file.
Note that members of nested groups are included since the group membership was
flattened by the Microsoft Active Directory Server.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ldap-syncing-spec_ldap-syncing-groups">LDAP sync configuration specification</h3>
<div class="paragraph">
<p>The object specification for the configuration file is below.  Note that the different schema
objects have different fields.  For example, v1.ActiveDirectoryConfig has no <code>groupsQuery</code>
field whereas v1.RFC2307Config and v1.AugmentedActiveDirectoryConfig both do.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>There is no support for binary attributes. All attribute data coming from the
LDAP server must be in the format of a UTF-8 encoded string. For example, never
use a binary attribute, such as <code>objectGUID</code>, as an ID attribute. You must use
string attributes, such as <code>sAMAccountName</code> or <code>userPrincipalName</code>, instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-ldapsyncconfig">v1.LDAPSyncConfig</h4>
<div class="paragraph">
<p><code>LDAPSyncConfig</code> holds the necessary configuration options to define an LDAP
group sync.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds" class="bare">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apiVersion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources" class="bare">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host is the scheme, host and port of the LDAP server to connect to: <code>scheme://host:port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bindDN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional DN to bind to the LDAP server with.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bindPassword</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional password to bind with during the search phase.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.StringSource</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>insecure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, indicates the connection should not use TLS. If <code>false</code>, <code>ldaps://</code> URLs connect using TLS, and <code>ldap://</code> URLs are upgraded to a TLS connection using StartTLS as specified in <a href="https://tools.ietf.org/html/rfc2830" class="bare">https://tools.ietf.org/html/rfc2830</a>. If you set <code>insecure</code> to <code>true</code>, you cannot use <code>ldaps://</code> URL schemes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional trusted certificate authority bundle to use when making requests to the server. If empty, the default system roots are used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupUIDNameMapping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional direct mapping of LDAP group UIDs to OpenShift Container Platform group names.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rfc2307</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the configuration for extracting data from an LDAP server set up in a fashion similar to RFC2307: first-class group and user entries, with group membership determined by a multi-valued attribute on the group entry listing its members.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.RFC2307Config</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>activeDirectory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the configuration for extracting data from an LDAP server set up in a fashion similar to that used in Active Directory: first-class user entries, with group membership determined by a multi-valued attribute on members listing groups they are a member of.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.ActiveDirectoryConfig</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>augmentedActiveDirectory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the configuration for extracting data from an LDAP server set up in a fashion similar to that used in Active Directory as described above, with one addition: first-class group entries exist and are used to hold metadata but not group membership.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.AugmentedActiveDirectoryConfig</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-stringsource">v1.StringSource</h4>
<div class="paragraph">
<p><code>StringSource</code> allows specifying a string inline, or externally via environment
variable or file. When it contains only a string value, it marshals to a simple
JSON string.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the cleartext value, or an encrypted value if <code>keyFile</code> is specified.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an environment variable containing the cleartext value, or an
encrypted value if the <code>keyFile</code> is specified.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">References a file containing the cleartext value, or an encrypted value if a <code>keyFile</code> is specified.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyFile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">References a file containing the key to use to decrypt the value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-ldapquery">v1.LDAPQuery</h4>
<div class="paragraph">
<p><code>LDAPQuery</code> holds the options necessary to build an LDAP query.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>baseDN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DN of the branch of the directory where all searches should start from.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scope</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The optional scope of the search. Can be <code>base</code>: only the base object, <code>one</code>:
all objects on the base level, <code>sub</code>: the entire subtree. Defaults to <code>sub</code>
if not set.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>derefAliases</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The optional behavior of the search with regards to aliases. Can be <code>never</code>:
never dereference aliases, <code>search</code>: only dereference in searching, <code>base</code>:
only dereference in finding the base object, <code>always</code>: always dereference.
Defaults to <code>always</code> if not set.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the limit of time in seconds that any request to the server can remain outstanding before the wait for a response is given up. If this is <code>0</code>, no client-side limit is imposed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A valid LDAP search filter that retrieves all relevant entries from the LDAP server with the base DN.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pageSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum preferred page size, measured in LDAP entries. A page size of <code>0</code> means no paging will be done.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-rfc2307config">v1.RFC2307Config</h4>
<div class="paragraph">
<p><code>RFC2307Config</code> holds the necessary configuration options to define how an LDAP
group sync interacts with an LDAP server using the RFC2307 schema.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupsQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the template for an LDAP query that returns group entries.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.LDAPQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupUIDAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attribute on an LDAP group entry will be interpreted as its unique identifier. (<code>ldapGroupUID</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupNameAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP group entry will be interpreted as its name to use for an OpenShift Container Platform group.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupMembershipAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP group entry will be interpreted as its members. The values contained in those attributes must be queryable by your <code>UserUIDAttribute</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>usersQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the template for an LDAP query that returns user entries.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.LDAPQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userUIDAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attribute on an LDAP user entry will be interpreted as its unique identifier. It must correspond to values that will be found from the <code>GroupMembershipAttributes</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userNameAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP user entry will be used, in order, as its OpenShift Container Platform user name. The first attribute with a non-empty value is used. This should match your <code>PreferredUsername</code> setting for your <code>LDAPPasswordIdentityProvider</code>. The attribute to use as the name of the user in the OpenShift Container Platform group
record. <code>mail</code> or <code>sAMAccountName</code> are preferred choices in most installations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tolerateMemberNotFoundErrors</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the behavior of the LDAP sync job when missing user entries are encountered. If <code>true</code>, an LDAP query for users that does not find any will be tolerated and an only and error will be logged. If <code>false</code>, the LDAP sync job will fail if a query for users doesn&#8217;t find any. The default value is <code>false</code>. Misconfigured LDAP sync jobs with this flag set to <code>true</code> can cause group membership to be removed, so it is recommended to use this flag with caution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tolerateMemberOutOfScopeErrors</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the behavior of the LDAP sync job when out-of-scope user entries are encountered. If <code>true</code>, an LDAP query for a user that falls outside of the base DN given for the all user query will be tolerated and only an error will be logged. If <code>false</code>, the LDAP sync job will fail if a user query would search outside of the base DN specified by the all user query. Misconfigured LDAP sync jobs with this flag set to <code>true</code> can result in groups missing users, so it is recommended to use this flag with caution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-activedirectoryconfig">v1.ActiveDirectoryConfig</h4>
<div class="paragraph">
<p><code>ActiveDirectoryConfig</code> holds the necessary configuration options to define how
an LDAP group sync interacts with an LDAP server using the Active Directory
schema.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>usersQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the template for an LDAP query that returns user entries.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.LDAPQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userNameAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP user entry will be interpreted as its OpenShift Container Platform user name. The attribute to use as the name of the user in the OpenShift Container Platform group
record. <code>mail</code> or <code>sAMAccountName</code> are preferred choices in most installations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupMembershipAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP user entry will be interpreted as the groups it is a member of.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="sync-ldap-v1-augmentedactivedirectoryconfig">v1.AugmentedActiveDirectoryConfig</h4>
<div class="paragraph">
<p><code>AugmentedActiveDirectoryConfig</code> holds the necessary configuration options to
define how an LDAP group sync interacts with an LDAP server using the augmented
Active Directory schema.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>usersQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the template for an LDAP query that returns user entries.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.LDAPQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userNameAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP user entry will be interpreted as its OpenShift Container Platform user name. The attribute to use as the name of the user in the OpenShift Container Platform group
record. <code>mail</code> or <code>sAMAccountName</code> are preferred choices in most installations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupMembershipAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP user entry will be interpreted as the groups it is a member of.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupsQuery</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the template for an LDAP query that returns group entries.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v1.LDAPQuery</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupUIDAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attribute on an LDAP group entry will be interpreted as its unique identifier. (<code>ldapGroupUID</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupNameAttributes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines which attributes on an LDAP group entry will be interpreted as its name to use for an OpenShift Container Platform group.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string array</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_managing-cloud-provider-credentials">Managing cloud provider credentials</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="about-cloud-credential-operator">About the Cloud Credential Operator</h3>
<div class="paragraph">
<p>The Cloud Credential Operator (CCO) manages cloud provider credentials as  custom resource definitions (CRDs). The CCO syncs on <code>CredentialsRequest</code> custom resources (CRs) to allow OpenShift Container Platform components to request cloud provider credentials with the specific permissions that are required for the cluster to run.</p>
</div>
<div class="paragraph">
<p>By setting different values for the <code>credentialsMode</code> parameter in the <code>install-config.yaml</code> file, the CCO can be configured to operate in several different modes. If no mode is specified, or the <code>credentialsMode</code> parameter is set to an empty string (<code>""</code>), the CCO operates in its default mode.</p>
</div>
<div class="sect3">
<h4 id="about-cloud-credential-operator-modes_about-cloud-credential-operator">Modes</h4>
<div class="paragraph">
<p>By setting different values for the <code>credentialsMode</code> parameter in the <code>install-config.yaml</code> file, the CCO can be configured to operate in <em>mint</em>, <em>passthrough</em>, or <em>manual</em> mode. These options provide transparency and flexibility in how the CCO uses cloud credentials to process <code>CredentialsRequest</code> CRs in the cluster, and allow the CCO to be configured to suit the security requirements of your organization. Not all CCO modes are supported for all cloud providers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="#cco-mode-mint">Mint</a></strong>: In mint mode, the CCO uses the provided admin-level cloud credential to create new credentials for components in the cluster with only the specific permissions that are required.</p>
</li>
<li>
<p><strong><a href="#cco-mode-passthrough">Passthrough</a></strong>: In passthrough mode, the CCO passes the provided cloud credential to the components that request cloud credentials.</p>
</li>
<li>
<p><strong><a href="#cco-mode-manual">Manual</a></strong>: In manual mode, a user manages cloud credentials instead of the CCO.</p>
<div class="ulist">
<ul>
<li>
<p><strong><a href="#cco-mode-sts">Manual with AWS Security Token Service</a></strong>: In manual mode, you can configure an AWS cluster to use Amazon Web Services Security Token Service (AWS STS). With this configuration, the CCO uses temporary credentials for different components.</p>
</li>
<li>
<p><strong><a href="#cco-mode-gcp-workload-identity">Manual with GCP Workload Identity</a></strong>: In manual mode, you can configure a GCP cluster to use GCP Workload Identity. With this configuration, the CCO uses temporary credentials for different components.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. CCO mode support matrix</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Cloud provider</th>
<th class="tableblock halign-center valign-middle">Mint</th>
<th class="tableblock halign-center valign-middle">Passthrough</th>
<th class="tableblock halign-center valign-middle">Manual</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Alibaba Cloud</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Amazon Web Services (AWS)</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Microsoft Azure</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X <sup>[1]</sup></p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Google Cloud Platform (GCP)</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">IBM Cloud</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Nutanix</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Red Hat OpenStack Platform (RHOSP)</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Red Hat Virtualization (RHV)</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">VMware vSphere</p></td>
<td class="tableblock halign-center valign-middle"></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">X</p></td>
<td class="tableblock halign-center valign-middle"></td>
</tr>
</tbody>
</table>
<div class="openblock small">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Manual mode is the only supported CCO configuration for Microsoft Azure Stack Hub.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cco-determine-mode_about-cloud-credential-operator">Determining the Cloud Credential Operator mode</h4>
<div class="paragraph">
<p>For platforms that support using the CCO in multiple modes, you can determine what mode the CCO is configured to use by using the web console or the CLI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/334_OpenShift_cluster_updating_and_CCO_workflows_0523_4.11_A.png" alt="Decision tree showing how to determine the configured CCO credentials mode for your cluster.">
</div>
<div class="title">Figure 1. Determining the CCO configuration</div>
</div>
<div class="sect4">
<h5 id="cco-determine-mode-gui_about-cloud-credential-operator">Determining the Cloud Credential Operator mode by using the web console</h5>
<div class="paragraph">
<p>You can determine what mode the Cloud Credential Operator (CCO) is configured to use by using the web console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Only Amazon Web Services (AWS), global Microsoft Azure, and Google Cloud Platform (GCP) clusters support multiple CCO modes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to an OpenShift Container Platform account with cluster administrator permissions.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenShift Container Platform web console as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Navigate to <strong>Administration</strong> &#8594; <strong>Cluster Settings</strong>.</p>
</li>
<li>
<p>On the <strong>Cluster Settings</strong> page, select the <strong>Configuration</strong> tab.</p>
</li>
<li>
<p>Under <strong>Configuration resource</strong>, select <strong>CloudCredential</strong>.</p>
</li>
<li>
<p>On the <strong>CloudCredential details</strong> page, select the <strong>YAML</strong> tab.</p>
</li>
<li>
<p>In the YAML block, check the value of <code>spec.credentialsMode</code>. The following values are possible, though not all are supported on all platforms:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>''</code>: The CCO is operating in the default mode. In this configuration, the CCO operates in mint or passthrough mode, depending on the credentials provided during installation.</p>
</li>
<li>
<p><code>Mint</code>: The CCO is operating in mint mode.</p>
</li>
<li>
<p><code>Passthrough</code>: The CCO is operating in passthrough mode.</p>
</li>
<li>
<p><code>Manual</code>: The CCO is operating in manual mode.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>To determine the specific configuration of an AWS or GCP cluster that has a <code>spec.credentialsMode</code> of <code>''</code>, <code>Mint</code>, or <code>Manual</code>, you must investigate further.</p>
</div>
<div class="paragraph">
<p>AWS and GCP clusters support using mint mode with the root secret deleted.</p>
</div>
<div class="paragraph">
<p>An AWS or GCP cluster that uses manual mode might be configured to create and manage cloud credentials from outside of the cluster using the AWS Security Token Service (STS) or GCP Workload Identity. You can determine whether your cluster uses this strategy by examining the cluster <code>Authentication</code> object.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>AWS or GCP clusters that use the default (<code>''</code>) only: To determine whether the cluster is operating in mint or passthrough mode, inspect the annotations on the cluster root secret:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong> and look for the root secret for your cloud provider.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that the <strong>Project</strong> dropdown is set to <strong>All Projects</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Secret name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws-creds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp-credentials</code></p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>To view the CCO mode that the cluster is using, click <code>1 annotation</code> under <strong>Annotations</strong>, and check the value field. The following values are possible:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>Mint</code>: The CCO is operating in mint mode.</p>
</li>
<li>
<p><code>Passthrough</code>: The CCO is operating in passthrough mode.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>If your cluster uses mint mode, you can also determine whether the cluster is operating without the root secret.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>AWS or GCP clusters that use mint mode only: To determine whether the cluster is operating without the root secret, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong> and look for the root secret for your cloud provider.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that the <strong>Project</strong> dropdown is set to <strong>All Projects</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Secret name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws-creds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp-credentials</code></p></td>
</tr>
</tbody>
</table>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>If you see one of these values, your cluster is using mint or passthrough mode with the root secret present.</p>
</li>
<li>
<p>If you do not see these values, your cluster is using the CCO in mint mode with the root secret removed.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>AWS or GCP clusters that use manual mode only: To determine whether the cluster is configured to create and manage cloud credentials from outside of the cluster, you must check the cluster <code>Authentication</code> object YAML values.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Administration</strong> &#8594; <strong>Cluster Settings</strong>.</p>
</li>
<li>
<p>On the <strong>Cluster Settings</strong> page, select the <strong>Configuration</strong> tab.</p>
</li>
<li>
<p>Under <strong>Configuration resource</strong>, select <strong>Authentication</strong>.</p>
</li>
<li>
<p>On the <strong>Authentication details</strong> page, select the <strong>YAML</strong> tab.</p>
</li>
<li>
<p>In the YAML block, check the value of the <code>.spec.serviceAccountIssuer</code> parameter.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>A value that contains a URL that is associated with your cloud provider indicates that the CCO is using manual mode with AWS STS or GCP Workload Identity to create and manage cloud credentials from outside of the cluster. These clusters are configured using the <code>ccoctl</code> utility.</p>
</li>
<li>
<p>An empty value (<code>''</code>) indicates that the cluster is using the CCO in manual mode but was not configured using the <code>ccoctl</code> utility.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="cco-determine-mode-cli_about-cloud-credential-operator">Determining the Cloud Credential Operator mode by using the CLI</h5>
<div class="paragraph">
<p>You can determine what mode the Cloud Credential Operator (CCO) is configured to use by using the CLI.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Only Amazon Web Services (AWS), global Microsoft Azure, and Google Cloud Platform (GCP) clusters support multiple CCO modes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to an OpenShift Container Platform account with cluster administrator permissions.</p>
</li>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to <code>oc</code> on the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>To determine the mode that the CCO is configured to use, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get cloudcredentials cluster \
  -o=jsonpath={.spec.credentialsMode}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following output values are possible, though not all are supported on all platforms:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>''</code>: The CCO is operating in the default mode. In this configuration, the CCO operates in mint or passthrough mode, depending on the credentials provided during installation.</p>
</li>
<li>
<p><code>Mint</code>: The CCO is operating in mint mode.</p>
</li>
<li>
<p><code>Passthrough</code>: The CCO is operating in passthrough mode.</p>
</li>
<li>
<p><code>Manual</code>: The CCO is operating in manual mode.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>To determine the specific configuration of an AWS or GCP cluster that has a <code>spec.credentialsMode</code> of <code>''</code>, <code>Mint</code>, or <code>Manual</code>, you must investigate further.</p>
</div>
<div class="paragraph">
<p>AWS and GCP clusters support using mint mode with the root secret deleted.</p>
</div>
<div class="paragraph">
<p>An AWS or GCP cluster that uses manual mode might be configured to create and manage cloud credentials from outside of the cluster using the AWS Security Token Service (STS) or GCP Workload Identity. You can determine whether your cluster uses this strategy by examining the cluster <code>Authentication</code> object.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>AWS or GCP clusters that use the default (<code>''</code>) only: To determine whether the cluster is operating in mint or passthrough mode, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secret &lt;secret_name&gt; \
  -n kube-system \
  -o jsonpath \
  --template '{ .metadata.annotations }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;secret_name&gt;</code> is <code>aws-creds</code> for AWS or <code>gcp-credentials</code> for GCP.</p>
</div>
<div class="paragraph">
<p>This command displays the value of the <code>.metadata.annotations</code> parameter in the cluster root secret object. The following output values are possible:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>Mint</code>: The CCO is operating in mint mode.</p>
</li>
<li>
<p><code>Passthrough</code>: The CCO is operating in passthrough mode.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>If your cluster uses mint mode, you can also determine whether the cluster is operating without the root secret.</p>
</div>
</li>
<li>
<p>AWS or GCP clusters that use mint mode only: To determine whether the cluster is operating without the root secret, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secret &lt;secret_name&gt; \
  -n=kube-system</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;secret_name&gt;</code> is <code>aws-creds</code> for AWS or <code>gcp-credentials</code> for GCP.</p>
</div>
<div class="paragraph">
<p>If the root secret is present, the output of this command returns information about the secret. An error indicates that the root secret is not present on the cluster.</p>
</div>
</li>
<li>
<p>AWS or GCP clusters that use manual mode only: To determine whether the cluster is configured to create and manage cloud credentials from outside of the cluster, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get authentication cluster \
  -o jsonpath \
  --template='{ .spec.serviceAccountIssuer }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command displays the value of the <code>.spec.serviceAccountIssuer</code> parameter in the cluster <code>Authentication</code> object.</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>An output of a URL that is associated with your cloud provider indicates that the CCO is using manual mode with AWS STS or GCP Workload Identity to create and manage cloud credentials from outside of the cluster. These clusters are configured using the <code>ccoctl</code> utility.</p>
</li>
<li>
<p>An empty output indicates that the cluster is using the CCO in manual mode but was not configured using the <code>ccoctl</code> utility.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="about-cloud-credential-operator-default_about-cloud-credential-operator">Default behavior</h4>
<div class="paragraph">
<p>For platforms on which multiple modes are supported (AWS, Azure, and GCP), when the CCO operates in its default mode, it checks the provided credentials dynamically to determine for which mode they are sufficient to process <code>CredentialsRequest</code> CRs.</p>
</div>
<div class="paragraph">
<p>By default, the CCO determines whether the credentials are sufficient for mint mode, which is the preferred mode of operation, and uses those credentials to create appropriate credentials for components in the cluster. If the credentials are not sufficient for mint mode, it determines whether they are sufficient for passthrough mode. If the credentials are not sufficient for passthrough mode, the CCO cannot adequately process <code>CredentialsRequest</code> CRs.</p>
</div>
<div class="paragraph">
<p>If the provided credentials are determined to be insufficient during installation, the installation fails. For AWS, the installer fails early in the process and indicates which required permissions are missing. Other providers might not provide specific information about the cause of the error until errors are encountered.</p>
</div>
<div class="paragraph">
<p>If the credentials are changed after a successful installation and the CCO determines that the new credentials are insufficient, the CCO puts conditions on any new <code>CredentialsRequest</code> CRs to indicate that it cannot process them because of the insufficient credentials.</p>
</div>
<div class="paragraph">
<p>To resolve insufficient credentials issues, provide a credential with sufficient permissions. If an error occurred during installation, try installing again. For issues with new <code>CredentialsRequest</code> CRs, wait for the CCO to try to process the CR again. As an alternative, you can manually create IAM for <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">AWS</a>, <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Azure</a>, and <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">GCP</a>.</p>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="additional-resources_about-cloud-credential-operator_about-cloud-credential-operator">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/operators/#cloud-credential-operator_cluster-operators-ref">Cluster Operators reference page for the Cloud Credential Operator</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cco-mode-mint">Using mint mode</h3>
<div class="paragraph">
<p>Mint mode is supported for Amazon Web Services (AWS) and Google Cloud Platform (GCP).</p>
</div>
<div class="paragraph">
<p>Mint mode is the default mode on the platforms for which it is supported. In this mode, the Cloud Credential Operator (CCO) uses the provided administrator-level cloud credential to create new credentials for components in the cluster with only the specific permissions that are required.</p>
</div>
<div class="paragraph">
<p>If the credential is not removed after installation, it is stored and used by the CCO to process <code>CredentialsRequest</code> CRs for components in the cluster and create new credentials for each with only the specific permissions that are required. The continuous reconciliation of cloud credentials in mint mode allows actions that require additional credentials or permissions, such as upgrading, to proceed.</p>
</div>
<div class="paragraph">
<p>Mint mode stores the administrator-level credential in the cluster <code>kube-system</code> namespace. If this approach does not meet the security requirements of your organization, see <em>Alternatives to storing administrator-level secrets in the kube-system project</em> for <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#alternatives-to-storing-admin-secrets-in-kube-system_manually-creating-iam-aws">AWS</a> or <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#alternatives-to-storing-admin-secrets-in-kube-system_manually-creating-iam-gcp">GCP</a>.</p>
</div>
<div class="sect3">
<h4 id="mint-mode-permissions">Mint mode permissions requirements</h4>
<div class="paragraph">
<p>When using the CCO in mint mode, ensure that the credential you provide meets the requirements of the cloud on which you are running or installing OpenShift Container Platform. If the provided credentials are not sufficient for mint mode, the CCO cannot create an IAM user.</p>
</div>
<div class="sect4">
<h5 id="mint-mode-permissions-aws">Amazon Web Services (AWS) permissions</h5>
<div class="paragraph">
<p>The credential you provide for mint mode in AWS must have the following permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>iam:CreateAccessKey</code></p>
</li>
<li>
<p><code>iam:CreateUser</code></p>
</li>
<li>
<p><code>iam:DeleteAccessKey</code></p>
</li>
<li>
<p><code>iam:DeleteUser</code></p>
</li>
<li>
<p><code>iam:DeleteUserPolicy</code></p>
</li>
<li>
<p><code>iam:GetUser</code></p>
</li>
<li>
<p><code>iam:GetUserPolicy</code></p>
</li>
<li>
<p><code>iam:ListAccessKeys</code></p>
</li>
<li>
<p><code>iam:PutUserPolicy</code></p>
</li>
<li>
<p><code>iam:TagUser</code></p>
</li>
<li>
<p><code>iam:SimulatePrincipalPolicy</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mint-mode-permissions-gcp">Google Cloud Platform (GCP) permissions</h5>
<div class="paragraph">
<p>The credential you provide for mint mode in GCP must have the following permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>resourcemanager.projects.get</code></p>
</li>
<li>
<p><code>serviceusage.services.list</code></p>
</li>
<li>
<p><code>iam.serviceAccountKeys.create</code></p>
</li>
<li>
<p><code>iam.serviceAccountKeys.delete</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.create</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.delete</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.get</code></p>
</li>
<li>
<p><code>iam.roles.get</code></p>
</li>
<li>
<p><code>resourcemanager.projects.getIamPolicy</code></p>
</li>
<li>
<p><code>resourcemanager.projects.setIamPolicy</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="admin-credentials-root-secret-formats_cco-mode-mint">Admin credentials root secret format</h4>
<div class="paragraph">
<p>Each cloud provider uses a credentials root secret in the <code>kube-system</code>
namespace by convention, which is then used to satisfy all credentials requests
and create their respective secrets.
This is done either by minting new credentials with <em>mint mode</em>, or by copying the credentials root secret with <em>passthrough mode</em>.</p>
</div>
<div class="paragraph">
<p>The format for the secret varies by cloud, and is also used for each
<code>CredentialsRequest</code> secret.</p>
</div>
<div class="listingblock">
<div class="title">Amazon Web Services (AWS) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: aws-creds
stringData:
  aws_access_key_id: &lt;base64-encoded_access_key_id&gt;
  aws_secret_access_key: &lt;base64-encoded_secret_access_key&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Google Cloud Platform (GCP) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: gcp-credentials
stringData:
  service_account.json: &lt;base64-encoded_service_account&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mint-mode-with-removal-or-rotation-of-admin-credential_cco-mode-mint">Mint mode with removal or rotation of the administrator-level credential</h4>
<div class="paragraph">
<p>Currently, this mode is only supported on AWS and GCP.</p>
</div>
<div class="paragraph">
<p>In this mode, a user installs OpenShift Container Platform with an administrator-level credential just like the normal mint mode. However, this process removes the administrator-level credential secret from the cluster post-installation.</p>
</div>
<div class="paragraph">
<p>The administrator can have the Cloud Credential Operator make its own request for a read-only credential that allows it to verify if all <code>CredentialsRequest</code> objects have their required permissions, thus the administrator-level credential is not required unless something needs to be changed. After the associated credential is removed, it can be deleted or deactivated on the underlying cloud, if desired.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to a non z-stream upgrade, you must reinstate the credential secret with the administrator-level credential. If the credential is not present, the upgrade might be blocked.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The administrator-level credential is not stored in the cluster permanently.</p>
</div>
<div class="paragraph">
<p>Following these steps still requires the administrator-level credential in the cluster for brief periods of time. It also requires manually re-instating the secret with administrator-level credentials for each upgrade.</p>
</div>
<div class="sect4">
<h5 id="manually-rotating-cloud-creds_cco-mode-mint">Rotating cloud provider credentials manually</h5>
<div class="paragraph">
<p>If your cloud provider credentials are changed for any reason, you must manually update the secret that the Cloud Credential Operator (CCO) uses to manage cloud provider credentials.</p>
</div>
<div class="paragraph">
<p>The process for rotating cloud credentials depends on the mode that the CCO is configured to use. After you rotate credentials for a cluster that is using mint mode, you must manually remove the component credentials that were created by the removed credential.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your cluster is installed on a platform that supports rotating cloud credentials manually with the CCO mode that you are using:</p>
<div class="ulist">
<ul>
<li>
<p>For mint mode, Amazon Web Services (AWS) and Google Cloud Platform (GCP) are supported.</p>
</li>
</ul>
</div>
</li>
<li>
<p>You have changed the credentials that are used to interface with your cloud provider.</p>
</li>
<li>
<p>The new credentials have sufficient permissions for the mode CCO is configured to use in your cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong>.</p>
</li>
<li>
<p>In the table on the <strong>Secrets</strong> page, find the root secret for your cloud provider.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Secret name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws-creds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp-credentials</code></p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Click the <strong>Options</strong> menu <span class="image"><img src="images/kebab.png" alt="kebab" title="Options menu"></span> in the same row as the secret and select <strong>Edit Secret</strong>.</p>
</li>
<li>
<p>Record the contents of the <strong>Value</strong> field or fields. You can use this information to verify that the value is different after updating the credentials.</p>
</li>
<li>
<p>Update the text in the <strong>Value</strong> field or fields with the new authentication information for your cloud provider, and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Delete each component secret that is referenced by the individual <code>CredentialsRequest</code> objects.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in to the OpenShift Container Platform CLI as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Get the names and namespaces of all referenced component secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc -n openshift-cloud-credential-operator get CredentialsRequest \
  -o json | jq -r '.items[] | select (.spec.providerSpec.kind=="&lt;provider_spec&gt;") | .spec.secretRef'</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;provider_spec&gt;</code> is the corresponding value for your cloud provider:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>AWS: <code>AWSProviderSpec</code></p>
</li>
<li>
<p>GCP: <code>GCPProviderSpec</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Partial example output for AWS</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "name": "ebs-cloud-credentials",
  "namespace": "openshift-cluster-csi-drivers"
}
{
  "name": "cloud-credential-operator-iam-ro-creds",
  "namespace": "openshift-cloud-credential-operator"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Delete each of the referenced component secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete secret &lt;secret_name&gt; \//<b class="conum">(1)</b>
  -n &lt;secret_namespace&gt; <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify the name of a secret.</p>
</li>
<li>
<p>Specify the namespace that contains the secret.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Example deletion of an AWS secret</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc delete secret ebs-cloud-credentials -n openshift-cluster-csi-drivers</code></pre>
</div>
</div>
<div class="paragraph">
<p>You do not need to manually delete the credentials from your provider console. Deleting the referenced component secrets will cause the CCO to delete the existing credentials from the platform and create new ones.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>To verify that the credentials have changed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong>.</p>
</li>
<li>
<p>Verify that the contents of the <strong>Value</strong> field or fields have changed.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="manually-removing-cloud-creds_cco-mode-mint">Removing cloud provider credentials</h5>
<div class="paragraph">
<p>After installing an OpenShift Container Platform cluster with the Cloud Credential Operator (CCO) in mint mode, you can remove the administrator-level credential secret from the <code>kube-system</code> namespace in the cluster. The administrator-level credential is required only during changes that require its elevated permissions, such as upgrades.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to a non z-stream upgrade, you must reinstate the credential secret with the administrator-level credential. If the credential is not present, the upgrade might be blocked.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your cluster is installed on a platform that supports removing cloud credentials from the CCO. Supported platforms are AWS and GCP.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong>.</p>
</li>
<li>
<p>In the table on the <strong>Secrets</strong> page, find the root secret for your cloud provider.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Secret name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws-creds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp-credentials</code></p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Click the <strong>Options</strong> menu <span class="image"><img src="images/kebab.png" alt="kebab" title="Options menu"></span> in the same row as the secret and select <strong>Delete Secret</strong>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="_additional-resources-2">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#alternatives-to-storing-admin-secrets-in-kube-system_manually-creating-iam-aws">Alternatives to storing administrator-level secrets in the kube-system project</a> for AWS</p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#alternatives-to-storing-admin-secrets-in-kube-system_manually-creating-iam-gcp">Alternatives to storing administrator-level secrets in the kube-system project</a> for GCP</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cco-mode-passthrough">Using passthrough mode</h3>
<div class="paragraph">
<p>Passthrough mode is supported for Amazon Web Services (AWS), Microsoft Azure, Google Cloud Platform (GCP), Red Hat OpenStack Platform (RHOSP), Red Hat Virtualization (RHV), and VMware vSphere.</p>
</div>
<div class="paragraph">
<p>In passthrough mode, the Cloud Credential Operator (CCO) passes the provided cloud credential to the components that request cloud credentials. The credential must have permissions to perform the installation and complete the operations that are required by components in the cluster, but does not need to be able to create new credentials. The CCO does not attempt to create additional limited-scoped credentials in passthrough mode.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#cco-mode-manual">Manual mode</a> is the only supported CCO configuration for Microsoft Azure Stack Hub.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="passthrough-mode-permissions">Passthrough mode permissions requirements</h4>
<div class="paragraph">
<p>When using the CCO in passthrough mode, ensure that the credential you provide meets the requirements of the cloud on which you are running or installing OpenShift Container Platform. If the provided credentials the CCO passes to a component that creates a <code>CredentialsRequest</code> CR are not sufficient, that component will report an error when it tries to call an API that it does not have permissions for.</p>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-aws">Amazon Web Services (AWS) permissions</h5>
<div class="paragraph">
<p>The credential you provide for passthrough mode in AWS must have all the requested permissions for all <code>CredentialsRequest</code> CRs that are required by the version of OpenShift Container Platform you are running or installing.</p>
</div>
<div class="paragraph">
<p>To locate the <code>CredentialsRequest</code> CRs that are required, see <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">Manually creating IAM for AWS</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-azure">Microsoft Azure permissions</h5>
<div class="paragraph">
<p>The credential you provide for passthrough mode in Azure must have all the requested permissions for all <code>CredentialsRequest</code> CRs that are required by the version of OpenShift Container Platform you are running or installing.</p>
</div>
<div class="paragraph">
<p>To locate the <code>CredentialsRequest</code> CRs that are required, see <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Manually creating IAM for Azure</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-gcp">Google Cloud Platform (GCP) permissions</h5>
<div class="paragraph">
<p>The credential you provide for passthrough mode in GCP must have all the requested permissions for all <code>CredentialsRequest</code> CRs that are required by the version of OpenShift Container Platform you are running or installing.</p>
</div>
<div class="paragraph">
<p>To locate the <code>CredentialsRequest</code> CRs that are required, see <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">Manually creating IAM for GCP</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-rhosp">Red Hat OpenStack Platform (RHOSP) permissions</h5>
<div class="paragraph">
<p>To install an OpenShift Container Platform cluster on RHOSP, the CCO requires a credential with the permissions of a <code>member</code> user role.</p>
</div>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-rhv">Red Hat Virtualization (RHV) permissions</h5>
<div class="paragraph">
<p>To install an OpenShift Container Platform cluster on RHV, the CCO requires a credential with the following privileges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DiskOperator</code></p>
</li>
<li>
<p><code>DiskCreator</code></p>
</li>
<li>
<p><code>UserTemplateBasedVm</code></p>
</li>
<li>
<p><code>TemplateOwner</code></p>
</li>
<li>
<p><code>TemplateCreator</code></p>
</li>
<li>
<p><code>ClusterAdmin</code> on the specific cluster that is targeted for OpenShift Container Platform deployment</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="passthrough-mode-permissions-vsware">VMware vSphere permissions</h5>
<div class="paragraph">
<p>To install an OpenShift Container Platform cluster on VMware vSphere, the CCO requires a credential with the following vSphere privileges:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Required vSphere privileges</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Privileges</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datastore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Allocate space</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Folder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Create folder</em>, <em>Delete folder</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">vSphere Tagging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All privileges</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Assign network</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Assign virtual machine to resource pool</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile-driven storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All privileges</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">vApp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All privileges</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual machine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All privileges</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="admin-credentials-root-secret-formats_cco-mode-passthrough">Admin credentials root secret format</h4>
<div class="paragraph">
<p>Each cloud provider uses a credentials root secret in the <code>kube-system</code>
namespace by convention, which is then used to satisfy all credentials requests
and create their respective secrets.
This is done either by minting new credentials with <em>mint mode</em>, or by copying the credentials root secret with <em>passthrough mode</em>.</p>
</div>
<div class="paragraph">
<p>The format for the secret varies by cloud, and is also used for each
<code>CredentialsRequest</code> secret.</p>
</div>
<div class="listingblock">
<div class="title">Amazon Web Services (AWS) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: aws-creds
stringData:
  aws_access_key_id: &lt;base64-encoded_access_key_id&gt;
  aws_secret_access_key: &lt;base64-encoded_secret_access_key&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Microsoft Azure secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: azure-credentials
stringData:
  azure_subscription_id: &lt;base64-encoded_subscription_id&gt;
  azure_client_id: &lt;base64-encoded_client_id&gt;
  azure_client_secret: &lt;base64-encoded_client_secret&gt;
  azure_tenant_id: &lt;base64-encoded_tenant_id&gt;
  azure_resource_prefix: &lt;base64-encoded_resource_prefix&gt;
  azure_resourcegroup: &lt;base64-encoded_resource_group&gt;
  azure_region: &lt;base64-encoded_region&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Microsoft Azure, the credentials secret format includes two properties that must contain the cluster&#8217;s infrastructure ID, generated randomly for each cluster installation. This value can be found after running create manifests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ cat .openshift_install_state.json | jq '."*installconfig.ClusterID".InfraID' -r</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">mycluster-2mpcn</code></pre>
</div>
</div>
<div class="paragraph">
<p>This value would be used in the secret data as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">azure_resource_prefix: mycluster-2mpcn
azure_resourcegroup: mycluster-2mpcn-rg</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Google Cloud Platform (GCP) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: gcp-credentials
stringData:
  service_account.json: &lt;base64-encoded_service_account&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Red Hat OpenStack Platform (RHOSP) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: openstack-credentials
data:
  clouds.yaml: &lt;base64-encoded_cloud_creds&gt;
  clouds.conf: &lt;base64-encoded_cloud_creds_init&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Red Hat Virtualization (RHV) secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: ovirt-credentials
data:
  ovirt_url: &lt;base64-encoded_url&gt;
  ovirt_username: &lt;base64-encoded_username&gt;
  ovirt_password: &lt;base64-encoded_password&gt;
  ovirt_insecure: &lt;base64-encoded_insecure&gt;
  ovirt_ca_bundle: &lt;base64-encoded_ca_bundle&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">VMware vSphere secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: kube-system
  name: vsphere-creds
data:
 vsphere.openshift.example.com.username: &lt;base64-encoded_username&gt;
 vsphere.openshift.example.com.password: &lt;base64-encoded_password&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="passthrough-mode-maintenance">Passthrough mode credential maintenance</h4>
<div class="paragraph">
<p>If <code>CredentialsRequest</code> CRs change over time as the cluster is upgraded, you must manually update the passthrough mode credential to meet the requirements. To avoid credentials issues during an upgrade, check the <code>CredentialsRequest</code> CRs in the release image for the new version of OpenShift Container Platform before upgrading. To locate the <code>CredentialsRequest</code> CRs that are required for your cloud provider, see <em>Manually creating IAM</em> for <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">AWS</a>, <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Azure</a>, or <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">GCP</a>.</p>
</div>
<div class="sect4">
<h5 id="manually-rotating-cloud-creds_cco-mode-passthrough">Rotating cloud provider credentials manually</h5>
<div class="paragraph">
<p>If your cloud provider credentials are changed for any reason, you must manually update the secret that the Cloud Credential Operator (CCO) uses to manage cloud provider credentials.</p>
</div>
<div class="paragraph">
<p>The process for rotating cloud credentials depends on the mode that the CCO is configured to use. After you rotate credentials for a cluster that is using mint mode, you must manually remove the component credentials that were created by the removed credential.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Your cluster is installed on a platform that supports rotating cloud credentials manually with the CCO mode that you are using:</p>
<div class="ulist">
<ul>
<li>
<p>For passthrough mode, Amazon Web Services (AWS), Microsoft Azure, Google Cloud Platform (GCP), Red Hat OpenStack Platform (RHOSP), Red Hat Virtualization (RHV), and VMware vSphere are supported.</p>
</li>
</ul>
</div>
</li>
<li>
<p>You have changed the credentials that are used to interface with your cloud provider.</p>
</li>
<li>
<p>The new credentials have sufficient permissions for the mode CCO is configured to use in your cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong>.</p>
</li>
<li>
<p>In the table on the <strong>Secrets</strong> page, find the root secret for your cloud provider.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Platform</th>
<th class="tableblock halign-left valign-top">Secret name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AWS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws-creds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>azure-credentials</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gcp-credentials</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHOSP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openstack-credentials</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ovirt-credentials</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VMware vSphere</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>vsphere-creds</code></p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Click the <strong>Options</strong> menu <span class="image"><img src="images/kebab.png" alt="kebab" title="Options menu"></span> in the same row as the secret and select <strong>Edit Secret</strong>.</p>
</li>
<li>
<p>Record the contents of the <strong>Value</strong> field or fields. You can use this information to verify that the value is different after updating the credentials.</p>
</li>
<li>
<p>Update the text in the <strong>Value</strong> field or fields with the new authentication information for your cloud provider, and then click <strong>Save</strong>.</p>
</li>
<li>
<p>If you are updating the credentials for a vSphere cluster that does not have the vSphere CSI Driver Operator enabled, you must force a rollout of the Kubernetes controller manager to apply the updated credentials.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the vSphere CSI Driver Operator is enabled, this step is not required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To apply the updated vSphere credentials, log in to the OpenShift Container Platform CLI as a user with the <code>cluster-admin</code> role and run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc patch kubecontrollermanager cluster \
  -p='{"spec": {"forceRedeploymentReason": "recovery-'"$( date )"'"}}' \
  --type=merge</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the credentials are rolling out, the status of the Kubernetes Controller Manager Operator reports <code>Progressing=true</code>. To view the status, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get co kube-controller-manager</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>To verify that the credentials have changed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Workloads</strong> &#8594; <strong>Secrets</strong>.</p>
</li>
<li>
<p>Verify that the contents of the <strong>Value</strong> field or fields have changed.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/storage/#vmware-vsphere-csi-driver-operator">vSphere CSI Driver Operator</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="passthrough-mode-reduce-permissions">Reducing permissions after installation</h4>
<div class="paragraph">
<p>When using passthrough mode, each component has the same permissions used by all other components. If you do not reduce the permissions after installing, all components have the broad permissions that are required to run the installer.</p>
</div>
<div class="paragraph">
<p>After installation, you can reduce the permissions on your credential to only those that are required to run the cluster, as defined by the <code>CredentialsRequest</code> CRs in the release image for the version of OpenShift Container Platform that you are using.</p>
</div>
<div class="paragraph">
<p>To locate the <code>CredentialsRequest</code> CRs that are required for AWS, Azure, or GCP and learn how to change the permissions the CCO uses, see <em>Manually creating IAM</em> for <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">AWS</a>, <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Azure</a>, or <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">GCP</a>.</p>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="_additional-resources-3">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">Manually creating IAM for AWS</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Manually creating IAM for Azure</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">Manually creating IAM for GCP</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cco-mode-manual">Using manual mode</h3>
<div class="paragraph">
<p>Manual mode is supported for Alibaba Cloud, Amazon Web Services (AWS), Microsoft Azure, IBM Cloud, and Google Cloud Platform (GCP).</p>
</div>
<div class="paragraph">
<p>In manual mode, a user manages cloud credentials instead of the Cloud Credential Operator (CCO). To use this mode, you must examine the <code>CredentialsRequest</code> CRs in the release image for the version of OpenShift Container Platform that you are running or installing, create corresponding credentials in the underlying cloud provider, and create Kubernetes Secrets in the correct namespaces to satisfy all <code>CredentialsRequest</code> CRs for the cluster&#8217;s cloud provider.</p>
</div>
<div class="paragraph">
<p>Using manual mode allows each cluster component to have only the permissions it requires, without storing an administrator-level credential in the cluster. This mode also does not require connectivity to the AWS public IAM endpoint. However, you must manually reconcile permissions with new release images for every upgrade.</p>
</div>
<div class="paragraph">
<p>For information about configuring your cloud provider to use manual mode, see the manual credentials management options for your cloud provider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-alibaba-ram">Manually creating RAM resources for Alibaba Cloud</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">Manually creating IAM for AWS</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Manually creating IAM for Azure</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">Manually creating IAM for GCP</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#configuring-iam-ibm-cloud">Configuring IAM for IBM Cloud</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-create-iam-nutanix_installing-nutanix-installer-provisioned">Configuring IAM for Nutanix</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="manual-mode-sts-blurb">Manual mode with cloud credentials created and managed outside of the cluster</h4>
<div class="paragraph">
<p>An AWS or GCP cluster that uses manual mode might be configured to create and manage cloud credentials from outside of the cluster using the AWS Security Token Service (STS) or GCP Workload Identity. With this configuration, the CCO uses temporary credentials for different components.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#cco-mode-sts">Using manual mode with Amazon Web Services Security Token Service</a> or <a href="#cco-mode-gcp-workload-identity">Using manual mode with GCP Workload Identity</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="manually-maintained-credentials-upgrade_cco-mode-manual">Updating cloud provider resources with manually maintained credentials</h4>
<div class="paragraph">
<p>Before upgrading a cluster with manually maintained credentials, you must create any new credentials for the release image that you are upgrading to. You must also review the required permissions for existing credentials and accommodate any new permissions requirements in the new release for those components.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Extract and examine the <code>CredentialsRequest</code> custom resource for the new release.</p>
<div class="paragraph">
<p>The "Manually creating IAM" section of the installation content for your cloud provider explains how to obtain and use the credentials required for your cloud.</p>
</div>
</li>
<li>
<p>Update the manually maintained credentials on your cluster:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Create new secrets for any <code>CredentialsRequest</code> custom resources that are added by the new release image.</p>
</li>
<li>
<p>If the <code>CredentialsRequest</code> custom resources for any existing credentials that are stored in secrets have changed permissions requirements, update the permissions as required.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>If your cluster uses cluster capabilities to disable one or more optional components, delete the <code>CredentialsRequest</code> custom resources for any disabled components.</p>
<div class="listingblock">
<div class="title">Example <code>credrequests</code> directory contents for OpenShift Container Platform 4.12 on AWS</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">0000_30_machine-api-operator_00_credentials-request.yaml <b class="conum">(1)</b>
0000_50_cloud-credential-operator_05-iam-ro-credentialsrequest.yaml <b class="conum">(2)</b>
0000_50_cluster-image-registry-operator_01-registry-credentials-request.yaml <b class="conum">(3)</b>
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml <b class="conum">(4)</b>
0000_50_cluster-network-operator_02-cncc-credentials.yaml <b class="conum">(5)</b>
0000_50_cluster-storage-operator_03_credentials_request_aws.yaml <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="colist arabic">
<ol>
<li>
<p>The Machine API Operator CR is required.</p>
</li>
<li>
<p>The Cloud Credential Operator CR is required.</p>
</li>
<li>
<p>The Image Registry Operator CR is required.</p>
</li>
<li>
<p>The Ingress Operator CR is required.</p>
</li>
<li>
<p>The Network Operator CR is required.</p>
</li>
<li>
<p>The Storage Operator CR is an optional component and might be disabled in your cluster.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>credrequests</code> directory contents for OpenShift Container Platform 4.12 on GCP</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">0000_26_cloud-controller-manager-operator_16_credentialsrequest-gcp.yaml <b class="conum">(1)</b>
0000_30_machine-api-operator_00_credentials-request.yaml <b class="conum">(2)</b>
0000_50_cloud-credential-operator_05-gcp-ro-credentialsrequest.yaml <b class="conum">(3)</b>
0000_50_cluster-image-registry-operator_01-registry-credentials-request-gcs.yaml <b class="conum">(4)</b>
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml <b class="conum">(5)</b>
0000_50_cluster-network-operator_02-cncc-credentials.yaml <b class="conum">(6)</b>
0000_50_cluster-storage-operator_03_credentials_request_gcp.yaml <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="colist arabic">
<ol>
<li>
<p>The Cloud Controller Manager Operator CR is required.</p>
</li>
<li>
<p>The Machine API Operator CR is required.</p>
</li>
<li>
<p>The Cloud Credential Operator CR is required.</p>
</li>
<li>
<p>The Image Registry Operator CR is required.</p>
</li>
<li>
<p>The Ingress Operator CR is required.</p>
</li>
<li>
<p>The Network Operator CR is required.</p>
</li>
<li>
<p>The Storage Operator CR is an optional component and might be disabled in your cluster.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Next steps</div>
<ul>
<li>
<p>Update the <code>upgradeable-to</code> annotation to indicate that the cluster is ready to upgrade.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="cco-manual-upgrade-annotation_cco-mode-manual">Indicating that the cluster is ready to upgrade</h5>
<div class="paragraph">
<p>The Cloud Credential Operator (CCO) <code>Upgradable</code> status for a cluster with manually maintained credentials is <code>False</code> by default.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>For the release image that you are upgrading to, you have processed any new credentials manually or by using the Cloud Credential Operator utility (<code>ccoctl</code>).</p>
</li>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to <code>oc</code> on the cluster as a user with the <code>cluster-admin</code> role.</p>
</li>
<li>
<p>Edit the <code>CloudCredential</code> resource to add an <code>upgradeable-to</code> annotation within the <code>metadata</code> field by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc edit cloudcredential cluster</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Text to add</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
  metadata:
    annotations:
      cloudcredential.openshift.io/upgradeable-to: &lt;version_number&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>&lt;version_number&gt;</code> is the version that you are upgrading to, in the format <code>x.y.z</code>. For example, use <code>4.12.2</code> for OpenShift Container Platform 4.12.2.</p>
</div>
<div class="paragraph">
<p>It may take several minutes after adding the annotation for the upgradeable status to change.</p>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Verification</div>
<ol class="arabic">
<li>
<p>In the <strong>Administrator</strong> perspective of the web console, navigate to <strong>Administration</strong> &#8594; <strong>Cluster Settings</strong>.</p>
</li>
<li>
<p>To view the CCO status details, click <strong>cloud-credential</strong> in the <strong>Cluster Operators</strong> list.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>If the <strong>Upgradeable</strong> status in the <strong>Conditions</strong> section is <strong>False</strong>, verify that the <code>upgradeable-to</code> annotation is free of typographical errors.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>When the <strong>Upgradeable</strong> status in the <strong>Conditions</strong> section is <strong>True</strong>, begin the OpenShift Container Platform upgrade.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="additional-resources_cco-mode-manual">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-alibaba-ram">Manually creating RAM resources for Alibaba Cloud</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-aws">Manually creating IAM for AWS</a></p>
</li>
<li>
<p><a href="#cco-mode-sts">Using manual mode with Amazon Web Services Security Token Service</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-azure">Manually creating IAM for Azure</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-creating-iam-gcp">Manually creating IAM for GCP</a></p>
</li>
<li>
<p><a href="#cco-mode-gcp-workload-identity">Using manual mode with GCP Workload Identity</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#configuring-iam-ibm-cloud">Configuring IAM for IBM Cloud</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/installing/#manually-create-iam-nutanix_installing-nutanix-installer-provisioned">Configuring IAM for Nutanix</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cco-mode-sts">Using manual mode with Amazon Web Services Security Token Service</h3>
<div class="paragraph">
<p>Manual mode with STS is supported for Amazon Web Services (AWS).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This credentials strategy is supported for only new OpenShift Container Platform clusters and must be configured during installation. You cannot reconfigure an existing cluster that uses a different credentials strategy to use this feature.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sts-mode-about_cco-mode-sts">About manual mode with AWS Security Token Service</h4>
<div class="paragraph">
<p>In manual mode with STS, the individual OpenShift Container Platform cluster components use AWS Security Token Service (STS) to assign components IAM roles that provide short-term, limited-privilege security credentials. These credentials are associated with IAM roles that are specific to each component that makes AWS API calls.</p>
</div>
<div class="paragraph">
<p>Requests for new and refreshed credentials are automated by using an appropriately configured AWS IAM OpenID Connect (OIDC) identity provider, combined with AWS IAM roles. OpenShift Container Platform signs service account tokens that are trusted by AWS IAM, and can be projected into a pod and used for authentication. Tokens are refreshed after one hour.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/142_OpenShift_credentials_STS_0221.png" alt="Detailed authentication flow between AWS and the cluster when using AWS STS">
</div>
<div class="title">Figure 2. STS authentication flow</div>
</div>
<div class="paragraph">
<p>Using manual mode with STS changes the content of the AWS credentials that are provided to individual OpenShift Container Platform components.</p>
</div>
<div class="listingblock">
<div class="title">AWS secret format using long-lived credentials</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: &lt;target-namespace&gt; <b class="conum">(1)</b>
  name: &lt;target-secret-name&gt; <b class="conum">(2)</b>
data:
  aws_access_key_id: &lt;base64-encoded-access-key-id&gt;
  aws_secret_access_key: &lt;base64-encoded-secret-access-key&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The namespace for the component.</p>
</li>
<li>
<p>The name of the component secret.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">AWS secret format with STS</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: &lt;target-namespace&gt; <b class="conum">(1)</b>
  name: &lt;target-secret-name&gt; <b class="conum">(2)</b>
stringData:
  credentials: |-
    [default]
    sts_regional_endpoints = regional
    role_name: &lt;operator-role-name&gt; <b class="conum">(3)</b>
    web_identity_token_file: &lt;path-to-token&gt; <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The namespace for the component.</p>
</li>
<li>
<p>The name of the component secret.</p>
</li>
<li>
<p>The IAM role for the component.</p>
</li>
<li>
<p>The path to the service account token inside the pod. By convention, this is <code>/var/run/secrets/openshift/serviceaccount/token</code> for OpenShift Container Platform components.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="sts-mode-installing_cco-mode-sts">Installing an OpenShift Container Platform cluster configured for manual mode with STS</h4>
<div class="paragraph">
<p>To install a cluster that is configured to use the Cloud Credential Operator (CCO) in manual mode with STS:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#cco-ccoctl-configuring_cco-mode-sts">Configure the Cloud Credential Operator utility</a>.</p>
</li>
<li>
<p>Create the required AWS resources <a href="#cco-ccoctl-creating-individually_cco-mode-sts">individually</a>, or <a href="#cco-ccoctl-creating-at-once_cco-mode-sts">with a single command</a>.</p>
</li>
<li>
<p><a href="#sts-mode-installing-manual-run-installer_cco-mode-sts">Run the OpenShift Container Platform installer</a>.</p>
</li>
<li>
<p><a href="#sts-mode-installing-verifying_cco-mode-sts">Verify that the cluster is using short-lived credentials</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Because the cluster is operating in manual mode when using STS, it is not able to create new credentials for components with the permissions that they require. When upgrading to a different minor version of OpenShift Container Platform, there are often new AWS permission requirements. Before upgrading a cluster that is using STS, the cluster administrator must manually ensure that the AWS permissions are sufficient for existing components and available to any new components.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/updating_clusters/#cco-ccoctl-configuring_preparing-manual-creds-update">Configuring the Cloud Credential Operator utility for a cluster update</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="cco-ccoctl-configuring_cco-mode-sts">Configuring the Cloud Credential Operator utility</h5>
<div class="paragraph">
<p>To create and manage cloud credentials from outside of the cluster when the Cloud Credential Operator (CCO) is operating in manual mode, extract and prepare the CCO utility (<code>ccoctl</code>) binary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ccoctl</code> utility is a Linux binary that must run in a Linux environment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to an OpenShift Container Platform account with cluster administrator access.</p>
</li>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>You have created an AWS account for the <code>ccoctl</code> utility to use with the following permissions:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Required AWS permissions</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Permission type</th>
<th class="tableblock halign-left valign-top">Required permissions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>iam</code> permissions</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>iam:CreateOpenIDConnectProvider</code></p>
</li>
<li>
<p><code>iam:CreateRole</code></p>
</li>
<li>
<p><code>iam:DeleteOpenIDConnectProvider</code></p>
</li>
<li>
<p><code>iam:DeleteRole</code></p>
</li>
<li>
<p><code>iam:DeleteRolePolicy</code></p>
</li>
<li>
<p><code>iam:GetOpenIDConnectProvider</code></p>
</li>
<li>
<p><code>iam:GetRole</code></p>
</li>
<li>
<p><code>iam:GetUser</code></p>
</li>
<li>
<p><code>iam:ListOpenIDConnectProviders</code></p>
</li>
<li>
<p><code>iam:ListRolePolicies</code></p>
</li>
<li>
<p><code>iam:ListRoles</code></p>
</li>
<li>
<p><code>iam:PutRolePolicy</code></p>
</li>
<li>
<p><code>iam:TagOpenIDConnectProvider</code></p>
</li>
<li>
<p><code>iam:TagRole</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>s3</code> permissions</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>s3:CreateBucket</code></p>
</li>
<li>
<p><code>s3:DeleteBucket</code></p>
</li>
<li>
<p><code>s3:DeleteObject</code></p>
</li>
<li>
<p><code>s3:GetBucketAcl</code></p>
</li>
<li>
<p><code>s3:GetBucketTagging</code></p>
</li>
<li>
<p><code>s3:GetObject</code></p>
</li>
<li>
<p><code>s3:GetObjectAcl</code></p>
</li>
<li>
<p><code>s3:GetObjectTagging</code></p>
</li>
<li>
<p><code>s3:ListBucket</code></p>
</li>
<li>
<p><code>s3:PutBucketAcl</code></p>
</li>
<li>
<p><code>s3:PutBucketPolicy</code></p>
</li>
<li>
<p><code>s3:PutBucketPublicAccessBlock</code></p>
</li>
<li>
<p><code>s3:PutBucketTagging</code></p>
</li>
<li>
<p><code>s3:PutObject</code></p>
</li>
<li>
<p><code>s3:PutObjectAcl</code></p>
</li>
<li>
<p><code>s3:PutObjectTagging</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>cloudfront</code> permissions</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>cloudfront:ListCloudFrontOriginAccessIdentities</code></p>
</li>
<li>
<p><code>cloudfront:ListDistributions</code></p>
</li>
<li>
<p><code>cloudfront:ListTagsForResource</code></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you plan to store the OIDC configuration in a private S3 bucket that is accessed by the IAM identity provider through a public CloudFront distribution URL, the AWS account that runs the <code>ccoctl</code> utility requires the following additional permissions:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>cloudfront:CreateCloudFrontOriginAccessIdentity</code></p>
</li>
<li>
<p><code>cloudfront:CreateDistribution</code></p>
</li>
<li>
<p><code>cloudfront:DeleteCloudFrontOriginAccessIdentity</code></p>
</li>
<li>
<p><code>cloudfront:DeleteDistribution</code></p>
</li>
<li>
<p><code>cloudfront:GetCloudFrontOriginAccessIdentity</code></p>
</li>
<li>
<p><code>cloudfront:GetCloudFrontOriginAccessIdentityConfig</code></p>
</li>
<li>
<p><code>cloudfront:GetDistribution</code></p>
</li>
<li>
<p><code>cloudfront:TagResource</code></p>
</li>
<li>
<p><code>cloudfront:UpdateDistribution</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>These additional permissions support the use of the <code>--create-private-s3-bucket</code> option when processing credentials requests with the <code>ccoctl aws create-all</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ RELEASE_IMAGE=$(./openshift-install version | awk '/release image/ {print $3}')</code></pre>
</div>
</div>
</li>
<li>
<p>Obtain the CCO container image from the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ CCO_IMAGE=$(oc adm release info --image-for='cloud-credential-operator' $RELEASE_IMAGE -a ~/.pull-secret)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that the architecture of the <code>$RELEASE_IMAGE</code> matches the architecture of the environment in which you will use the <code>ccoctl</code> tool.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Extract the <code>ccoctl</code> binary from the CCO container image within the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc image extract $CCO_IMAGE --file="/usr/bin/ccoctl" -a ~/.pull-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Change the permissions to make <code>ccoctl</code> executable by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ chmod 775 ccoctl</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify that <code>ccoctl</code> is ready to use, display the help file by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl --help</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output of <code>ccoctl --help</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">OpenShift credentials provisioning tool

Usage:
  ccoctl [command]

Available Commands:
  alibabacloud Manage credentials objects for alibaba cloud
  aws          Manage credentials objects for AWS cloud
  gcp          Manage credentials objects for Google cloud
  help         Help about any command
  ibmcloud     Manage credentials objects for IBM Cloud
  nutanix      Manage credentials objects for Nutanix

Flags:
  -h, --help   help for ccoctl

Use "ccoctl [command] --help" for more information about a command.</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sts-mode-create-aws-resources-ccoctl_cco-mode-sts">Creating AWS resources with the Cloud Credential Operator utility</h5>
<div class="paragraph">
<p>You can use the CCO utility (<code>ccoctl</code>) to create the required AWS resources <a href="#cco-ccoctl-creating-individually_cco-mode-sts">individually</a>, or <a href="#cco-ccoctl-creating-at-once_cco-mode-sts">with a single command</a>.</p>
</div>
<div class="sect5">
<h6 id="cco-ccoctl-creating-individually_cco-mode-sts">Creating AWS resources individually</h6>
<div class="paragraph">
<p>If you need to review the JSON files that the <code>ccoctl</code> tool creates before modifying AWS resources, or if the process the <code>ccoctl</code> tool uses to create AWS resources automatically does not meet the requirements of your organization, you can create the AWS resources individually. For example, this option might be useful for an organization that shares the responsibility for creating these resources among different users or departments.</p>
</div>
<div class="paragraph">
<p>Otherwise, you can use the <code>ccoctl aws create-all</code> command to create the AWS resources automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, <code>ccoctl</code> creates objects in the directory in which the commands are run. To create the objects in a different directory, use the <code>--output-dir</code> flag. This procedure uses <code>&lt;path_to_ccoctl_output_dir&gt;</code> to refer to this directory.</p>
</div>
<div class="paragraph">
<p>Some <code>ccoctl</code> commands make AWS API calls to create or modify AWS resources. You can use the <code>--dry-run</code> flag to avoid making API calls. Using this flag creates JSON files on the local file system instead. You can review and modify the JSON files and then apply them with the AWS CLI tool using the <code>--cli-input-json</code> parameters.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Extract and prepare the <code>ccoctl</code> binary.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Generate the public and private RSA key files that are used to set up the OpenID Connect provider for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl aws create-key-pair</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">2021/04/13 11:01:02 Generating RSA keypair
2021/04/13 11:01:03 Writing private key to /&lt;path_to_ccoctl_output_dir&gt;/serviceaccount-signer.private
2021/04/13 11:01:03 Writing public key to /&lt;path_to_ccoctl_output_dir&gt;/serviceaccount-signer.public
2021/04/13 11:01:03 Copying signing key for use by installer</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>serviceaccount-signer.private</code> and <code>serviceaccount-signer.public</code> are the generated key files.</p>
</div>
<div class="paragraph">
<p>This command also creates a private key that the cluster requires during installation in <code>/&lt;path_to_ccoctl_output_dir&gt;/tls/bound-service-account-signing-key.key</code>.</p>
</div>
</li>
<li>
<p>Create an OpenID Connect identity provider and S3 bucket on AWS:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl aws create-identity-provider \
--name=&lt;name&gt; \
--region=&lt;aws_region&gt; \
--public-key-file=&lt;path_to_ccoctl_output_dir&gt;/serviceaccount-signer.public</code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>&lt;name&gt;</code> is the name used to tag any cloud resources that are created for tracking.</p>
</li>
<li>
<p><code>&lt;aws-region&gt;</code> is the AWS region in which cloud resources will be created.</p>
</li>
<li>
<p><code>&lt;path_to_ccoctl_output_dir&gt;</code> is the path to the public key file that the <code>ccoctl aws create-key-pair</code> command generated.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">2021/04/13 11:16:09 Bucket &lt;name&gt;-oidc created
2021/04/13 11:16:10 OpenID Connect discovery document in the S3 bucket &lt;name&gt;-oidc at .well-known/openid-configuration updated
2021/04/13 11:16:10 Reading public key
2021/04/13 11:16:10 JSON web key set (JWKS) in the S3 bucket &lt;name&gt;-oidc at keys.json updated
2021/04/13 11:16:18 Identity Provider created with ARN: arn:aws:iam::&lt;aws_account_id&gt;:oidc-provider/&lt;name&gt;-oidc.s3.&lt;aws_region&gt;.amazonaws.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>openid-configuration</code> is a discovery document and <code>keys.json</code> is a JSON web key set file.</p>
</div>
<div class="paragraph">
<p>This command also creates a YAML configuration file in <code>/&lt;path_to_ccoctl_output_dir&gt;/manifests/cluster-authentication-02-config.yaml</code>. This file sets the issuer URL field for the service account tokens that the cluster generates, so that the AWS IAM identity provider trusts the tokens.</p>
</div>
</li>
<li>
<p>Create IAM roles for each component in the cluster.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract the list of <code>CredentialsRequest</code> objects from the OpenShift Container Platform release image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm release extract --credentials-requests \
--cloud=aws \
--to=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests <b class="conum">(1)</b>
--from=quay.io/&lt;path_to&gt;/ocp-release:&lt;version&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>credrequests</code> is the directory where the list of <code>CredentialsRequest</code> objects is stored. This command creates the directory if it does not exist.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If your cluster uses cluster capabilities to disable one or more optional components, delete the <code>CredentialsRequest</code> custom resources for any disabled components.</p>
<div class="listingblock">
<div class="title">Example <code>credrequests</code> directory contents for OpenShift Container Platform 4.12 on AWS</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">0000_30_machine-api-operator_00_credentials-request.yaml <b class="conum">(1)</b>
0000_50_cloud-credential-operator_05-iam-ro-credentialsrequest.yaml <b class="conum">(2)</b>
0000_50_cluster-image-registry-operator_01-registry-credentials-request.yaml <b class="conum">(3)</b>
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml <b class="conum">(4)</b>
0000_50_cluster-network-operator_02-cncc-credentials.yaml <b class="conum">(5)</b>
0000_50_cluster-storage-operator_03_credentials_request_aws.yaml <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Machine API Operator CR is required.</p>
</li>
<li>
<p>The Cloud Credential Operator CR is required.</p>
</li>
<li>
<p>The Image Registry Operator CR is required.</p>
</li>
<li>
<p>The Ingress Operator CR is required.</p>
</li>
<li>
<p>The Network Operator CR is required.</p>
</li>
<li>
<p>The Storage Operator CR is an optional component and might be disabled in your cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Use the <code>ccoctl</code> tool to process all <code>CredentialsRequest</code> objects in the <code>credrequests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl aws create-iam-roles \
--name=&lt;name&gt; \
--region=&lt;aws_region&gt; \
--credentials-requests-dir=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests \
--identity-provider-arn=arn:aws:iam::&lt;aws_account_id&gt;:oidc-provider/&lt;name&gt;-oidc.s3.&lt;aws_region&gt;.amazonaws.com</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For AWS environments that use alternative IAM API endpoints, such as GovCloud, you must also specify your region with the <code>--region</code> parameter.</p>
</div>
<div class="paragraph">
<p>If your cluster uses Technology Preview features that are enabled by the <code>TechPreviewNoUpgrade</code> feature set, you must include the <code>--enable-tech-preview</code> parameter.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For each <code>CredentialsRequest</code> object, <code>ccoctl</code> creates an IAM role with a trust policy that is tied to the specified OIDC identity provider, and a permissions policy as defined in each <code>CredentialsRequest</code> object from the OpenShift Container Platform release image.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify that the OpenShift Container Platform secrets are created, list the files in the <code>&lt;path_to_ccoctl_output_dir&gt;/manifests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ll &lt;path_to_ccoctl_output_dir&gt;/manifests</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">total 24
-rw-------. 1 &lt;user&gt; &lt;user&gt; 161 Apr 13 11:42 cluster-authentication-02-config.yaml
-rw-------. 1 &lt;user&gt; &lt;user&gt; 379 Apr 13 11:59 openshift-cloud-credential-operator-cloud-credential-operator-iam-ro-creds-credentials.yaml
-rw-------. 1 &lt;user&gt; &lt;user&gt; 353 Apr 13 11:59 openshift-cluster-csi-drivers-ebs-cloud-credentials-credentials.yaml
-rw-------. 1 &lt;user&gt; &lt;user&gt; 355 Apr 13 11:59 openshift-image-registry-installer-cloud-credentials-credentials.yaml
-rw-------. 1 &lt;user&gt; &lt;user&gt; 339 Apr 13 11:59 openshift-ingress-operator-cloud-credentials-credentials.yaml
-rw-------. 1 &lt;user&gt; &lt;user&gt; 337 Apr 13 11:59 openshift-machine-api-aws-cloud-credentials-credentials.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can verify that the IAM roles are created by querying AWS. For more information, refer to AWS documentation on listing IAM roles.</p>
</div>
</div>
<div class="sect5">
<h6 id="cco-ccoctl-creating-at-once_cco-mode-sts">Creating AWS resources with a single command</h6>
<div class="paragraph">
<p>If you do not need to review the JSON files that the <code>ccoctl</code> tool creates before modifying AWS resources, and if the process the <code>ccoctl</code> tool uses to create AWS resources automatically meets the requirements of your organization, you can use the <code>ccoctl aws create-all</code> command to automate the creation of AWS resources.</p>
</div>
<div class="paragraph">
<p>Otherwise, you can create the AWS resources individually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, <code>ccoctl</code> creates objects in the directory in which the commands are run. To create the objects in a different directory, use the <code>--output-dir</code> flag. This procedure uses <code>&lt;path_to_ccoctl_output_dir&gt;</code> to refer to this directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>You must have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extracted and prepared the <code>ccoctl</code> binary.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Extract the list of <code>CredentialsRequest</code> objects from the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm release extract \
--credentials-requests \
--cloud=aws \
--to=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests \ <b class="conum">(1)</b>
--from=quay.io/&lt;path_to&gt;/ocp-release:&lt;version&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>credrequests</code> is the directory where the list of <code>CredentialsRequest</code> objects is stored. This command creates the directory if it does not exist.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This command can take a few moments to run.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If your cluster uses cluster capabilities to disable one or more optional components, delete the <code>CredentialsRequest</code> custom resources for any disabled components.</p>
<div class="listingblock">
<div class="title">Example <code>credrequests</code> directory contents for OpenShift Container Platform 4.12 on AWS</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">0000_30_machine-api-operator_00_credentials-request.yaml <b class="conum">(1)</b>
0000_50_cloud-credential-operator_05-iam-ro-credentialsrequest.yaml <b class="conum">(2)</b>
0000_50_cluster-image-registry-operator_01-registry-credentials-request.yaml <b class="conum">(3)</b>
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml <b class="conum">(4)</b>
0000_50_cluster-network-operator_02-cncc-credentials.yaml <b class="conum">(5)</b>
0000_50_cluster-storage-operator_03_credentials_request_aws.yaml <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Machine API Operator CR is required.</p>
</li>
<li>
<p>The Cloud Credential Operator CR is required.</p>
</li>
<li>
<p>The Image Registry Operator CR is required.</p>
</li>
<li>
<p>The Ingress Operator CR is required.</p>
</li>
<li>
<p>The Network Operator CR is required.</p>
</li>
<li>
<p>The Storage Operator CR is an optional component and might be disabled in your cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Use the <code>ccoctl</code> tool to process all <code>CredentialsRequest</code> objects in the <code>credrequests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl aws create-all \
  --name=&lt;name&gt; \// <b class="conum">(1)</b>
  --region=&lt;aws_region&gt; \// <b class="conum">(2)</b>
  --credentials-requests-dir=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests \// <b class="conum">(3)</b>
  --output-dir=&lt;path_to_ccoctl_output_dir&gt; \// <b class="conum">(4)</b>
  --create-private-s3-bucket <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify the name used to tag any cloud resources that are created for tracking.</p>
</li>
<li>
<p>Specify the AWS region in which cloud resources will be created.</p>
</li>
<li>
<p>Specify the directory containing the files for the component <code>CredentialsRequest</code> objects.</p>
</li>
<li>
<p>Optional: Specify the directory in which you want the <code>ccoctl</code> utility to create objects. By default, the utility creates objects in the directory in which the commands are run.</p>
</li>
<li>
<p>Optional: By default, the <code>ccoctl</code> utility stores the OpenID Connect (OIDC) configuration files in a public S3 bucket and uses the S3 URL as the public OIDC endpoint. To store the OIDC configuration in a private S3 bucket that is accessed by the IAM identity provider through a public CloudFront distribution URL instead, use the <code>--create-private-s3-bucket</code> parameter.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If your cluster uses Technology Preview features that are enabled by the <code>TechPreviewNoUpgrade</code> feature set, you must include the <code>--enable-tech-preview</code> parameter.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify that the OpenShift Container Platform secrets are created, list the files in the <code>&lt;path_to_ccoctl_output_dir&gt;/manifests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ls &lt;path_to_ccoctl_output_dir&gt;/manifests</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">cluster-authentication-02-config.yaml
openshift-cloud-credential-operator-cloud-credential-operator-iam-ro-creds-credentials.yaml
openshift-cluster-csi-drivers-ebs-cloud-credentials-credentials.yaml
openshift-image-registry-installer-cloud-credentials-credentials.yaml
openshift-ingress-operator-cloud-credentials-credentials.yaml
openshift-machine-api-aws-cloud-credentials-credentials.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can verify that the IAM roles are created by querying AWS. For more information, refer to AWS documentation on listing IAM roles.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sts-mode-installing-manual-run-installer_cco-mode-sts">Running the installer</h5>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure an account with the cloud platform that hosts your cluster.</p>
</li>
<li>
<p>Obtain the OpenShift Container Platform release image.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Change to the directory that contains the installation program and create the <code>install-config.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ openshift-install create install-config --dir &lt;installation_directory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;installation_directory&gt;</code> is the directory in which the installation program creates files.</p>
</div>
</li>
<li>
<p>Edit the <code>install-config.yaml</code> configuration file so that it contains the <code>credentialsMode</code> parameter set to <code>Manual</code>.</p>
<div class="listingblock">
<div class="title">Example <code>install-config.yaml</code> configuration file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
baseDomain: cluster1.example.com
credentialsMode: Manual <b class="conum">(1)</b>
compute:
- architecture: amd64
  hyperthreading: Enabled</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This line is added to set the <code>credentialsMode</code> parameter to <code>Manual</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the required OpenShift Container Platform installation manifests:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ openshift-install create manifests</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the manifests that <code>ccoctl</code> generated to the manifests directory that the installation program created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ cp /&lt;path_to_ccoctl_output_dir&gt;/manifests/* ./manifests/</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the private key that the <code>ccoctl</code> generated in the <code>tls</code> directory to the installation directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ cp -a /&lt;path_to_ccoctl_output_dir&gt;/tls .</code></pre>
</div>
</div>
</li>
<li>
<p>Run the OpenShift Container Platform installer:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ./openshift-install create cluster</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="sts-mode-installing-verifying_cco-mode-sts">Verifying the installation</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect to the OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Verify that the cluster does not have <code>root</code> credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secrets -n kube-system aws-creds</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Error from server (NotFound): secrets "aws-creds" not found</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the components are assuming the
IAM roles
that are specified in the secret manifests, instead of using credentials that are created by the CCO:</p>
<div class="listingblock">
<div class="title">Example command with the Image Registry Operator</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secrets -n openshift-image-registry installer-cloud-credentials -o json | jq -r .data.credentials | base64 --decode</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should show the role and web identity token that are used by the component and look similar to:</p>
</div>
<div class="listingblock">
<div class="title">Example output with the Image Registry Operator</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">[default]
role_arn = arn:aws:iam::123456789:role/openshift-image-registry-installer-cloud-credentials
web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="additional-resources_cco-mode-sts">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/updating_clusters/#preparing-manual-creds-update">Preparing to update a cluster with manually maintained credentials</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cco-mode-gcp-workload-identity">Using manual mode with GCP Workload Identity</h3>
<div class="paragraph">
<p>Manual mode with GCP Workload Identity is supported for Google Cloud Platform (GCP).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This credentials strategy is supported for only new OpenShift Container Platform clusters and must be configured during installation. You cannot reconfigure an existing cluster that uses a different credentials strategy to use this feature.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In manual mode with GCP Workload Identity, the individual OpenShift Container Platform cluster components can impersonate IAM service accounts using short-term, limited-privilege credentials.</p>
</div>
<div class="paragraph">
<p>Requests for new and refreshed credentials are automated by using an appropriately configured OpenID Connect (OIDC) identity provider, combined with IAM service accounts. OpenShift Container Platform signs service account tokens that are trusted by GCP, and can be projected into a pod and used for authentication. Tokens are refreshed after one hour by default.</p>
</div>
<div class="paragraph">
<p>Using manual mode with GCP Workload Identity changes the content of the GCP credentials that are provided to individual OpenShift Container Platform components.</p>
</div>
<div class="listingblock">
<div class="title">GCP secret format</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  namespace: &lt;target_namespace&gt; <b class="conum">(1)</b>
  name: &lt;target_secret_name&gt; <b class="conum">(2)</b>
data:
  service_account.json: &lt;service_account&gt; <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The namespace for the component.</p>
</li>
<li>
<p>The name of the component secret.</p>
</li>
<li>
<p>The Base64 encoded service account.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Content of the Base64 encoded <code>service_account.json</code> file using long-lived credentials</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
   "type": "service_account", <b class="conum">(1)</b>
   "project_id": "&lt;project_id&gt;",
   "private_key_id": "&lt;private_key_id&gt;",
   "private_key": "&lt;private_key&gt;", <b class="conum">(2)</b>
   "client_email": "&lt;client_email_address&gt;",
   "client_id": "&lt;client_id&gt;",
   "auth_uri": "https://accounts.google.com/o/oauth2/auth",
   "token_uri": "https://oauth2.googleapis.com/token",
   "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
   "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/&lt;client_email_address&gt;"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The credential type is <code>service_account</code>.</p>
</li>
<li>
<p>The private RSA key that is used to authenticate to GCP. This key must be kept secure and is not rotated.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Content of the Base64 encoded <code>service_account.json</code> file using GCP Workload Identity</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
   "type": "external_account", <b class="conum">(1)</b>
   "audience": "//iam.googleapis.com/projects/123456789/locations/global/workloadIdentityPools/test-pool/providers/test-provider", <b class="conum">(2)</b>
   "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
   "token_url": "https://sts.googleapis.com/v1/token",
   "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;client_email_address&gt;:generateAccessToken", <b class="conum">(3)</b>
   "credential_source": {
      "file": "&lt;path_to_token&gt;", <b class="conum">(4)</b>
      "format": {
         "type": "text"
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The credential type is <code>external_account</code>.</p>
</li>
<li>
<p>The target audience is the GCP Workload Identity provider.</p>
</li>
<li>
<p>The resource URL of the service account that can be impersonated with these credentials.</p>
</li>
<li>
<p>The path to the service account token inside the pod. By convention, this is <code>/var/run/secrets/openshift/serviceaccount/token</code> for OpenShift Container Platform components.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="gcp-workload-identity-mode-installing">Installing an OpenShift Container Platform cluster configured for manual mode with GCP Workload Identity</h4>
<div class="paragraph">
<p>To install a cluster that is configured to use the Cloud Credential Operator (CCO) in manual mode with GCP Workload Identity:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#cco-ccoctl-configuring_cco-mode-gcp-workload-identity">Configure the Cloud Credential Operator utility</a>.</p>
</li>
<li>
<p><a href="#cco-ccoctl-creating-at-once_cco-mode-gcp-workload-identity">Create the required GCP resources</a>.</p>
</li>
<li>
<p><a href="#sts-mode-installing-manual-run-installer_cco-mode-gcp-workload-identity">Run the OpenShift Container Platform installer</a>.</p>
</li>
<li>
<p><a href="#sts-mode-installing-verifying_cco-mode-gcp-workload-identity">Verify that the cluster is using short-lived credentials</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Because the cluster is operating in manual mode when using GCP Workload Identity, it is not able to create new credentials for components with the permissions that they require. When upgrading to a different minor version of OpenShift Container Platform, there are often new GCP permission requirements. Before upgrading a cluster that is using GCP Workload Identity, the cluster administrator must manually ensure that the GCP permissions are sufficient for existing components and available to any new components.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/updating_clusters/#cco-ccoctl-configuring_preparing-manual-creds-update">Configuring the Cloud Credential Operator utility for a cluster update</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="cco-ccoctl-configuring_cco-mode-gcp-workload-identity">Configuring the Cloud Credential Operator utility</h5>
<div class="paragraph">
<p>To create and manage cloud credentials from outside of the cluster when the Cloud Credential Operator (CCO) is operating in manual mode, extract and prepare the CCO utility (<code>ccoctl</code>) binary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ccoctl</code> utility is a Linux binary that must run in a Linux environment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have access to an OpenShift Container Platform account with cluster administrator access.</p>
</li>
<li>
<p>You have installed the OpenShift CLI (<code>oc</code>).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ RELEASE_IMAGE=$(./openshift-install version | awk '/release image/ {print $3}')</code></pre>
</div>
</div>
</li>
<li>
<p>Obtain the CCO container image from the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ CCO_IMAGE=$(oc adm release info --image-for='cloud-credential-operator' $RELEASE_IMAGE -a ~/.pull-secret)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that the architecture of the <code>$RELEASE_IMAGE</code> matches the architecture of the environment in which you will use the <code>ccoctl</code> tool.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Extract the <code>ccoctl</code> binary from the CCO container image within the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc image extract $CCO_IMAGE --file="/usr/bin/ccoctl" -a ~/.pull-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Change the permissions to make <code>ccoctl</code> executable by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ chmod 775 ccoctl</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify that <code>ccoctl</code> is ready to use, display the help file by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl --help</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output of <code>ccoctl --help</code></div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">OpenShift credentials provisioning tool

Usage:
  ccoctl [command]

Available Commands:
  alibabacloud Manage credentials objects for alibaba cloud
  aws          Manage credentials objects for AWS cloud
  gcp          Manage credentials objects for Google cloud
  help         Help about any command
  ibmcloud     Manage credentials objects for IBM Cloud
  nutanix      Manage credentials objects for Nutanix

Flags:
  -h, --help   help for ccoctl

Use "ccoctl [command] --help" for more information about a command.</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cco-ccoctl-creating-at-once_cco-mode-gcp-workload-identity">Creating GCP resources with the Cloud Credential Operator utility</h5>
<div class="paragraph">
<p>You can use the <code>ccoctl gcp create-all</code> command to automate the creation of GCP resources.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>By default, <code>ccoctl</code> creates objects in the directory in which the commands are run. To create the objects in a different directory, use the <code>--output-dir</code> flag. This procedure uses <code>&lt;path_to_ccoctl_output_dir&gt;</code> to refer to this directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>You must have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extracted and prepared the <code>ccoctl</code> binary.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Extract the list of <code>CredentialsRequest</code> objects from the OpenShift Container Platform release image by running the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc adm release extract \
--credentials-requests \
--cloud=gcp \
--to=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests \ <b class="conum">(1)</b>
quay.io/&lt;path_to&gt;/ocp-release:&lt;version&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>credrequests</code> is the directory where the list of <code>CredentialsRequest</code> objects is stored. This command creates the directory if it does not exist.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This command can take a few moments to run.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If your cluster uses cluster capabilities to disable one or more optional components, delete the <code>CredentialsRequest</code> custom resources for any disabled components.</p>
<div class="listingblock">
<div class="title">Example <code>credrequests</code> directory contents for OpenShift Container Platform 4.12 on GCP</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">0000_26_cloud-controller-manager-operator_16_credentialsrequest-gcp.yaml <b class="conum">(1)</b>
0000_30_machine-api-operator_00_credentials-request.yaml <b class="conum">(2)</b>
0000_50_cloud-credential-operator_05-gcp-ro-credentialsrequest.yaml <b class="conum">(3)</b>
0000_50_cluster-image-registry-operator_01-registry-credentials-request-gcs.yaml <b class="conum">(4)</b>
0000_50_cluster-ingress-operator_00-ingress-credentials-request.yaml <b class="conum">(5)</b>
0000_50_cluster-network-operator_02-cncc-credentials.yaml <b class="conum">(6)</b>
0000_50_cluster-storage-operator_03_credentials_request_gcp.yaml <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Cloud Controller Manager Operator CR is required.</p>
</li>
<li>
<p>The Machine API Operator CR is required.</p>
</li>
<li>
<p>The Cloud Credential Operator CR is required.</p>
</li>
<li>
<p>The Image Registry Operator CR is required.</p>
</li>
<li>
<p>The Ingress Operator CR is required.</p>
</li>
<li>
<p>The Network Operator CR is required.</p>
</li>
<li>
<p>The Storage Operator CR is an optional component and might be disabled in your cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Use the <code>ccoctl</code> tool to process all <code>CredentialsRequest</code> objects in the <code>credrequests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ccoctl gcp create-all \
--name=&lt;name&gt; \
--region=&lt;gcp_region&gt; \
--project=&lt;gcp_project_id&gt; \
--credentials-requests-dir=&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests</code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>&lt;name&gt;</code> is the user-defined name for all created GCP resources used for tracking.</p>
</li>
<li>
<p><code>&lt;gcp_region&gt;</code> is the GCP region in which cloud resources will be created.</p>
</li>
<li>
<p><code>&lt;gcp_project_id&gt;</code> is the GCP project ID in which cloud resources will be created.</p>
</li>
<li>
<p><code>&lt;path_to_directory_with_list_of_credentials_requests&gt;/credrequests</code> is the directory containing the files of <code>CredentialsRequest</code> manifests to create GCP service accounts.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If your cluster uses Technology Preview features that are enabled by the <code>TechPreviewNoUpgrade</code> feature set, you must include the <code>--enable-tech-preview</code> parameter.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Verification</div>
<ul>
<li>
<p>To verify that the OpenShift Container Platform secrets are created, list the files in the <code>&lt;path_to_ccoctl_output_dir&gt;/manifests</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ls &lt;path_to_ccoctl_output_dir&gt;/manifests</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can verify that the IAM service accounts are created by querying GCP. For more information, refer to GCP documentation on listing IAM service accounts.</p>
</div>
</div>
<div class="sect4">
<h5 id="sts-mode-installing-manual-run-installer_cco-mode-gcp-workload-identity">Running the installer</h5>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure an account with the cloud platform that hosts your cluster.</p>
</li>
<li>
<p>Obtain the OpenShift Container Platform release image.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Change to the directory that contains the installation program and create the <code>install-config.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ openshift-install create install-config --dir &lt;installation_directory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;installation_directory&gt;</code> is the directory in which the installation program creates files.</p>
</div>
</li>
<li>
<p>Edit the <code>install-config.yaml</code> configuration file so that it contains the <code>credentialsMode</code> parameter set to <code>Manual</code>.</p>
<div class="listingblock">
<div class="title">Example <code>install-config.yaml</code> configuration file</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
baseDomain: cluster1.example.com
credentialsMode: Manual <b class="conum">(1)</b>
compute:
- architecture: amd64
  hyperthreading: Enabled</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This line is added to set the <code>credentialsMode</code> parameter to <code>Manual</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the required OpenShift Container Platform installation manifests:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ openshift-install create manifests</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the manifests that <code>ccoctl</code> generated to the manifests directory that the installation program created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ cp /&lt;path_to_ccoctl_output_dir&gt;/manifests/* ./manifests/</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the private key that the <code>ccoctl</code> generated in the <code>tls</code> directory to the installation directory:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ cp -a /&lt;path_to_ccoctl_output_dir&gt;/tls .</code></pre>
</div>
</div>
</li>
<li>
<p>Run the OpenShift Container Platform installer:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ ./openshift-install create cluster</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="sts-mode-installing-verifying_cco-mode-gcp-workload-identity">Verifying the installation</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect to the OpenShift Container Platform cluster.</p>
</li>
<li>
<p>Verify that the cluster does not have <code>root</code> credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secrets -n kube-system gcp-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">Error from server (NotFound): secrets "gcp-credentials" not found</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the components are assuming the
service accounts
that are specified in the secret manifests, instead of using credentials that are created by the CCO:</p>
<div class="listingblock">
<div class="title">Example command with the Image Registry Operator</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-terminal" data-lang="terminal">$ oc get secrets -n openshift-image-registry installer-cloud-credentials -o json | jq -r '.data."service_account.json"' | base64 -d</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should show the role and web identity token that are used by the component and look similar to:</p>
</div>
<div class="listingblock">
<div class="title">Example output with the Image Registry Operator</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
   "type": "external_account", <b class="conum">(1)</b>
   "audience": "//iam.googleapis.com/projects/123456789/locations/global/workloadIdentityPools/test-pool/providers/test-provider",
   "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
   "token_url": "https://sts.googleapis.com/v1/token",
   "service_account_impersonation_url": "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;client-email-address&gt;:generateAccessToken", <b class="conum">(2)</b>
   "credential_source": {
      "file": "/var/run/secrets/openshift/serviceaccount/token",
      "format": {
         "type": "text"
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The credential type is <code>external_account</code>.</p>
</li>
<li>
<p>The resource URL of the service account used by the Image Registry Operator.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3 _additional-resources">
<h4 id="additional-resources_cco-mode-gcp-workload-identity">Additional resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.13/html-single/updating_clusters/#preparing-manual-creds-update">Preparing to update a cluster with manually maintained credentials</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-07-21 13:38:44 UTC
</div>
</div>
</body>
</html>